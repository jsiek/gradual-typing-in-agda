{-# OPTIONS --rewriting #-}
module LogRel.CastCompatibility where

open import Data.List using (List; []; _Рѕи_; length; map)
open import Data.Nat
open import Data.Bool using (true; false) renaming (Bool to ­Юћ╣)
open import Data.Nat.Properties
open import Data.Product using (_,_; _├Ќ_; projРѓЂ; projРѓѓ; ╬Б-syntax; РѕЃ-syntax)
open import Data.Unit using (Ріц; tt)
open import Data.Unit.Polymorphic renaming (Ріц to topрхќ; tt to ttрхќ)
open import Data.Empty using (РіЦ; РіЦ-elim)
open import Data.Sum using (_Ріј_; injРѓЂ; injРѓѓ)
open import Relation.Binary.PropositionalEquality as Eq
  using (_РЅА_; _РЅб_; refl; sym; cong; subst; trans)
open import Relation.Nullary using (┬г_; Dec; yes; no)
open import Var
open import LogRel.Cast
open import LogRel.CastReduction
open import LogRel.CastDeterministic
open import StepIndexedLogic
open import LogRel.CastLogRel
open import LogRel.CastBind

{---------------- Compatibility Lemmas ----------------------------------------}

compatible-nat : Рѕђ{╬Њ}{n : РёЋ}
   Рєњ ╬Њ Ріе $ (Num n) РіЉ $ (Num n) Рдѓ ($Рѓю Рђ▓РёЋ , $Рѓю Рђ▓РёЋ , baseРіЉ)
compatible-nat {╬Њ}{n} ╬│ ╬│Рђ▓ = ­Юњ▒РЄњРё░ (substрхњ (РЅАрхњ-sym ­Юњ▒-base) (constрхњI refl))

compatible-bool : Рѕђ{╬Њ}{b : ­Юћ╣}
   Рєњ ╬Њ Ріе $ (Bool b) РіЉ $ (Bool b) Рдѓ ($Рѓю Рђ▓­Юћ╣ , $Рѓю Рђ▓­Юћ╣ , baseРіЉ)
compatible-bool {╬Њ}{b} ╬│ ╬│Рђ▓ = ­Юњ▒РЄњРё░ (substрхњ (РЅАрхњ-sym ­Юњ▒-base) (constрхњI refl))

compatible-blame : Рѕђ{╬Њ}{A}{M}
   Рєњ map projРѓЂ ╬Њ Ріб M Рдѓ A
     -------------------------------
   Рєњ ╬Њ Ріе M РіЉ blame Рдѓ (A , A , ReflРіЉ)
compatible-blame РібM ╬│ ╬│Рђ▓ = Рё░-blame

lookup-­ЮЊќ : (╬Њ : List Prec) Рєњ (╬│ ╬│Рђ▓ : Subst)
  Рєњ Рѕђ {A}{AРђ▓}{AРіЉAРђ▓}{y} Рєњ ╬Њ РѕІ y Рдѓ (A , AРђ▓ , AРіЉAРђ▓)
  Рєњ ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓ Рібрхњ ­Юњ▒РЪд (A , AРђ▓ , AРіЉAРђ▓) РЪД (╬│ y) (╬│Рђ▓ y)
lookup-­ЮЊќ (.(A , AРђ▓ , AРіЉAРђ▓) Рѕи ╬Њ) ╬│ ╬│Рђ▓ {A} {AРђ▓} {AРіЉAРђ▓} {zero} refl = Zрхњ
lookup-­ЮЊќ (B Рѕи ╬Њ) ╬│ ╬│Рђ▓ {A} {AРђ▓} {AРіЉAРђ▓} {suc y} РѕІy =
   Sрхњ (lookup-­ЮЊќ ╬Њ (╬╗ x Рєњ ╬│ (suc x)) (╬╗ x Рєњ ╬│Рђ▓ (suc x)) РѕІy)

compatibility-var : Рѕђ {╬Њ A AРђ▓ AРіЉAРђ▓ x}
  Рєњ ╬Њ РѕІ x Рдѓ (A , AРђ▓ , AРіЉAРђ▓)
    -------------------------------
  Рєњ ╬Њ Ріе ` x РіЉ ` x Рдѓ (A , AРђ▓ , AРіЉAРђ▓)
compatibility-var {╬Њ}{A}{AРђ▓}{AРіЉAРђ▓}{x} РѕІx ╬│ ╬│Рђ▓
    rewrite sub-var ╬│ x | sub-var ╬│Рђ▓ x = ­Юњ▒РЄњРё░ (lookup-­ЮЊќ ╬Њ ╬│ ╬│Рђ▓ РѕІx)


compatible-lambda : Рѕђ{╬Њ : List Prec}{A}{B}{C}{D}{N NРђ▓ : Term}
     {c : A РіЉ C}{d : B РіЉ D}
   Рєњ ((A , C , c) Рѕи ╬Њ) Ріе N РіЉ NРђ▓ Рдѓ (B , D , d)
     ------------------------------------------------
   Рєњ ╬Њ Ріе (кЏ N) РіЉ (кЏ NРђ▓) Рдѓ (A РЄњ B , C РЄњ D , funРіЉ c d)
compatible-lambda{╬Њ}{A}{B}{C}{D}{N}{NРђ▓}{c}{d} РіеNРіЉNРђ▓ ╬│ ╬│Рђ▓ = РібРё░╬╗N╬╗NРђ▓
 where
 РібРё░╬╗N╬╗NРђ▓ : ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓ Рібрхњ Рё░РЪд A РЄњ B , C РЄњ D , funРіЉ c d РЪД (РЪф ╬│ РЪФ (кЏ N))
                                                         (РЪф ╬│Рђ▓ РЪФ (кЏ NРђ▓))
 РібРё░╬╗N╬╗NРђ▓ = ­Юњ▒РЄњРё░ (substрхњ (РЅАрхњ-sym ­Юњ▒-fun) (╬Џрхњ[ W ] ╬Џрхњ[ WРђ▓ ] РєњрхњI Рќи­ЮЊћN[W]NРђ▓[WРђ▓]))
  where
  Рќи­ЮЊћN[W]NРђ▓[WРђ▓] : Рѕђ{W WРђ▓} Рєњ Рќирхњ ­Юњ▒РЪд A , C , c РЪД W WРђ▓ Рѕи ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓
          Рібрхњ  Рќирхњ Рё░РЪд B , D , d РЪД ((РЪф ext ╬│ РЪФ N) [ W ]) ((РЪф ext ╬│Рђ▓ РЪФ NРђ▓) [ WРђ▓ ])
  Рќи­ЮЊћN[W]NРђ▓[WРђ▓] {W}{WРђ▓} =
      appрхњ (Sрхњ (РќиРєњ (monoрхњ (РєњрхњI (РіеNРіЉNРђ▓ (W Рђб ╬│) (WРђ▓ Рђб ╬│Рђ▓)))))) Zрхњ

compatible-app : Рѕђ{╬Њ}{A AРђ▓ B BРђ▓}{c : A РіЉ AРђ▓}{d : B РіЉ BРђ▓}{L LРђ▓ M MРђ▓}
   Рєњ ╬Њ Ріе L РіЉ LРђ▓ Рдѓ (A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ c d)
   Рєњ ╬Њ Ріе M РіЉ MРђ▓ Рдѓ (A , AРђ▓ , c)
     ----------------------------------
   Рєњ ╬Њ Ріе L ┬и M РіЉ LРђ▓ ┬и MРђ▓ Рдѓ (B , BРђ▓ , d)
compatible-app {╬Њ}{A}{AРђ▓}{B}{BРђ▓}{c}{d}{L}{LРђ▓}{M}{MРђ▓} РіеLРіЉLРђ▓ РіеMРіЉMРђ▓ ╬│ ╬│Рђ▓ =
 РібРё░LMРіЉLMРђ▓
 where
 РібРё░LMРіЉLMРђ▓ : ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓ Рібрхњ Рё░РЪд B , BРђ▓ , d РЪД (РЪф ╬│ РЪФ (L ┬и M)) (РЪф ╬│Рђ▓ РЪФ (LРђ▓ ┬и MРђ▓))
 РібРё░LMРіЉLMРђ▓ = Рё░-bind {F = ` (РќА┬и (РЪф ╬│ РЪФ M))}{` (РќА┬и (РЪф ╬│Рђ▓ РЪФ MРђ▓))} (РіеLРіЉLРђ▓ ╬│ ╬│Рђ▓)
     (╬Џрхњ[ V ] ╬Џрхњ[ VРђ▓ ] РєњрхњI (РєњрхњI (РєњрхњI РібРё░VM)))
  where
  ­ЮЊЪРѓЂ = ╬╗ V VРђ▓ Рєњ ­Юњ▒РЪд A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ c d РЪД V VРђ▓
           Рѕи (РЪф ╬│Рђ▓ РЪФ LРђ▓ РђћРєа VРђ▓)рхњ Рѕи (РЪф ╬│ РЪФ L РђћРєа V)рхњ Рѕи ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓
  РібРё░VM : Рѕђ{V}{VРђ▓} Рєњ ­ЮЊЪРѓЂ V VРђ▓ Рібрхњ Рё░РЪд B , BРђ▓ , d РЪД (V ┬и РЪф ╬│ РЪФ M) (VРђ▓ ┬и РЪф ╬│Рђ▓ РЪФ MРђ▓) 
  РібРё░VM {V}{VРђ▓} = Рібрхњ-sucP Zрхњ ╬╗ ­Юњ▒VVРђ▓sn Рєњ
   let (v , vРђ▓) = ­Юњ▒РЄњValue (A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ c d) V VРђ▓ ­Юњ▒VVРђ▓sn in
   Рё░-bind {F = ` (v ┬иРќА)}{FРђ▓ = ` (vРђ▓ ┬иРќА)} (Sрхњ (Sрхњ (Sрхњ (РіеMРіЉMРђ▓ ╬│ ╬│Рђ▓))))
           (╬Џрхњ[ V ] ╬Џрхњ[ VРђ▓ ] РєњрхњI (РєњрхњI (РєњрхњI РібРё░VWVWРђ▓)) )
   where
   ­ЮЊЪРѓѓ = ╬╗ V VРђ▓ W WРђ▓ Рєњ ­Юњ▒РЪд A , AРђ▓ , c РЪД W WРђ▓
          Рѕи (РЪф ╬│Рђ▓ РЪФ MРђ▓ РђћРєа WРђ▓)рхњ Рѕи (РЪф ╬│ РЪФ M РђћРєа W)рхњ
          Рѕи ­Юњ▒РЪд A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ c d РЪД V VРђ▓
          Рѕи (РЪф ╬│Рђ▓ РЪФ LРђ▓ РђћРєа VРђ▓)рхњ Рѕи (РЪф ╬│ РЪФ L РђћРєа V)рхњ
          Рѕи ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓ 
   РібРё░VWVWРђ▓ : Рѕђ{V VРђ▓ W WРђ▓} Рєњ ­ЮЊЪРѓѓ V VРђ▓ W WРђ▓ Рібрхњ Рё░РЪд B , BРђ▓ , d РЪД (V ┬и W) (VРђ▓ ┬и WРђ▓)
   РібРё░VWVWРђ▓ {V}{VРђ▓}{W}{WРђ▓} =
    let Ріб­Юњ▒VVРђ▓ : ­ЮЊЪРѓѓ V VРђ▓ W WРђ▓ Рібрхњ ­Юњ▒РЪд A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ c d РЪД V VРђ▓
        Ріб­Юњ▒VVРђ▓ = Sрхњ (Sрхњ (Sрхњ Zрхњ)) in
    let Ріб­Юњ▒WWРђ▓ : ­ЮЊЪРѓѓ V VРђ▓ W WРђ▓ Рібрхњ ­Юњ▒РЪд A , AРђ▓ , c РЪД W WРђ▓
        Ріб­Юњ▒WWРђ▓ = Zрхњ in
    Рібрхњ-sucP Ріб­Юњ▒WWРђ▓ ╬╗ ­Юњ▒WWРђ▓sn Рєњ
    let (w , wРђ▓) = ­Юњ▒РЄњValue (A , AРђ▓ , c) W WРђ▓ ­Юњ▒WWРђ▓sn in
    ­Юњ▒-fun-elim Ріб­Юњ▒VVРђ▓ ╬╗ {N NРђ▓ refl refl ­Юњ▒WWРђ▓РєњРё░NW Рєњ
    let pres-L : ­ЮЊЪРѓѓ (кЏ N) (кЏ NРђ▓) W WРђ▓
                 Рібрхњ preserve-L (B , BРђ▓ , d) (кЏ N ┬и W) (кЏ NРђ▓ ┬и WРђ▓)
        pres-L = ╬Џрхњ[ MРѓЂ ] РєњрхњI (constрхњE Zрхњ ╬╗ {кЏN┬иWРєњMРѓЂ Рєњ
         let ­ЮњФРѓЃ = ((кЏ N ┬и W) РђћРєњ MРѓЂ)рхњ Рѕи ­ЮЊЪРѓѓ (кЏ N) (кЏ NРђ▓) W WРђ▓ in
         let РібРќиРё░NWNWРђ▓ : ­ЮЊЪРѓѓ (кЏ N) (кЏ NРђ▓) W WРђ▓
                        Рібрхњ Рќирхњ Рё░РЪд B , BРђ▓ , d РЪД (N [ W ]) (NРђ▓ [ WРђ▓ ])
             РібРќиРё░NWNWРђ▓ = appрхњ ­Юњ▒WWРђ▓РєњРё░NW (monoрхњ Ріб­Юњ▒WWРђ▓) in
         let MРѓЂ=N[W] = deterministic кЏN┬иWРєњMРѓЂ (╬▓ w) in
         let FРѓЂ = (╬╗ X Рєњ ­ЮЊЪРѓѓ (кЏ N) (кЏ NРђ▓) W WРђ▓
                         Рібрхњ Рќирхњ Рё░РЪд B , BРђ▓ , d РЪД X (РЪф WРђ▓ Рђб id РЪФ NРђ▓)) in
         let РібРќиРё░MРѓЂN[WРђ▓] : ­ЮЊЪРѓѓ (кЏ N) (кЏ NРђ▓) W WРђ▓
                          Рібрхњ Рќирхњ Рё░РЪд B , BРђ▓ , d РЪД MРѓЂ (NРђ▓ [ WРђ▓ ])
             РібРќиРё░MРѓЂN[WРђ▓] = subst FРѓЂ (sym MРѓЂ=N[W]) РібРќиРё░NWNWРђ▓ in
         let ­ЮњФРѓё = Рё░РЪд B , BРђ▓ , d РЪД (N [ W ]) (NРђ▓ [ WРђ▓ ]) Рѕи ­ЮњФРѓЃ in
         let pres-R : ­ЮњФРѓё Рібрхњ preserve-R (B , BРђ▓ , d) (N [ W ]) (кЏ NРђ▓ ┬и WРђ▓)
             pres-R = ╬Џрхњ[ MРѓЂРђ▓ ] РєњрхњI (constрхњE Zрхњ ╬╗ {кЏNРђ▓┬иWРђ▓РєњMРѓЂРђ▓ Рєњ
              let MРѓЂРђ▓=NРђ▓[WРђ▓] = deterministic кЏNРђ▓┬иWРђ▓РєњMРѓЂРђ▓ (╬▓ wРђ▓) in
              let ­ЮњФРѓЁ = ((кЏ NРђ▓ ┬и WРђ▓) РђћРєњ MРѓЂРђ▓)рхњ Рѕи  ­ЮњФРѓё in
              let РќиРё░NWNРђ▓WРђ▓ : ­ЮњФРѓЁ Рібрхњ Рќирхњ Рё░РЪд (B , BРђ▓ , d) РЪД  (N [ W ]) (NРђ▓ [ WРђ▓ ])
                  РќиРё░NWNРђ▓WРђ▓ = Sрхњ (Sрхњ (Sрхњ РібРќиРё░NWNWРђ▓)) in
              let FРѓѓ = ╬╗ M Рєњ ­ЮњФРѓЁ Рібрхњ Рќирхњ Рё░РЪд (B , BРђ▓ , d) РЪД  (N [ W ]) M in
              subst FРѓѓ (sym MРѓЂРђ▓=NРђ▓[WРђ▓]) РќиРё░NWNРђ▓WРђ▓
              }) in
         let concРђ▓ : Рё░РЪд B , BРђ▓ , d РЪД (N [ W ]) (NРђ▓ [ WРђ▓ ]) Рѕи ­ЮњФРѓЃ
                     Рібрхњ Рё░РЪд B , BРђ▓ , d РЪД (N [ W ]) (кЏ NРђ▓ ┬и WРђ▓)
             concРђ▓ = substрхњ (РЅАрхњ-sym Рё░-stmt)
                      (injРѓѓрхњ (injРѓѓрхњ (injРѓЂрхњ (constрхњI (_ , ╬▓ wРђ▓) ,рхњ pres-R)))) in
         let conc : ­ЮњФРѓЃ Рібрхњ Рќирхњ Рё░РЪд (B , BРђ▓ , d) РЪД (N [ W ]) (кЏ NРђ▓ ┬и WРђ▓) 
             conc = РќиРєњРќи{­ЮњФРѓЃ}{Рё░РЪд (B , BРђ▓ , d) РЪД (N [ W ]) (NРђ▓ [ WРђ▓ ])}
                        (Sрхњ РібРќиРё░NWNWРђ▓) concРђ▓ in
         subst (╬╗ M Рєњ ­ЮњФРѓЃ Рібрхњ Рќирхњ Рё░РЪд (B , BРђ▓ , d) РЪД M (кЏ NРђ▓ ┬и WРђ▓)) (sym MРѓЂ=N[W])
               conc
         }) in
    substрхњ (РЅАрхњ-sym Рё░-stmt) (injРѓѓрхњ (injРѓЂрхњ (constрхњI (_ , (╬▓ w)) ,рхњ pres-L)))
    }

compatible-inj-L : Рѕђ{╬Њ}{G AРђ▓}{c : gndРЄњty G РіЉ AРђ▓}{M MРђ▓}
   Рєњ ╬Њ Ріе M РіЉ MРђ▓ Рдѓ (gndРЄњty G , AРђ▓ , c)
     ------------------------------------
   Рєњ ╬Њ Ріе M РЪе G !РЪЕ РіЉ MРђ▓ Рдѓ (РўЁ , AРђ▓ , unkРіЉ)
compatible-inj-L{╬Њ}{G}{AРђ▓}{c}{M}{MРђ▓} РіеMРіЉMРђ▓ ╬│ ╬│Рђ▓ =
  Рё░-bind{F = ` РќАРЪе G !РЪЕ}{РќА} (РіеMРіЉMРђ▓ ╬│ ╬│Рђ▓)
      (╬Џрхњ[ V ] ╬Џрхњ[ VРђ▓ ] РєњрхњI (РєњрхњI (РєњрхњI РібРё░VРЪеG!РЪЕVРђ▓)))
  where
  ­ЮњФРѓЂ = ╬╗ V VРђ▓ Рєњ ­Юњ▒РЪд gndРЄњty G , AРђ▓ , c РЪД V VРђ▓
               Рѕи (РЪф ╬│Рђ▓ РЪФ MРђ▓ РђћРєа VРђ▓)рхњ Рѕи (РЪф ╬│ РЪФ M РђћРєа V)рхњ Рѕи ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓
  РібРё░VРЪеG!РЪЕVРђ▓ : Рѕђ{V VРђ▓} Рєњ ­ЮњФРѓЂ V VРђ▓ Рібрхњ  Рё░РЪд РўЁ , AРђ▓ , unkРіЉ РЪД (V РЪе G !РЪЕ) VРђ▓
  РібРё░VРЪеG!РЪЕVРђ▓ = ­Юњ▒РЄњРё░ (­Юњ▒-dyn-L Zрхњ)

compatible-inj-R : Рѕђ{╬Њ}{G}{c : РўЁ РіЉ gndРЄњty G }{M MРђ▓}
   Рєњ ╬Њ Ріе M РіЉ MРђ▓ Рдѓ (РўЁ , gndРЄњty G , c)
   Рєњ ╬Њ Ріе M РіЉ MРђ▓ РЪе G !РЪЕ Рдѓ (РўЁ , РўЁ , unkРіЉ)
compatible-inj-R{╬Њ}{G}{c }{M}{MРђ▓} РіеMРіЉMРђ▓ ╬│ ╬│Рђ▓ =
  Рё░-bind{F = РќА}{` РќАРЪе G !РЪЕ}
    (РіеMРіЉMРђ▓ ╬│ ╬│Рђ▓) (╬Џрхњ[ V ] ╬Џрхњ[ VРђ▓ ] РєњрхњI (РєњрхњI (РєњрхњI РібРё░VVРђ▓РЪеG!РЪЕ)))
  where
  ­ЮњФРѓЂ = ╬╗ V VРђ▓ Рєњ ­Юњ▒РЪд РўЁ , gndРЄњty G , c РЪД V VРђ▓
               Рѕи (РЪф ╬│Рђ▓ РЪФ MРђ▓ РђћРєа VРђ▓)рхњ Рѕи (РЪф ╬│ РЪФ M РђћРєа V)рхњ Рѕи ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓
  РібРё░VVРђ▓РЪеG!РЪЕ : Рѕђ{V VРђ▓} Рєњ ­ЮњФРѓЂ V VРђ▓ Рібрхњ  Рё░РЪд РўЁ , РўЁ , unkРіЉ РЪД V (VРђ▓ РЪе G !РЪЕ)
  РібРё░VVРђ▓РЪеG!РЪЕ = ­Юњ▒РЄњРё░ (­Юњ▒-dyn-R Zрхњ)

compatible-proj-L : Рѕђ{╬Њ}{H}{AРђ▓}{c : gndРЄњty H РіЉ AРђ▓}{M}{MРђ▓}
   Рєњ ╬Њ Ріе M РіЉ MРђ▓ Рдѓ (РўЁ , AРђ▓ ,  unkРіЉ)
   Рєњ ╬Њ Ріе M РЪе H ?РЪЕ РіЉ MРђ▓ Рдѓ (gndРЄњty H , AРђ▓ , c)
compatible-proj-L {╬Њ}{H}{AРђ▓}{c}{M}{MРђ▓} РіеMРіЉMРђ▓ ╬│ ╬│Рђ▓ =
  Рё░-bind{F = ` РќАРЪе H ?РЪЕ}{РќА} (РіеMРіЉMРђ▓ ╬│ ╬│Рђ▓)
     (╬Џрхњ[ V ] ╬Џрхњ[ VРђ▓ ] РєњрхњI (РєњрхњI (РєњрхњI РібРё░VРЪеH?РЪЕVРђ▓)))
  where
  ­ЮњФРѓЂ = ╬╗ V VРђ▓ AРђ▓ Рєњ ­Юњ▒РЪд РўЁ , AРђ▓ , unkРіЉ РЪД V VРђ▓
               Рѕи (РЪф ╬│Рђ▓ РЪФ MРђ▓ РђћРєа VРђ▓)рхњ Рѕи (РЪф ╬│ РЪФ M РђћРєа V)рхњ Рѕи ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓
  РібРё░VРЪеH?РЪЕVРђ▓ : Рѕђ{V VРђ▓ AРђ▓ H c}
     Рєњ ­ЮњФРѓЂ V VРђ▓ AРђ▓ Рібрхњ  Рё░РЪд gndРЄњty H , AРђ▓ , c РЪД (V РЪе H ?РЪЕ) VРђ▓
  РібРё░VРЪеH?РЪЕVРђ▓ {V} {VРђ▓} {РўЁ} {$рхЇ ╬╣} {()}
  РібРё░VРЪеH?РЪЕVРђ▓ {V} {VРђ▓} {РўЁ} {РўЁРЄњРўЁ} {()}
  РібРё░VРЪеH?РЪЕVРђ▓ {V} {VРђ▓} {$Рѓю ╬╣} {$рхЇ .╬╣} {baseРіЉ} =
    ­Юњ▒-dyn-base-elim Zрхњ Goal
    where
    Goal : Рѕђ{VРѓЂ} {k} Рєњ V РЅА (VРѓЂ РЪе $рхЇ ╬╣ !РЪЕ) Рєњ VРђ▓ РЅА $ k
       Рєњ ­ЮњФРѓЂ V VРђ▓ ($Рѓю ╬╣) Рібрхњ Value VРѓЂ рхњ ├Ќрхњ (Рќирхњ ­Юњ▒РЪд $Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ РЪД VРѓЂ ($ k))
       Рєњ ­ЮњФРѓЂ V VРђ▓ ($Рѓю ╬╣) Рібрхњ Рё░РЪд $Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ РЪД (V РЪе $рхЇ ╬╣ ?РЪЕ) VРђ▓
    Goal {VРѓЂ}{k} refl refl РібvРѓЂ├ЌРќи­Юњ▒VРѓЂk =
      Рібрхњ-sucP (projРѓЂрхњ РібvРѓЂ├ЌРќи­Юњ▒VРѓЂk) ╬╗ vРѓЂ Рєњ
      substрхњ (РЅАрхњ-sym Рё░-stmt) (injРѓѓрхњ (injРѓЂрхњ (constрхњI (_ , (collapse vРѓЂ refl))
         ,рхњ (╬Џрхњ[ N ] (РєњрхњI Goal2)))))
      where
      Goal2 : Рѕђ{N} Рєњ (VРѓЂ РЪе $рхЇ ╬╣ !РЪЕ РЪе $рхЇ ╬╣ ?РЪЕ РђћРєњ N)рхњ
                     Рѕи ­ЮњФРѓЂ (VРѓЂ РЪе $рхЇ ╬╣ !РЪЕ) ($ k) ($Рѓю ╬╣)
                     Рібрхњ Рќирхњ Рё░РЪд $Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ РЪД N ($ k)
      Goal2 {N} =
        Рібрхњ-sucP Zрхњ ╬╗ {red Рєњ
        Рібрхњ-sucP (projРѓЂрхњ (Sрхњ РібvРѓЂ├ЌРќи­Юњ▒VРѓЂk)) ╬╗ { vРѓЂ Рєњ
        let NРЅАVРѓЂ = collapse-inv vРѓЂ red in
        subst (╬╗ N Рєњ (((VРѓЂ РЪе $рхЇ ╬╣ !РЪЕ) РЪе $рхЇ ╬╣ ?РЪЕ) РђћРєњ N) рхњ Рѕи
                ­ЮњФРѓЂ (VРѓЂ РЪе $рхЇ ╬╣ !РЪЕ) VРђ▓ ($Рѓю ╬╣)
                Рібрхњ (Рќирхњ Рё░РЪд $Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ РЪД N VРђ▓)) (sym NРЅАVРѓЂ)
          (РќиРєњРќи (projРѓѓрхњ (Sрхњ РібvРѓЂ├ЌРќи­Юњ▒VРѓЂk)) (­Юњ▒РЄњРё░ Zрхњ))
        }}
    
  РібРё░VРЪеH?РЪЕVРђ▓ {V} {VРђ▓} {AРђ▓ РЄњ BРђ▓} {РўЁРЄњРўЁ} {funРіЉ unkРіЉ unkРіЉ} =
    ­Юњ▒-dyn-fun-elim2{V = V}{VРђ▓} Zрхњ Goal
    where
    Goal : Рѕђ {VРѓЂ} Рєњ V РЅА (VРѓЂ РЪе РўЁРЄњРўЁ !РЪЕ)
       Рєњ ­ЮњФРѓЂ V VРђ▓ (AРђ▓ РЄњ BРђ▓) Рібрхњ Value VРѓЂ рхњ ├Ќрхњ Value VРђ▓ рхњ
          ├Ќрхњ (Рќирхњ ­Юњ▒РЪд РўЁ РЄњ РўЁ , AРђ▓ РЄњ BРђ▓ , funРіЉ unkРіЉ unkРіЉ РЪД VРѓЂ VРђ▓)
       Рєњ ­ЮњФРѓЂ V VРђ▓ (AРђ▓ РЄњ BРђ▓)
          Рібрхњ Рё░РЪд РўЁ РЄњ РўЁ , AРђ▓ РЄњ BРђ▓ , funРіЉ unkРіЉ unkРіЉ РЪД (V РЪе РўЁРЄњРўЁ ?РЪЕ) VРђ▓
    Goal {VРѓЂ} refl РібvРѓЂ├ЌvРђ▓├ЌРќи­Юњ▒VРѓЂVРђ▓ =
      Рібрхњ-sucP (projРѓЂрхњ РібvРѓЂ├ЌvРђ▓├ЌРќи­Юњ▒VРѓЂVРђ▓) ╬╗ vРѓЂ Рєњ
      substрхњ (РЅАрхњ-sym Рё░-stmt) (injРѓѓрхњ (injРѓЂрхњ (constрхњI (_ , (collapse vРѓЂ refl))
         ,рхњ (╬Џрхњ[ N ] (РєњрхњI Goal2)))))
      where
      Goal2 : Рѕђ{N} Рєњ (VРѓЂ РЪе РўЁРЄњРўЁ !РЪЕ РЪе РўЁРЄњРўЁ ?РЪЕ РђћРєњ N)рхњ
                     Рѕи ­ЮњФРѓЂ (VРѓЂ РЪе РўЁРЄњРўЁ !РЪЕ) VРђ▓ (AРђ▓ РЄњ BРђ▓)
                     Рібрхњ Рќирхњ Рё░РЪд РўЁ РЄњ РўЁ , AРђ▓ РЄњ BРђ▓ , funРіЉ unkРіЉ unkРіЉ РЪД N VРђ▓
      Goal2 {N} =
        Рібрхњ-sucP Zрхњ ╬╗ {red Рєњ
        Рібрхњ-sucP (projРѓЂрхњ (Sрхњ РібvРѓЂ├ЌvРђ▓├ЌРќи­Юњ▒VРѓЂVРђ▓)) ╬╗ { vРѓЂ Рєњ
        let NРЅАVРѓЂ = collapse-inv vРѓЂ red in
        subst (╬╗ N Рєњ (((VРѓЂ РЪе РўЁРЄњРўЁ !РЪЕ) РЪе РўЁРЄњРўЁ ?РЪЕ) РђћРєњ N) рхњ Рѕи
                ­ЮњФРѓЂ (VРѓЂ РЪе РўЁРЄњРўЁ !РЪЕ) VРђ▓ (AРђ▓ РЄњ BРђ▓)
                Рібрхњ (Рќирхњ Рё░РЪд РўЁ РЄњ РўЁ , AРђ▓ РЄњ BРђ▓ , funРіЉ unkРіЉ unkРіЉ РЪД N VРђ▓)) (sym NРЅАVРѓЂ)
          (РќиРєњРќи (projРѓѓрхњ (projРѓѓрхњ (Sрхњ РібvРѓЂ├ЌvРђ▓├ЌРќи­Юњ▒VРѓЂVРђ▓))) (­Юњ▒РЄњРё░ Zрхњ))
        }}

compatible-proj-R : Рѕђ{╬Њ}{HРђ▓}{c : РўЁ РіЉ gndРЄњty HРђ▓}{M}{MРђ▓}
   Рєњ ╬Њ Ріе M РіЉ MРђ▓ Рдѓ (РўЁ , РўЁ , unkРіЉ)
   Рєњ ╬Њ Ріе M РіЉ MРђ▓ РЪе HРђ▓ ?РЪЕ Рдѓ (РўЁ , gndРЄњty HРђ▓ , c)
compatible-proj-R {╬Њ}{HРђ▓}{c}{M}{MРђ▓} РіеMРіЉMРђ▓ ╬│ ╬│Рђ▓ =
  Рё░-bind{F = РќА}{` РќАРЪе HРђ▓ ?РЪЕ} (РіеMРіЉMРђ▓ ╬│ ╬│Рђ▓)
     (╬Џрхњ[ V ] ╬Џрхњ[ VРђ▓ ] РєњрхњI (РєњрхњI (РєњрхњI РібРё░VVРђ▓РЪеH?РЪЕ)))
  where
  ­ЮњФРѓЂ = ╬╗ V VРђ▓ Рєњ ­Юњ▒РЪд РўЁ , РўЁ , unkРіЉ РЪД V VРђ▓
                 Рѕи (РЪф ╬│Рђ▓ РЪФ MРђ▓ РђћРєа VРђ▓)рхњ Рѕи (РЪф ╬│ РЪФ M РђћРєа V)рхњ Рѕи ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓  
  РібРё░VVРђ▓РЪеH?РЪЕ : Рѕђ{V VРђ▓ HРђ▓ c}
     Рєњ ­ЮњФРѓЂ V VРђ▓ Рібрхњ Рё░РЪд РўЁ , gndРЄњty HРђ▓ , c РЪД V (VРђ▓ РЪе HРђ▓ ?РЪЕ)
  РібРё░VVРђ▓РЪеH?РЪЕ {V} {VРђ▓} {HРђ▓} {unkРіЉ} =
    ­Юњ▒-dyn-dyn-elim Zрхњ Goal
    where
    Goal : Рѕђ {VРѓЂ VРѓЂРђ▓} {G} Рєњ V РЅА (VРѓЂ РЪе G !РЪЕ) Рєњ VРђ▓ РЅА (VРѓЂРђ▓ РЪе G !РЪЕ)
       Рєњ ­ЮњФРѓЂ V VРђ▓ Рібрхњ Value VРѓЂ рхњ ├Ќрхњ Value VРѓЂРђ▓ рхњ
           ├Ќрхњ (Рќирхњ ­Юњ▒РЪд gndРЄњty G , gndРЄњty G , ReflРіЉ РЪД VРѓЂ VРѓЂРђ▓)
       Рєњ ­ЮњФРѓЂ V VРђ▓ Рібрхњ Рё░РЪд РўЁ , gndРЄњty HРђ▓ , unkРіЉ РЪД V (VРђ▓ РЪе HРђ▓ ?РЪЕ)
    Goal {VРѓЂ}{VРѓЂРђ▓}{G} refl refl РібvРѓЂ├ЌvРѓЂРђ▓├ЌРќи­Юњ▒VРѓЂVРѓЂРђ▓
        with G РЅАрхЇ HРђ▓
    ... | no neq =
        Рібрхњ-sucP (projРѓЂрхњ (projРѓѓрхњ РібvРѓЂ├ЌvРѓЂРђ▓├ЌРќи­Юњ▒VРѓЂVРѓЂРђ▓)) ╬╗ vРѓЂРђ▓ Рєњ
        substрхњ (РЅАрхњ-sym Рё░-stmt)
        (injРѓѓрхњ (injРѓѓрхњ (injРѓЂрхњ (constрхњI (_ , collide vРѓЂРђ▓ neq refl)
          ,рхњ (╬Џрхњ[ NРђ▓ ] (РєњрхњI Goal2))))))
     where
     Goal2 : Рѕђ{NРђ▓}
        Рєњ (VРђ▓ РЪе HРђ▓ ?РЪЕ РђћРєњ NРђ▓)рхњ Рѕи ­ЮњФРѓЂ V VРђ▓
           Рібрхњ Рќирхњ Рё░РЪд РўЁ , gndРЄњty HРђ▓ , unkРіЉ РЪД V NРђ▓
     Goal2 {NРђ▓} =
       Рібрхњ-sucP Zрхњ ╬╗ {red Рєњ
       Рібрхњ-sucP (projРѓЂрхњ (projРѓѓрхњ (Sрхњ РібvРѓЂ├ЌvРѓЂРђ▓├ЌРќи­Юњ▒VРѓЂVРѓЂРђ▓))) ╬╗ { vРѓЂРђ▓ Рєњ
       let NРђ▓РЅАblame = collide-inv neq vРѓЂРђ▓ red in
       subst (╬╗ NРђ▓ Рєњ (((VРѓЂРђ▓ РЪе G !РЪЕ) РЪе HРђ▓ ?РЪЕ) РђћРєњ NРђ▓) рхњ Рѕи
                        ­ЮњФРѓЂ (VРѓЂ РЪе G !РЪЕ) (VРѓЂРђ▓ РЪе G !РЪЕ)
                       Рібрхњ (Рќирхњ Рё░РЪд РўЁ , gndРЄњty HРђ▓ , unkРіЉ РЪД (VРѓЂ РЪе G !РЪЕ) NРђ▓))
             (sym NРђ▓РЅАblame)
       (monoрхњ Рё░-blame)
       }}
       
    Goal {VРѓЂ}{VРѓЂРђ▓}{G} refl refl РібvРѓЂ├ЌvРѓЂРђ▓├ЌРќи­Юњ▒VРѓЂVРѓЂРђ▓ | yes refl =
        Рібрхњ-sucP (projРѓЂрхњ (projРѓѓрхњ РібvРѓЂ├ЌvРѓЂРђ▓├ЌРќи­Юњ▒VРѓЂVРѓЂРђ▓)) ╬╗ vРѓЂРђ▓ Рєњ
        substрхњ (РЅАрхњ-sym Рё░-stmt)
        (injРѓѓрхњ (injРѓѓрхњ (injРѓЂрхњ (constрхњI (_ , collapse vРѓЂРђ▓ refl)
          ,рхњ (╬Џрхњ[ NРђ▓ ] (РєњрхњI Goal2))))))
     where
     Goal2 : Рѕђ{NРђ▓}
        Рєњ (VРђ▓ РЪе HРђ▓ ?РЪЕ РђћРєњ NРђ▓)рхњ Рѕи ­ЮњФРѓЂ V VРђ▓
           Рібрхњ Рќирхњ Рё░РЪд РўЁ , gndРЄњty HРђ▓ , unkРіЉ РЪД V NРђ▓
     Goal2 {NРђ▓} =
       Рібрхњ-sucP Zрхњ ╬╗ {red Рєњ
       Рібрхњ-sucP (projРѓЂрхњ (projРѓѓрхњ (Sрхњ РібvРѓЂ├ЌvРѓЂРђ▓├ЌРќи­Юњ▒VРѓЂVРѓЂРђ▓))) ╬╗ { vРѓЂРђ▓ Рєњ
       let NРђ▓РЅАVРѓЂРђ▓ = collapse-inv vРѓЂРђ▓ red in
       let РібРќи­Юњ▒VРѓЂVРѓЂРђ▓ = (projРѓѓрхњ (projРѓѓрхњ (Sрхњ РібvРѓЂ├ЌvРѓЂРђ▓├ЌРќи­Юњ▒VРѓЂVРѓЂРђ▓))) in
       subst (╬╗ NРђ▓ Рєњ (((VРѓЂРђ▓ РЪе G !РЪЕ) РЪе G ?РЪЕ) РђћРєњ NРђ▓) рхњ
                     Рѕи ­ЮњФРѓЂ (VРѓЂ РЪе G !РЪЕ) (VРѓЂРђ▓ РЪе G !РЪЕ)
                     Рібрхњ (Рќирхњ Рё░РЪд РўЁ , gndРЄњty G , unkРіЉ РЪД (VРѓЂ РЪе G !РЪЕ) NРђ▓))
             (sym NРђ▓РЅАVРѓЂРђ▓)
       (РќиРєњРќи РібРќи­Юњ▒VРѓЂVРѓЂРђ▓ (­Юњ▒РЄњРё░ (­Юњ▒-dyn-L Zрхњ)))
       }}
       
