{-# OPTIONS --rewriting #-}
module LogRel.CastLogRel where

open import Data.List using (List; []; _Рѕи_; length; map)
open import Data.Nat
open import Data.Bool using (true; false) renaming (Bool to ­Юћ╣)
open import Data.Nat.Properties
open import Data.Product using (_,_;_├Ќ_; projРѓЂ; projРѓѓ; ╬Б-syntax; РѕЃ-syntax)
open import Data.Unit using (Ріц; tt)
open import Data.Unit.Polymorphic renaming (Ріц to topрхќ; tt to ttрхќ)
open import Data.Empty using (РіЦ; РіЦ-elim)
open import Data.Sum using (_Ріј_; injРѓЂ; injРѓѓ)
open import Relation.Binary.PropositionalEquality as Eq
  using (_РЅА_; _РЅб_; refl; sym; cong; subst; trans)
open import Relation.Nullary using (┬г_; Dec; yes; no)
open import Var
open import LogRel.Cast
open import LogRel.CastDeterministic
open import StepIndexedLogic
open import EquivalenceRelation

Рё░Ріј­Юњ▒-type : Set
Рё░Ріј­Юњ▒-type = (Prec ├Ќ Term ├Ќ Term) Ріј (Prec ├Ќ Term ├Ќ Term)

Рё░Ріј­Юњ▒-ctx : Context
Рё░Ріј­Юњ▒-ctx = Рё░Ріј­Юњ▒-type Рѕи []

Рё░╦бРЪд_РЪД : Prec Рєњ Term Рєњ Term Рєњ Set╦б Рё░Ріј­Юњ▒-ctx (cons Now РѕЁ)
Рё░╦бРЪд AРіЉB РЪД M MРђ▓ = (injРѓѓ (AРіЉB , M , MРђ▓)) Рѕѕ zero╦б

­Юњ▒╦бРЪд_РЪД : Prec Рєњ Term Рєњ Term Рєњ Set╦б Рё░Ріј­Юњ▒-ctx (cons Now РѕЁ)
­Юњ▒╦бРЪд AРіЉB РЪД V VРђ▓ = (injРѓЂ (AРіЉB , V , VРђ▓)) Рѕѕ zero╦б

pre-­Юњ▒ : Prec Рєњ Term Рєњ Term Рєњ Set╦б Рё░Ріј­Юњ▒-ctx (cons Later РѕЁ)
pre-­Юњ▒ (.РўЁ , РўЁ , unkРіЉ) (V РЪе G !РЪЕ) (VРђ▓ РЪе H !РЪЕ)
    with G РЅАрхЇ H
... | yes refl = let g = gndРЄњty G in
                 (Value V)╦б ├Ќ╦б (Value VРђ▓)╦б
                 ├Ќ╦б (Рќи╦б (­Юњ▒╦бРЪд (g , g , ReflРіЉ) РЪД V VРђ▓))
... | no neq = РіЦ ╦б
pre-­Юњ▒ (.РўЁ , $Рѓю ╬╣Рђ▓ , unkРіЉ) (V РЪе $рхЇ ╬╣ !РЪЕ) ($ c)
    with ($рхЇ ╬╣) РЅАрхЇ ($рхЇ ╬╣Рђ▓)
... | yes refl = (Value V)╦б ├Ќ╦б Рќи╦б (­Юњ▒╦бРЪд ($Рѓю ╬╣ , $Рѓю ╬╣ , ReflРіЉ) РЪД V ($ c))
... | no new = РіЦ ╦б
pre-­Юњ▒ (.РўЁ , AРђ▓ РЄњ BРђ▓ , unkРіЉ) (V РЪе РўЁРЄњРўЁ !РЪЕ) VРђ▓ =
    (Value V)╦б ├Ќ╦б (Value VРђ▓)╦б
    ├Ќ╦б Рќи╦б (­Юњ▒╦бРЪд (РўЁ РЄњ РўЁ , AРђ▓ РЄњ BРђ▓ , funРіЉ unkРіЉ unkРіЉ) РЪД V VРђ▓)
pre-­Юњ▒ ($Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ) ($ c) ($ cРђ▓) = (c РЅА cРђ▓) ╦б
pre-­Юњ▒ ((A РЄњ B) , (AРђ▓ РЄњ BРђ▓) , funРіЉ AРіЉAРђ▓ BРіЉBРђ▓) (кЏ N) (кЏ NРђ▓) =
    Рѕђ╦б[ W ] Рѕђ╦б[ WРђ▓ ] Рќи╦б (­Юњ▒╦бРЪд (A , AРђ▓ , AРіЉAРђ▓) РЪД W WРђ▓)
                  Рєњ╦б Рќи╦б (Рё░╦бРЪд (B , BРђ▓ , BРіЉBРђ▓) РЪД (N [ W ]) (NРђ▓ [ WРђ▓ ])) 
pre-­Юњ▒ (A , AРђ▓ , AРіЉAРђ▓) V VРђ▓ = РіЦ ╦б

pre-Рё░ : Prec Рєњ Term Рєњ Term Рєњ Set╦б Рё░Ріј­Юњ▒-ctx (cons Later РѕЁ)
pre-Рё░ c M MРђ▓ =
       pre-­Юњ▒ c M MРђ▓
    Ріј╦б ((reducible M)╦б ├Ќ╦б (Рѕђ╦б[ N ] (M РђћРєњ N)╦б Рєњ╦б Рќи╦б (Рё░╦бРЪд c РЪД N MРђ▓)))
    Ріј╦б ((reducible MРђ▓)╦б ├Ќ╦б (Рѕђ╦б[ NРђ▓ ] (MРђ▓ РђћРєњ NРђ▓)╦б Рєњ╦б Рќи╦б (Рё░╦бРЪд c РЪД M NРђ▓)))
    Ріј╦б (Blame MРђ▓)╦б

pre-Рё░Ріј­Юњ▒ : Рё░Ріј­Юњ▒-type Рєњ Set╦б Рё░Ріј­Юњ▒-ctx (cons Later РѕЁ)
pre-Рё░Ріј­Юњ▒ (injРѓЂ (c , V , VРђ▓)) = pre-­Юњ▒ c V VРђ▓
pre-Рё░Ріј­Юњ▒ (injРѓѓ (c , M , MРђ▓)) = pre-Рё░ c M MРђ▓

Рё░Ріј­Юњ▒ : Рё░Ріј­Юњ▒-type Рєњ Setрхњ
Рё░Ріј­Юњ▒ X = ╬╝рхњ pre-Рё░Ріј­Юњ▒ X

­Юњ▒РЪд_РЪД : (c : Prec) Рєњ Term Рєњ Term Рєњ Setрхњ
­Юњ▒РЪд c РЪД V VРђ▓ = Рё░Ріј­Юњ▒ (injРѓЂ (c , V , VРђ▓))

Рё░РЪд_РЪД : (c : Prec) Рєњ Term Рєњ Term Рєњ Setрхњ
Рё░РЪд c РЪД M MРђ▓ = Рё░Ріј­Юњ▒ (injРѓѓ (c , M , MРђ▓))

preserve-L : Prec Рєњ Term Рєњ Term Рєњ Setрхњ
preserve-L c M MРђ▓ = (Рѕђрхњ[ N ] ((M РђћРєњ N)рхњ Рєњрхњ Рќирхњ (Рё░РЪд c РЪД N MРђ▓)))

preserve-R : Prec Рєњ Term Рєњ Term Рєњ Setрхњ
preserve-R c M MРђ▓ = (Рѕђрхњ[ NРђ▓ ] ((MРђ▓ РђћРєњ NРђ▓)рхњ Рєњрхњ Рќирхњ (Рё░РЪд c РЪД M NРђ▓)))

Рё░-def : Prec Рєњ Term Рєњ Term Рєњ Setрхњ
Рё░-def c M MРђ▓ = ((­Юњ▒РЪд c РЪД M MРђ▓)
      Ріјрхњ ((reducible M)рхњ ├Ќрхњ preserve-L c M MРђ▓)
      Ріјрхњ ((reducible MРђ▓)рхњ ├Ќрхњ preserve-R c M MРђ▓)
      Ріјрхњ (Blame MРђ▓)рхњ)

Рё░-stmt : Рѕђ{c}{M}{MРђ▓} Рєњ Рё░РЪд c РЪД M MРђ▓ РЅАрхњ Рё░-def c M MРђ▓
Рё░-stmt {c}{M}{MРђ▓} =
  let XРѓЂ = injРѓЂ (c , M , MРђ▓) in
  let XРѓѓ = injРѓѓ (c , M , MРђ▓) in
  Рё░РЪд c РЪД M MРђ▓                                                 РЕдРЪе РЅАрхњ-refl refl РЪЕ
  ╬╝рхњ pre-Рё░Ріј­Юњ▒ XРѓѓ                                      РЕдРЪе fixpointрхњ pre-Рё░Ріј­Юњ▒ XРѓѓ РЪЕ
  # (pre-Рё░Ріј­Юњ▒ XРѓѓ) (Рё░Ріј­Юњ▒ , ttрхќ)
                                  РЕдРЪе cong-Ріјрхњ ((РЅАрхњ-sym (fixpointрхњ pre-Рё░Ріј­Юњ▒ XРѓЂ)))
                                       (cong-Ріјрхњ (РЅАрхњ-refl refl) (РЅАрхњ-refl refl)) РЪЕ
  Рё░-def c M MРђ▓
  Рѕј

Рё░-suc : Рѕђ{c}{M}{MРђ▓}{k}
  Рєњ #(Рё░РЪд c РЪД M MРђ▓) (suc k) РЄћ #(Рё░-def c M MРђ▓) (suc k)
Рё░-suc {c}{M}{MРђ▓}{k} = РЅАрхњРЄњРЄћ{k = suc k} (Рё░-stmt{c}{M}{MРђ▓})

{------------- Related values are syntactic values ----------------------------}

­Юњ▒РЄњValue : Рѕђ {k} c M MРђ▓
   Рєњ # (­Юњ▒РЪд c РЪД M MРђ▓) (suc k)
     ------------------------
   Рєњ Value M ├Ќ Value MРђ▓
­Юњ▒РЄњValue {k} (.РўЁ , РўЁ , unkРіЉ) (V РЪе G !РЪЕ) (VРђ▓ РЪе H !РЪЕ) ­Юњ▒MMРђ▓
    with G РЅАрхЇ H
... | no neq = РіЦ-elim ­Юњ▒MMРђ▓
... | yes refl
    with ­Юњ▒MMРђ▓
... | v , vРђ▓ , _ = (v РїЕ G Рїф) , (vРђ▓ РїЕ G Рїф)
­Юњ▒РЄњValue {k} (.РўЁ , $Рѓю ╬╣Рђ▓ , unkРіЉ) (V РЪе $рхЇ ╬╣ !РЪЕ) ($ c) ­Юњ▒MMРђ▓
    with  ($рхЇ ╬╣) РЅАрхЇ ($рхЇ ╬╣Рђ▓)
... | no neq = РіЦ-elim ­Юњ▒MMРђ▓
... | yes refl
    with ­Юњ▒MMРђ▓
... | v , _ = (v РїЕ $рхЇ ╬╣Рђ▓ Рїф) , ($╠г c)
­Юњ▒РЄњValue {k} (.РўЁ , AРђ▓ РЄњ BРђ▓ , unkРіЉ) (V РЪе РўЁРЄњРўЁ !РЪЕ) VРђ▓ ­Юњ▒VVРђ▓
    with ­Юњ▒VVРђ▓
... | v , vРђ▓ , _ = (v РїЕ РўЁРЄњРўЁ Рїф) , vРђ▓
­Юњ▒РЄњValue {k} ($Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ) ($ c) ($ cРђ▓) refl = ($╠г c) , ($╠г c)
­Юњ▒РЄњValue {k} ((A РЄњ B) , (AРђ▓ РЄњ BРђ▓) , funРіЉ AРіЉAРђ▓ BРіЉBРђ▓) (кЏ N) (кЏ NРђ▓) ­Юњ▒VVРђ▓ =
    (кЏ╠г N) , (кЏ╠г NРђ▓)

{--------- Equations, intro, and elim rules for ­Юњ▒ ----------------------------}

­Юњ▒-base : Рѕђ{╬╣}{c}{cРђ▓} Рєњ ­Юњ▒РЪд ($Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ) РЪД ($ c) ($ cРђ▓) РЅАрхњ (c РЅА cРђ▓) рхњ
­Юњ▒-base{╬╣}{c}{cРђ▓} = РЅАрхњ-intro ╬╗ k Рєњ (╬╗ x Рєњ x) , (╬╗ x Рєњ x)

­Юњ▒-base-intro : Рѕђ{­ЮњФ}{╬╣}{c} Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд ($Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ) РЪД ($ c) ($ c)
­Юњ▒-base-intro{╬╣}{c} = substрхњ (РЅАрхњ-sym ­Юњ▒-base) (constрхњI refl)

­Юњ▒-base-elim : Рѕђ{­ЮњФ}{╬╣}{╬╣Рђ▓}{c}{V}{VРђ▓}{R}
  Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд $Рѓю ╬╣ , $Рѓю ╬╣Рђ▓ , c РЪД V VРђ▓
  Рєњ (Рѕђ k Рєњ ╬╣ РЅА ╬╣Рђ▓ Рєњ V РЅА $ k Рєњ VРђ▓ РЅА $ k Рєњ ­ЮњФ Рібрхњ R)
    -------------------------------------------
  Рєњ ­ЮњФ Рібрхњ R
­Юњ▒-base-elim{­ЮњФ}{╬╣}{╬╣Рђ▓}{c}{V}{VРђ▓}{R} Ріб­Юњ▒VVРђ▓ cont =
  Рібрхњ-sucP Ріб­Юњ▒VVРђ▓ ╬╗ ­Юњ▒VVРђ▓ Рєњ G ­Юњ▒VVРђ▓ Ріб­Юњ▒VVРђ▓ cont
  where
  G : Рѕђ{╬╣}{╬╣Рђ▓}{c}{V}{VРђ▓}{n} Рєњ  #(­Юњ▒РЪд $Рѓю ╬╣ , $Рѓю ╬╣Рђ▓ , c РЪД V VРђ▓) (suc n)
    Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд $Рѓю ╬╣ , $Рѓю ╬╣Рђ▓ , c РЪД V VРђ▓
    Рєњ (Рѕђ k Рєњ ╬╣ РЅА ╬╣Рђ▓ Рєњ V РЅА $ k Рєњ VРђ▓ РЅА $ k Рєњ ­ЮњФ Рібрхњ R)
    Рєњ ­ЮњФ Рібрхњ R
  G {╬╣} {.╬╣} {baseРіЉ} {$ k} {$ kРђ▓} {n} refl Ріб­Юњ▒kk cont = cont k refl refl refl

­Юњ▒-fun : Рѕђ{A B AРђ▓ BРђ▓}{AРіЉAРђ▓ : A РіЉ AРђ▓}{BРіЉBРђ▓ : B РіЉ BРђ▓}{N}{NРђ▓}
   Рєњ (­Юњ▒РЪд A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ AРіЉAРђ▓ BРіЉBРђ▓ РЪД (кЏ N) (кЏ NРђ▓))
      РЅАрхњ (Рѕђрхњ[ W ] Рѕђрхњ[ WРђ▓ ] ((Рќирхњ (­Юњ▒РЪд A , AРђ▓ , AРіЉAРђ▓ РЪД W WРђ▓))
                         Рєњрхњ (Рќирхњ (Рё░РЪд B , BРђ▓ , BРіЉBРђ▓ РЪД (N [ W ]) (NРђ▓ [ WРђ▓ ])))))
­Юњ▒-fun {A}{B}{AРђ▓}{BРђ▓}{AРіЉAРђ▓}{BРіЉBРђ▓}{N}{NРђ▓} =
   let X = injРѓЂ ((A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ AРіЉAРђ▓ BРіЉBРђ▓) , кЏ N , кЏ NРђ▓) in
   (­Юњ▒РЪд A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ AРіЉAРђ▓ BРіЉBРђ▓ РЪД (кЏ N) (кЏ NРђ▓))      РЕдРЪе РЅАрхњ-refl refl РЪЕ
   Рё░Ріј­Юњ▒ X                                              РЕдРЪе fixpointрхњ pre-Рё░Ріј­Юњ▒ X РЪЕ
   # (pre-Рё░Ріј­Юњ▒ X) (Рё░Ріј­Юњ▒ , ttрхќ)                                 РЕдРЪе РЅАрхњ-refl refl РЪЕ
   (Рѕђрхњ[ W ] Рѕђрхњ[ WРђ▓ ] ((Рќирхњ (­Юњ▒РЪд A , AРђ▓ , AРіЉAРђ▓ РЪД W WРђ▓))
                      Рєњрхњ (Рќирхњ (Рё░РЪд B , BРђ▓ , BРіЉBРђ▓ РЪД (N [ W ]) (NРђ▓ [ WРђ▓ ])))))    Рѕј

­Юњ▒-fun-elim : Рѕђ{­ЮњФ}{A}{B}{AРђ▓}{BРђ▓}{c : A РіЉ AРђ▓}{d : B РіЉ BРђ▓}{V}{VРђ▓}{R}
   Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ c d РЪД V VРђ▓
   Рєњ (Рѕђ N NРђ▓ Рєњ V РЅА кЏ N Рєњ VРђ▓ РЅА кЏ NРђ▓ 
             Рєњ (Рѕђ{W WРђ▓} Рєњ ­ЮњФ Рібрхњ (Рќирхњ (­Юњ▒РЪд A , AРђ▓ , c РЪД W WРђ▓))
                             Рєњрхњ (Рќирхњ (Рё░РЪд B , BРђ▓ , d РЪД (N [ W ]) (NРђ▓ [ WРђ▓ ]))))
             Рєњ ­ЮњФ Рібрхњ R)
     --------------------------------------------------------------------
   Рєњ ­ЮњФ Рібрхњ R
­Юњ▒-fun-elim {­ЮњФ}{A}{B}{AРђ▓}{BРђ▓}{c}{d}{V}{VРђ▓}{R} Ріб­Юњ▒VVРђ▓ cont =
  Рібрхњ-sucP Ріб­Юњ▒VVРђ▓ ╬╗ { ­Юњ▒VVРђ▓sn Рєњ G {V}{VРђ▓} ­Юњ▒VVРђ▓sn Ріб­Юњ▒VVРђ▓ cont }
  where
  G : Рѕђ{V}{VРђ▓}{n}
     Рєњ # (­Юњ▒РЪд  A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ c d РЪД V VРђ▓) (suc n)
     Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд A РЄњ B , AРђ▓ РЄњ BРђ▓ , funРіЉ c d РЪД V VРђ▓
     Рєњ (Рѕђ N NРђ▓ Рєњ V РЅА кЏ N Рєњ VРђ▓ РЅА кЏ NРђ▓ 
             Рєњ (Рѕђ{W WРђ▓} Рєњ ­ЮњФ Рібрхњ (Рќирхњ (­Юњ▒РЪд A , AРђ▓ , c РЪД W WРђ▓))
                             Рєњрхњ (Рќирхњ (Рё░РЪд B , BРђ▓ , d РЪД (N [ W ]) (NРђ▓ [ WРђ▓ ]))))
             Рєњ ­ЮњФ Рібрхњ R)
     Рєњ ­ЮњФ Рібрхњ R
  G {кЏ N}{кЏ NРђ▓}{n} ­Юњ▒VVРђ▓ Ріб­Юњ▒VVРђ▓ cont = cont N NРђ▓ refl refl ╬╗ {W}{WРђ▓} Рєњ
     instрхњ (instрхњ (substрхњ ­Юњ▒-fun Ріб­Юњ▒VVРђ▓) W) WРђ▓ 

­Юњ▒-dyn-base : Рѕђ{V}{╬╣}{k}
   Рєњ ­Юњ▒РЪд РўЁ , $Рѓю ╬╣ , unkРіЉ РЪД (V РЪе $рхЇ ╬╣ !РЪЕ) ($ k)
     РЅАрхњ (Value V)рхњ ├Ќрхњ Рќирхњ (­Юњ▒РЪд ($Рѓю ╬╣ , $Рѓю ╬╣ , ReflРіЉ) РЪД V ($ k))
­Юњ▒-dyn-base{V} {╬╣}{k} =
  let X = injРѓЂ ((РўЁ , $Рѓю ╬╣ , unkРіЉ) , (V РЪе $рхЇ ╬╣ !РЪЕ) , ($ k)) in
  ­Юњ▒РЪд РўЁ , $Рѓю ╬╣ , unkРіЉ РЪД (V РЪе $рхЇ ╬╣ !РЪЕ) ($ k)
    РЕдРЪе РЅАрхњ-refl refl РЪЕ
  Рё░Ріј­Юњ▒ X
    РЕдРЪе fixpointрхњ pre-Рё░Ріј­Юњ▒ X  РЪЕ
  # (pre-Рё░Ріј­Юњ▒ X) (Рё░Ріј­Юњ▒ , ttрхќ)
    РЕдРЪе EQ1 РЪЕ
  (Value V)рхњ ├Ќрхњ Рќирхњ (­Юњ▒РЪд ($Рѓю ╬╣ , $Рѓю ╬╣ , ReflРіЉ) РЪД V ($ k)) Рѕј
  where
  X = injРѓЂ ((РўЁ , $Рѓю ╬╣ , unkРіЉ) , (V РЪе $рхЇ ╬╣ !РЪЕ) , ($ k))
  EQ1 : # (pre-Рё░Ріј­Юњ▒ X) (Рё░Ріј­Юњ▒ , ttрхќ)
    РЅАрхњ (Value V)рхњ ├Ќрхњ Рќирхњ (­Юњ▒РЪд ($Рѓю ╬╣ , $Рѓю ╬╣ , ReflРіЉ) РЪД V ($ k))
  EQ1
      with ($рхЇ ╬╣) РЅАрхЇ ($рхЇ ╬╣)
  ... | no neq = РіЦ-elim (neq refl)    
  ... | yes refl = РЅАрхњ-refl refl

­Юњ▒-dyn-base-elim : Рѕђ{­ЮњФ}{╬╣}{V}{VРђ▓}{R}
   Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , $Рѓю ╬╣ , unkРіЉ РЪД V VРђ▓
   Рєњ (Рѕђ{VРѓЂ}{k} Рєњ V РЅА VРѓЂ РЪе $рхЇ ╬╣ !РЪЕ Рєњ VРђ▓ РЅА ($ k)
         Рєњ ­ЮњФ Рібрхњ (Value VРѓЂ)рхњ ├Ќрхњ Рќирхњ ­Юњ▒РЪд $Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ РЪД VРѓЂ ($ k) Рєњ ­ЮњФ Рібрхњ R)
   Рєњ ­ЮњФ Рібрхњ R
­Юњ▒-dyn-base-elim {­ЮњФ}{╬╣}{V}{VРђ▓}{R} Ріб­Юњ▒VVРђ▓ cont =
  Рібрхњ-sucP Ріб­Юњ▒VVРђ▓ ╬╗ { ­Юњ▒VVРђ▓sn Рєњ G ­Юњ▒VVРђ▓sn Ріб­Юњ▒VVРђ▓ cont }
  where
  G : Рѕђ{V}{VРђ▓}{n}
     Рєњ # (­Юњ▒РЪд РўЁ , $Рѓю ╬╣ , unkРіЉ РЪД V VРђ▓) (suc n)
     Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , $Рѓю ╬╣ , unkРіЉ РЪД V VРђ▓
     Рєњ (Рѕђ{VРѓЂ}{k} Рєњ V РЅА VРѓЂ РЪе $рхЇ ╬╣ !РЪЕ Рєњ VРђ▓ РЅА ($ k)
        Рєњ ­ЮњФ Рібрхњ (Value VРѓЂ)рхњ ├Ќрхњ Рќирхњ ­Юњ▒РЪд $Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ РЪД VРѓЂ ($ k) Рєњ ­ЮњФ Рібрхњ R)
     Рєњ ­ЮњФ Рібрхњ R
  G {VРѓЂ РЪе $рхЇ ╬╣Рђ▓ !РЪЕ}{$ k}{n} ­Юњ▒VVРђ▓ Ріб­Юњ▒VVРђ▓ cont
      with ($рхЇ ╬╣Рђ▓) РЅАрхЇ ($рхЇ ╬╣)
  ... | no neq = РіЦ-elim ­Юњ▒VVРђ▓
  ... | yes refl = cont refl refl (substрхњ (­Юњ▒-dyn-base{VРѓЂ}{╬╣}{k}) Ріб­Юњ▒VVРђ▓)
  G {L ┬и M}{VРђ▓}{n} () Ріб­Юњ▒VVРђ▓ cont
  G {кЏ N}{VРђ▓}{n} () Ріб­Юњ▒VVРђ▓ cont
  G {` x}{VРђ▓}{n} () Ріб­Юњ▒VVРђ▓ cont
  G {VРѓЂ РЪе H ?РЪЕ}{VРђ▓}{n} () Ріб­Юњ▒VVРђ▓ cont

Value-inj-inv : Рѕђ{V}{G}
   Рєњ Value (V РЪе G !РЪЕ)
   Рєњ Value V
Value-inj-inv {V} {G} (v РїЕ .G Рїф) = v

­Юњ▒-dyn-fun : Рѕђ{AРђ▓}{BРђ▓}{V}{VРђ▓}
   Рєњ ­Юњ▒РЪд РўЁ , AРђ▓ РЄњ BРђ▓ , unkРіЉ РЪД (V РЪе РўЁРЄњРўЁ !РЪЕ) VРђ▓
     РЅАрхњ (Value V)рхњ ├Ќрхњ (Value VРђ▓)рхњ
        ├Ќрхњ Рќирхњ (­Юњ▒РЪд (РўЁ РЄњ РўЁ , AРђ▓ РЄњ BРђ▓ , funРіЉ unkРіЉ unkРіЉ) РЪД V VРђ▓)
­Юњ▒-dyn-fun {AРђ▓}{BРђ▓}{V}{VРђ▓} =
  let X = injРѓЂ ((РўЁ , AРђ▓ РЄњ BРђ▓ , unkРіЉ) , (V РЪе РўЁРЄњРўЁ !РЪЕ) , VРђ▓) in
  ­Юњ▒РЪд РўЁ , AРђ▓ РЄњ BРђ▓ , unkРіЉ РЪД (V РЪе РўЁРЄњРўЁ !РЪЕ) VРђ▓
     РЕдРЪе РЅАрхњ-refl refl РЪЕ
  Рё░Ріј­Юњ▒ X
    РЕдРЪе fixpointрхњ pre-Рё░Ріј­Юњ▒ X  РЪЕ
  # (pre-Рё░Ріј­Юњ▒ X) (Рё░Ріј­Юњ▒ , ttрхќ)
    РЕдРЪе РЅАрхњ-refl refl РЪЕ
  (Value V)рхњ ├Ќрхњ (Value VРђ▓)рхњ
        ├Ќрхњ Рќирхњ (­Юњ▒РЪд (РўЁ РЄњ РўЁ , AРђ▓ РЄњ BРђ▓ , funРіЉ unkРіЉ unkРіЉ) РЪД V VРђ▓)
  Рѕј 

­Юњ▒-dyn-fun-elim : Рѕђ{­ЮњФ}{V}{VРђ▓}{R}
   Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , РўЁ РЄњ РўЁ , unkРіЉ РЪД V VРђ▓
   Рєњ (Рѕђ{VРѓЂ} Рєњ V РЅА VРѓЂ РЪе РўЁРЄњРўЁ !РЪЕ 
         Рєњ ­ЮњФ Рібрхњ (Value VРѓЂ)рхњ ├Ќрхњ (Value VРђ▓)рхњ
             ├Ќрхњ Рќирхњ ­Юњ▒РЪд РўЁ РЄњ РўЁ , РўЁ РЄњ РўЁ , funРіЉ unkРіЉ unkРіЉ РЪД VРѓЂ VРђ▓ Рєњ ­ЮњФ Рібрхњ R)
   Рєњ ­ЮњФ Рібрхњ R
­Юњ▒-dyn-fun-elim {­ЮњФ}{V}{VРђ▓}{R} Ріб­Юњ▒VVРђ▓ cont =
  Рібрхњ-sucP Ріб­Юњ▒VVРђ▓ ╬╗ { ­Юњ▒VVРђ▓sn Рєњ G ­Юњ▒VVРђ▓sn Ріб­Юњ▒VVРђ▓ cont }
  where
  G : Рѕђ{V}{VРђ▓}{n}
     Рєњ # (­Юњ▒РЪд РўЁ , РўЁ РЄњ РўЁ , unkРіЉ РЪД V VРђ▓) (suc n)
     Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , РўЁ РЄњ РўЁ , unkРіЉ РЪД V VРђ▓
     Рєњ (Рѕђ{VРѓЂ} Рєњ V РЅА VРѓЂ РЪе РўЁРЄњРўЁ !РЪЕ
        Рєњ ­ЮњФ Рібрхњ (Value VРѓЂ)рхњ ├Ќрхњ (Value VРђ▓)рхњ
                ├Ќрхњ Рќирхњ ­Юњ▒РЪд РўЁ РЄњ РўЁ , РўЁ РЄњ РўЁ , funРіЉ unkРіЉ unkРіЉ РЪД VРѓЂ VРђ▓
        Рєњ ­ЮњФ Рібрхњ R)
     Рєњ ­ЮњФ Рібрхњ R
  G {VРѓЂ РЪе РўЁРЄњРўЁ !РЪЕ}{VРђ▓}{n} ­Юњ▒V!VРђ▓ Ріб­Юњ▒V!VРђ▓ cont =
    let Ріб­Юњ▒VVРђ▓ = substрхњ ­Юњ▒-dyn-fun Ріб­Юњ▒V!VРђ▓ in
    cont refl Ріб­Юњ▒VVРђ▓

­Юњ▒-dyn-fun-elim2 : Рѕђ{­ЮњФ}{V}{VРђ▓}{R}{A}{B}
   Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , A РЄњ B , unkРіЉ РЪД V VРђ▓
   Рєњ (Рѕђ{VРѓЂ} Рєњ V РЅА VРѓЂ РЪе РўЁРЄњРўЁ !РЪЕ 
         Рєњ ­ЮњФ Рібрхњ (Value VРѓЂ)рхњ ├Ќрхњ (Value VРђ▓)рхњ
             ├Ќрхњ Рќирхњ ­Юњ▒РЪд РўЁ РЄњ РўЁ , A РЄњ B , funРіЉ unkРіЉ unkРіЉ РЪД VРѓЂ VРђ▓ Рєњ ­ЮњФ Рібрхњ R)
   Рєњ ­ЮњФ Рібрхњ R
­Юњ▒-dyn-fun-elim2 {­ЮњФ}{V}{VРђ▓}{R}{A}{B} Ріб­Юњ▒VVРђ▓ cont =
  Рібрхњ-sucP Ріб­Юњ▒VVРђ▓ ╬╗ { ­Юњ▒VVРђ▓sn Рєњ G ­Юњ▒VVРђ▓sn Ріб­Юњ▒VVРђ▓ cont }
  where
  G : Рѕђ{V}{VРђ▓}{n}
     Рєњ # (­Юњ▒РЪд РўЁ , A РЄњ B , unkРіЉ РЪД V VРђ▓) (suc n)
     Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , A РЄњ B , unkРіЉ РЪД V VРђ▓
     Рєњ (Рѕђ{VРѓЂ} Рєњ V РЅА VРѓЂ РЪе РўЁРЄњРўЁ !РЪЕ
        Рєњ ­ЮњФ Рібрхњ (Value VРѓЂ)рхњ ├Ќрхњ (Value VРђ▓)рхњ
                ├Ќрхњ Рќирхњ ­Юњ▒РЪд РўЁ РЄњ РўЁ , A РЄњ B , funРіЉ unkРіЉ unkРіЉ РЪД VРѓЂ VРђ▓
        Рєњ ­ЮњФ Рібрхњ R)
     Рєњ ­ЮњФ Рібрхњ R
  G {VРѓЂ РЪе РўЁРЄњРўЁ !РЪЕ}{VРђ▓}{n} ­Юњ▒V!VРђ▓ Ріб­Юњ▒V!VРђ▓ cont =
    let Ріб­Юњ▒VVРђ▓ = substрхњ ­Юњ▒-dyn-fun Ріб­Юњ▒V!VРђ▓ in
    cont refl Ріб­Юњ▒VVРђ▓

­Юњ▒-dyn-dyn : Рѕђ{V}{VРђ▓}{G}
   Рєњ ­Юњ▒РЪд РўЁ , РўЁ , unkРіЉ РЪД (V РЪе G !РЪЕ) (VРђ▓ РЪе G !РЪЕ)
     РЅАрхњ (Value V)рхњ ├Ќрхњ (Value VРђ▓)рхњ
         ├Ќрхњ (Рќирхњ (­Юњ▒РЪд (gndРЄњty G , gndРЄњty G , ReflРіЉ) РЪД V VРђ▓))
­Юњ▒-dyn-dyn {V}{VРђ▓}{G} =
  let X = injРѓЂ ((РўЁ , РўЁ , unkРіЉ) , (V РЪе G !РЪЕ) , (VРђ▓ РЪе G !РЪЕ)) in 
  ­Юњ▒РЪд РўЁ , РўЁ , unkРіЉ РЪД (V РЪе G !РЪЕ) (VРђ▓ РЪе G !РЪЕ)
    РЕдРЪе РЅАрхњ-refl refl РЪЕ
  Рё░Ріј­Юњ▒ X
    РЕдРЪе fixpointрхњ pre-Рё░Ріј­Юњ▒ X  РЪЕ
  # (pre-Рё░Ріј­Юњ▒ X) (Рё░Ріј­Юњ▒ , ttрхќ)
    РЕдРЪе EQ РЪЕ
   (Value V)рхњ ├Ќрхњ (Value VРђ▓)рхњ
         ├Ќрхњ (Рќирхњ (­Юњ▒РЪд (gndРЄњty G , gndРЄњty G , ReflРіЉ) РЪД V VРђ▓)) Рѕј
  where
  X = injРѓЂ ((РўЁ , РўЁ , unkРіЉ) , (V РЪе G !РЪЕ) , (VРђ▓ РЪе G !РЪЕ))
  EQ : # (pre-Рё░Ріј­Юњ▒ X) (Рё░Ріј­Юњ▒ , ttрхќ)
    РЅАрхњ (Value V)рхњ ├Ќрхњ (Value VРђ▓)рхњ
         ├Ќрхњ (Рќирхњ (­Юњ▒РЪд (gndРЄњty G , gndРЄњty G , ReflРіЉ) РЪД V VРђ▓))
  EQ
      with G РЅАрхЇ G
  ... | yes refl = РЅАрхњ-refl refl
  ... | no neq = РіЦ-elim (neq refl)

­Юњ▒-dyn-R : Рѕђ{­ЮњФ}{G}{c : РўЁ РіЉ gndРЄњty G}{V}{VРђ▓}
   Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , gndРЄњty G , c РЪД V VРђ▓
   Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , РўЁ , unkРіЉ РЪД V (VРђ▓ РЪе G !РЪЕ)
­Юњ▒-dyn-R {­ЮњФ} {$рхЇ ╬╣} {unkРіЉ} {V} {VРђ▓} Ріб­Юњ▒VVРђ▓ =
  ­Юњ▒-dyn-base-elim Ріб­Юњ▒VVРђ▓ G
  where
  G : Рѕђ{VРѓЂ} {k} Рєњ V РЅА (VРѓЂ РЪе $рхЇ ╬╣ !РЪЕ) Рєњ VРђ▓ РЅА $ k
     Рєњ ­ЮњФ Рібрхњ (Value VРѓЂ)рхњ ├Ќрхњ (Рќирхњ ­Юњ▒РЪд $Рѓю ╬╣ , $Рѓю ╬╣ , baseРіЉ РЪД VРѓЂ ($ k))
     Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , РўЁ , unkРіЉ РЪД V (VРђ▓ РЪе $рхЇ ╬╣ !РЪЕ)
  G {VРѓЂ} {k} refl refl РібvРѓЂ├Ќ­Юњ▒VРѓЂk =
    substрхњ (РЅАрхњ-sym ­Юњ▒-dyn-dyn)
      (projРѓЂрхњ РібvРѓЂ├Ќ­Юњ▒VРѓЂk ,рхњ (constрхњI ($╠г k) ,рхњ projРѓѓрхњ РібvРѓЂ├Ќ­Юњ▒VРѓЂk))
­Юњ▒-dyn-R {­ЮњФ} {РўЁРЄњРўЁ} {unkРіЉ} {V} {VРђ▓} Ріб­Юњ▒VVРђ▓ = ­Юњ▒-dyn-fun-elim Ріб­Юњ▒VVРђ▓ G
  where
  G : Рѕђ {VРѓЂ} Рєњ V РЅА (VРѓЂ РЪе РўЁРЄњРўЁ !РЪЕ)
     Рєњ ­ЮњФ Рібрхњ Value VРѓЂ рхњ ├Ќрхњ Value VРђ▓ рхњ
          ├Ќрхњ (Рќирхњ ­Юњ▒РЪд РўЁ РЄњ РўЁ , РўЁ РЄњ РўЁ , funРіЉ unkРіЉ unkРіЉ РЪД VРѓЂ VРђ▓)
     Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , РўЁ , unkРіЉ РЪД V (VРђ▓ РЪе РўЁРЄњРўЁ !РЪЕ)
  G {VРѓЂ} refl Рібv├ЌvРђ▓├ЌРќи­Юњ▒VРѓЂVРђ▓ = substрхњ (РЅАрхњ-sym ­Юњ▒-dyn-dyn) Рібv├ЌvРђ▓├ЌРќи­Юњ▒VРѓЂVРђ▓

­Юњ▒-dyn-dyn-elim : Рѕђ{­ЮњФ}{V}{VРђ▓}{R}
   Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , РўЁ , unkРіЉ РЪД V VРђ▓
   Рєњ (Рѕђ{VРѓЂ}{VРѓЂРђ▓}{G} Рєњ V РЅА VРѓЂ РЪе G !РЪЕ Рєњ VРђ▓ РЅА VРѓЂРђ▓ РЪе G !РЪЕ
         Рєњ ­ЮњФ Рібрхњ (Value VРѓЂ)рхњ ├Ќрхњ (Value VРѓЂРђ▓)рхњ
             ├Ќрхњ Рќирхњ ­Юњ▒РЪд gndРЄњty G , gndРЄњty G , ReflРіЉ РЪД VРѓЂ VРѓЂРђ▓ Рєњ ­ЮњФ Рібрхњ R)
   Рєњ ­ЮњФ Рібрхњ R
­Юњ▒-dyn-dyn-elim {­ЮњФ}{V}{VРђ▓}{R} Ріб­Юњ▒VVРђ▓ cont =
  Рібрхњ-sucP Ріб­Юњ▒VVРђ▓ ╬╗ ­Юњ▒VVРђ▓ Рєњ G ­Юњ▒VVРђ▓ Ріб­Юњ▒VVРђ▓ cont
  where
  G : Рѕђ{V}{VРђ▓}{n}
     Рєњ # (­Юњ▒РЪд РўЁ , РўЁ , unkРіЉ РЪД V VРђ▓) (suc n)
     Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , РўЁ , unkРіЉ РЪД V VРђ▓
     Рєњ (Рѕђ{VРѓЂ}{VРѓЂРђ▓}{G} Рєњ V РЅА VРѓЂ РЪе G !РЪЕ Рєњ VРђ▓ РЅА VРѓЂРђ▓ РЪе G !РЪЕ
         Рєњ ­ЮњФ Рібрхњ (Value VРѓЂ)рхњ ├Ќрхњ (Value VРѓЂРђ▓)рхњ
             ├Ќрхњ Рќирхњ ­Юњ▒РЪд gndРЄњty G , gndРЄњty G , ReflРіЉ РЪД VРѓЂ VРѓЂРђ▓ Рєњ ­ЮњФ Рібрхњ R)
     Рєњ ­ЮњФ Рібрхњ R
  G {VРѓЂ РЪе G !РЪЕ}{VРѓЂРђ▓ РЪе H !РЪЕ}{n} ­Юњ▒VVРђ▓ Ріб­Юњ▒VVРђ▓ cont
      with G РЅАрхЇ H
  ... | no neq = РіЦ-elim ­Юњ▒VVРђ▓
  ... | yes refl = cont refl refl (substрхњ ­Юњ▒-dyn-dyn Ріб­Юњ▒VVРђ▓)

­Юњ▒-dyn-L : Рѕђ{­ЮњФ}{G}{AРђ▓}{c : gndРЄњty G РіЉ AРђ▓}{V}{VРђ▓}
   Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд gndРЄњty G , AРђ▓ , c РЪД V VРђ▓
   Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , AРђ▓ , unkРіЉ РЪД (V РЪе G !РЪЕ) VРђ▓
­Юњ▒-dyn-L {­ЮњФ} {$рхЇ ╬╣} {$Рѓю ╬╣Рђ▓} {c} {V} {VРђ▓} ­Юњ▒VVРђ▓ =
  ­Юњ▒-base-elim ­Юњ▒VVРђ▓ ╬╗ {k refl refl refl Рєњ G}
  where
  G : Рѕђ{k} Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд РўЁ , $Рѓю ╬╣ , unkРіЉ РЪД ($ k РЪе $рхЇ ╬╣ !РЪЕ) ($ k)
  G {k} = substрхњ (РЅАрхњ-sym ­Юњ▒-dyn-base) (constрхњI ($╠г k) ,рхњ monoрхњ ­Юњ▒-base-intro)
­Юњ▒-dyn-L {­ЮњФ} {РўЁРЄњРўЁ} {AРђ▓ РЄњ BРђ▓} {funРіЉ unkРіЉ unkРіЉ} {V} {VРђ▓} Ріб­Юњ▒VVРђ▓ =
  Рібрхњ-sucP Ріб­Юњ▒VVРђ▓ ╬╗ ­Юњ▒VVРђ▓ Рєњ
  let (v , vРђ▓) = ­Юњ▒РЄњValue (РўЁ РЄњ РўЁ , AРђ▓ РЄњ BРђ▓ , funРіЉ unkРіЉ unkРіЉ) V VРђ▓ ­Юњ▒VVРђ▓ in
  substрхњ (РЅАрхњ-sym ­Юњ▒-dyn-fun) (constрхњI v ,рхњ (constрхњI vРђ▓ ,рхњ monoрхњ Ріб­Юњ▒VVРђ▓))

{----------- Relate Open Terms ------------------------------------------------}

­ЮЊќРЪд_РЪД : (╬Њ : List Prec) Рєњ Subst Рєњ Subst Рєњ List Setрхњ
­ЮЊќРЪд [] РЪД ¤Ѓ ¤ЃРђ▓ = []
­ЮЊќРЪд c Рѕи ╬Њ РЪД ¤Ѓ ¤ЃРђ▓ = (­Юњ▒РЪд c РЪД (¤Ѓ 0) (¤ЃРђ▓ 0))
                     Рѕи ­ЮЊќРЪд ╬Њ РЪД (╬╗ x Рєњ ¤Ѓ (suc x)) (╬╗ x Рєњ ¤ЃРђ▓ (suc x))

_Ріе_РіЉ_Рдѓ_ : List Prec Рєњ Term Рєњ Term Рєњ Prec Рєњ Set
╬Њ Ріе M РіЉ MРђ▓ Рдѓ c = Рѕђ (╬│ ╬│Рђ▓ : Subst) Рєњ ­ЮЊќРЪд ╬Њ РЪД ╬│ ╬│Рђ▓ Рібрхњ Рё░РЪд c РЪД (РЪф ╬│ РЪФ M) (РЪф ╬│Рђ▓ РЪФ MРђ▓)

{--------------- Related values are related expressions -----------------------}

­Юњ▒РЄњРё░ : Рѕђ{c : Prec}{­ЮњФ}{V VРђ▓}
   Рєњ ­ЮњФ Рібрхњ ­Юњ▒РЪд c РЪД V VРђ▓
     -----------------
   Рєњ ­ЮњФ Рібрхњ Рё░РЪд c РЪД V VРђ▓
­Юњ▒РЄњРё░ {c}{­ЮњФ}{V}{VРђ▓} Ріб­Юњ▒VVРђ▓ = substрхњ (РЅАрхњ-sym Рё░-stmt) (injРѓЂрхњ Ріб­Юњ▒VVРђ▓)

{--------------- Blame on the right -------------------------------------------}

Рё░-blame : Рѕђ{­ЮњФ}{c}{M} Рєњ ­ЮњФ Рібрхњ Рё░РЪд c РЪД M blame
Рё░-blame {­ЮњФ}{c}{M} = substрхњ (РЅАрхњ-sym Рё░-stmt)
                            (injРѓѓрхњ (injРѓѓрхњ (injРѓѓрхњ (constрхњI isBlame))))

