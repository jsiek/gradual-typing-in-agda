open import Relation.Nullary using (Â¬_; Dec; yes; no)
open import Relation.Binary.PropositionalEquality
  using (_â‰¡_; _â‰¢_; refl)
open import Data.Product using (_Ã—_; projâ‚; projâ‚‚; âˆƒ; âˆƒ-syntax) renaming (_,_ to âŸ¨_,_âŸ©)

open import Types
open import Variables
open import Labels
open import PreCastStructureWithPrecision



module ParamCCPrecision (pcsp : PreCastStructWithPrecision) where

open PreCastStructWithPrecision pcsp

open import ParamCastCalculus Cast Inert

{- The precision relation for the cast calculus. -}
infix 6 _,_âŠ¢_âŠ‘á¶œ_
{- The precision relation for substitution. -}
infix 6 _,_,_,_âŠ¢_âŠ‘Ë¢_

-- Term precision of CC.
data _,_âŠ¢_âŠ‘á¶œ_ : âˆ€ (Î“ Î“â€² : Context) â†’ {A Aâ€² : Type} â†’ Î“ âŠ¢ A â†’ Î“â€² âŠ¢ Aâ€² â†’ Set where

  âŠ‘á¶œ-prim : âˆ€ {Î“ Î“â€² A} {k : rep A} {i : Prim A}
      ------------------------------
    â†’ Î“ , Î“â€² âŠ¢ $_ {Î“} k {i} âŠ‘á¶œ $_ {Î“â€²} k {i}

  âŠ‘á¶œ-var : âˆ€ {Î“ Î“â€² A Aâ€²} {x : Î“ âˆ‹ A} {xâ€² : Î“â€² âˆ‹ Aâ€²}
    â†’ âˆ‹â†’â„• x â‰¡ âˆ‹â†’â„• xâ€²
      -----------------
    â†’ Î“ , Î“â€² âŠ¢ ` x âŠ‘á¶œ ` xâ€²

  âŠ‘á¶œ-Æ› : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {N : Î“ , A âŠ¢ B} {Nâ€² : Î“â€² , Aâ€² âŠ¢ Bâ€²}
    â†’ A âŠ‘ Aâ€²
    â†’ (Î“ , A) , (Î“â€² , Aâ€²) âŠ¢ N âŠ‘á¶œ Nâ€²
      ------------------------------
    â†’ Î“ , Î“â€² âŠ¢ Æ› N âŠ‘á¶œ Æ› Nâ€²

  âŠ‘á¶œ-Â· : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {L : Î“ âŠ¢ A â‡’ B} {Lâ€² : Î“â€² âŠ¢ Aâ€² â‡’ Bâ€²} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²}
    â†’ Î“ , Î“â€² âŠ¢ L âŠ‘á¶œ Lâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      --------------------------
    â†’ Î“ , Î“â€² âŠ¢ L Â· M âŠ‘á¶œ Lâ€² Â· Mâ€²

  âŠ‘á¶œ-if : âˆ€ {Î“ Î“â€² A Aâ€²} {L : Î“ âŠ¢ ` ğ”¹} {Lâ€² : Î“â€² âŠ¢ ` ğ”¹} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²} {N : Î“ âŠ¢ A} {Nâ€² : Î“â€² âŠ¢ Aâ€²}
    â†’ Î“ , Î“â€² âŠ¢ L âŠ‘á¶œ Lâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
    â†’ Î“ , Î“â€² âŠ¢ N âŠ‘á¶œ Nâ€²
      ---------------------------------
    â†’ Î“ , Î“â€² âŠ¢ if L M N âŠ‘á¶œ if Lâ€² Mâ€² Nâ€²

  âŠ‘á¶œ-cons : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²} {N : Î“ âŠ¢ B} {Nâ€² : Î“â€² âŠ¢ Bâ€²}
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
    â†’ Î“ , Î“â€² âŠ¢ N âŠ‘á¶œ Nâ€²
      --------------------------------
    â†’ Î“ , Î“â€² âŠ¢ cons M N âŠ‘á¶œ cons Mâ€² Nâ€²

  âŠ‘á¶œ-fst : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢ A `Ã— B} {Mâ€² : Î“â€² âŠ¢ Aâ€² `Ã— Bâ€²}
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      -------------------------
    â†’ Î“ , Î“â€² âŠ¢ fst M âŠ‘á¶œ fst Mâ€²

  âŠ‘á¶œ-snd : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢ A `Ã— B} {Mâ€² : Î“â€² âŠ¢ Aâ€² `Ã— Bâ€²}
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      -------------------------
    â†’ Î“ , Î“â€² âŠ¢ snd M âŠ‘á¶œ snd Mâ€²

  âŠ‘á¶œ-inl : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²}
    â†’ B âŠ‘ Bâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      ------------------------------------------
    â†’ Î“ , Î“â€² âŠ¢ inl {B = B} M âŠ‘á¶œ inl {B = Bâ€²} Mâ€²

  âŠ‘á¶œ-inr : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢ B} {Mâ€² : Î“â€² âŠ¢ Bâ€²}
    â†’ A âŠ‘ Aâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      ------------------------------------------
    â†’ Î“ , Î“â€² âŠ¢ inr {A = A} M âŠ‘á¶œ inr {A = Aâ€²} Mâ€²

  âŠ‘á¶œ-case : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€² C Câ€²} {L : Î“ âŠ¢ A `âŠ B} {Lâ€² : Î“â€² âŠ¢ Aâ€² `âŠ Bâ€²} {M : Î“ , A âŠ¢ C} {Mâ€² : Î“â€² , Aâ€² âŠ¢ Câ€²} {N : Î“ , B âŠ¢ C} {Nâ€² : Î“â€² , Bâ€² âŠ¢ Câ€²}
    â†’ Î“ , Î“â€² âŠ¢ L âŠ‘á¶œ Lâ€²
    â†’ A âŠ‘ Aâ€² â†’ B âŠ‘ Bâ€²
    â†’ (Î“ , A) , (Î“â€² , Aâ€²) âŠ¢ M âŠ‘á¶œ Mâ€²
    â†’ (Î“ , B) , (Î“â€² , Bâ€²) âŠ¢ N âŠ‘á¶œ Nâ€²
      -------------------------------------
    â†’ Î“ , Î“â€² âŠ¢ case L M N âŠ‘á¶œ case Lâ€² Mâ€² Nâ€²

  âŠ‘á¶œ-cast : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²} {c : Cast (A â‡’ B)} {câ€² : Cast (Aâ€² â‡’ Bâ€²)}
    â†’ A âŠ‘ Aâ€² â†’ B âŠ‘ Bâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      ------------------------------
    â†’ Î“ , Î“â€² âŠ¢ M âŸ¨ c âŸ© âŠ‘á¶œ Mâ€² âŸ¨ câ€² âŸ©

  âŠ‘á¶œ-castl : âˆ€ {Î“ Î“â€² A Aâ€² B} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²} {c : Cast (A â‡’ B)}
    â†’ A âŠ‘ Aâ€² â†’ B âŠ‘ Aâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      -----------------------
    â†’ Î“ , Î“â€² âŠ¢ M âŸ¨ c âŸ© âŠ‘á¶œ Mâ€²

  âŠ‘á¶œ-castr : âˆ€ {Î“ Î“â€² A Aâ€² Bâ€²} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²} {câ€² : Cast (Aâ€² â‡’ Bâ€²)}
    â†’ A âŠ‘ Aâ€² â†’ A âŠ‘ Bâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      ------------------------
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€² âŸ¨ câ€² âŸ©

  {- The cases below are for wrapped inert casts. -}
  âŠ‘á¶œ-wrap : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²}
              {c : Cast (A â‡’ B)} {câ€² : Cast (Aâ€² â‡’ Bâ€²)}
              {i : Inert c} {iâ€² : Inert câ€²}
    â†’ âŸª i âŸ«âŠ‘âŸª iâ€² âŸ«
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
    â†’ (B â‰¡ â‹† â†’ Bâ€² â‰¡ â‹†)
      ------------------------------
    â†’ Î“ , Î“â€² âŠ¢ M âŸª i âŸ« âŠ‘á¶œ Mâ€² âŸª iâ€² âŸ«

  âŠ‘á¶œ-wrapl : âˆ€ {Î“ Î“â€² A Aâ€² B} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²}
               {c : Cast (A â‡’ B)} {i : Inert c}
    â†’ âŸª i âŸ«âŠ‘ Aâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
    -- NOTE: Not sure if we need to require Value Mâ€² here.
      -----------------------
    â†’ Î“ , Î“â€² âŠ¢ M âŸª i âŸ« âŠ‘á¶œ Mâ€²

  âŠ‘á¶œ-wrapr : âˆ€ {Î“ Î“â€² A Aâ€² Bâ€²} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²}
               {câ€² : Cast (Aâ€² â‡’ Bâ€²)} {iâ€² : Inert câ€²}
    â†’ A âŠ‘âŸª iâ€² âŸ«
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
    â†’ A â‰¢ â‹†
      ------------------------
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€² âŸª iâ€² âŸ«

  âŠ‘á¶œ-blame : âˆ€ {Î“ Î“â€² A Aâ€²} {M : Î“ âŠ¢ A} {â„“}
    â†’ A âŠ‘ Aâ€²
      -------------------------------
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ blame {Î“â€²} {Aâ€²} â„“

data _,_,_,_âŠ¢_âŠ‘Ë¢_ : (Î“ Î” Î“â€² Î”â€² : Context) â†’ Subst Î“ Î” â†’ Subst Î“â€² Î”â€² â†’ Set where

  âŠ‘Ë¢-Ïƒâ‚€ : âˆ€ {Î” Î”â€² A Aâ€²} {M : Î” âŠ¢ A} {Mâ€² : Î”â€² âŠ¢ Aâ€²}
    â†’ Î” , Î”â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      ------------------------------------------
    â†’ (Î” , A) , Î” , (Î”â€² , Aâ€²) , Î”â€² âŠ¢ (subst-zero M) âŠ‘Ë¢ (subst-zero Mâ€²)

  âŠ‘Ë¢-exts : âˆ€ {Î“ Î“â€² Î” Î”â€² B Bâ€²} {Ïƒ : Subst Î“ Î”} {Ïƒâ€² : Subst Î“â€² Î”â€²}
    â†’ Î“ , Î” , Î“â€² , Î”â€² âŠ¢ Ïƒ âŠ‘Ë¢ Ïƒâ€²
      -------------------------------------------------------------------
    â†’ (Î“ ,  B) , (Î” , B) , (Î“â€² , Bâ€²) , (Î”â€² , Bâ€²) âŠ¢ (exts Ïƒ) âŠ‘Ë¢ (exts Ïƒâ€²)

-- Example(s):
_ : âˆ… , âˆ… âŠ¢ Æ›_ {B = â‹†} {â‹†} (` Z) âŠ‘á¶œ Æ›_ {B = ` Nat} {` Nat} (` Z)
_ = âŠ‘á¶œ-Æ› unkâŠ‘ (âŠ‘á¶œ-var refl)
