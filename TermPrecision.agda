open import Relation.Nullary using (Â¬_; Dec; yes; no)
open import Relation.Binary.PropositionalEquality
  using (_â‰¡_; _â‰¢_; refl)
open import Data.Product using (_Ã—_; projâ‚; projâ‚‚; Î£; Î£-syntax; âˆƒ; âˆƒ-syntax) renaming (_,_ to âŸ¨_,_âŸ©)

-- We're using simple cast with inert cross cast - at least for now.
open import GroundInertX using (Cast; Active; Inert)
open import Types
open import Variables
open import Labels

open import GTLC
import ParamCastCalculus
open ParamCastCalculus Cast Inert


infix 6 âŸª_âŸ«âŠ‘âŸª_âŸ«
infix 6 âŸª_âŸ«âŠ‘_
infix 6 _âŠ‘âŸª_âŸ«

data âŸª_âŸ«âŠ‘âŸª_âŸ« : âˆ€ {A Aâ€² B Bâ€²} â†’ {c : Cast (A â‡’ B)} â†’ {câ€² : Cast (Aâ€² â‡’ Bâ€²)}
                             â†’ (i : Inert c) â†’ (iâ€² : Inert câ€²) â†’ Set where

  -- Inert injections
  lpii-inj : âˆ€ {G} {c : Cast (G â‡’ â‹†)} {câ€² : Cast (G â‡’ â‹†)}
    â†’ (g : Ground G)
    â†’ âŸª Inert.I-inj g c âŸ«âŠ‘âŸª Inert.I-inj g câ€² âŸ«

  -- Inert cross casts
  lpii-fun : âˆ€ {A Aâ€² B Bâ€² C Câ€² D Dâ€²} {c : Cast ((A â‡’ B) â‡’ (C â‡’ D))} {câ€² : Cast ((Aâ€² â‡’ Bâ€²) â‡’ (Câ€² â‡’ Dâ€²))}
     â†’ A â‡’ B âŠ‘ Aâ€² â‡’ Bâ€²
     â†’ C â‡’ D âŠ‘ Câ€² â‡’ Dâ€²
       ----------------------------------------------------------------------
     â†’ âŸª Inert.I-fun c âŸ«âŠ‘âŸª Inert.I-fun câ€² âŸ«

  lpii-pair : âˆ€ {A Aâ€² B Bâ€² C Câ€² D Dâ€²} {c : Cast ((A `Ã— B) â‡’ (C `Ã— D))} {câ€² : Cast ((Aâ€² `Ã— Bâ€²) â‡’ (Câ€² `Ã— Dâ€²))}
     â†’ A `Ã— B âŠ‘ Aâ€² `Ã— Bâ€²
     â†’ C `Ã— D âŠ‘ Câ€² `Ã— Dâ€²
       ----------------------------------------------------------------------
     â†’ âŸª Inert.I-pair c âŸ«âŠ‘âŸª Inert.I-pair câ€² âŸ«

  lpii-sum : âˆ€ {A Aâ€² B Bâ€² C Câ€² D Dâ€²} {c : Cast ((A `âŠ B) â‡’ (C `âŠ D))} {câ€² : Cast ((Aâ€² `âŠ Bâ€²) â‡’ (Câ€² `âŠ Dâ€²))}
     â†’ A `âŠ B âŠ‘ Aâ€² `âŠ Bâ€²
     â†’ C `âŠ D âŠ‘ Câ€² `âŠ Dâ€²
       ----------------------------------------------------------------------
     â†’ âŸª Inert.I-sum c âŸ«âŠ‘âŸª Inert.I-sum câ€² âŸ«

{- Example : âŸ¨ â‹† â‡› â‹† âŸ© â‹¢ âŸ¨ A â†’ B â‡› C â†’ D âŸ© -}

private
  idâ‹†â‹¢fun : âˆ€ {A B C D} {c : Cast (â‹† â‡’ â‹†)} {câ€² : Cast ((A â‡’ B) â‡’ (C â‡’ D))}
    â†’ (i : Inert c) â†’ (iâ€² : Inert câ€²)
    â†’ Â¬ (âŸª i âŸ«âŠ‘âŸª iâ€² âŸ«)
  idâ‹†â‹¢fun (Inert.I-inj _ _) (Inert.I-fun _) ()

data âŸª_âŸ«âŠ‘_ : âˆ€ {A B} â†’ {c : Cast (A â‡’ B)} â†’ Inert c â†’ Type â†’ Set where

  -- Inert injections
  lpit-inj : âˆ€ {G Aâ€²} {c : Cast (G â‡’ â‹†)}
    â†’ (g : Ground G)
    â†’ G âŠ‘ Aâ€²
      -------------------------
    â†’ âŸª Inert.I-inj g c âŸ«âŠ‘ Aâ€²

  -- Inert cross casts
  lpit-fun : âˆ€ {A Aâ€² B Bâ€² C D} {c : Cast ((A â‡’ B) â‡’ (C â‡’ D))}
    â†’ A â‡’ B âŠ‘ Aâ€² â‡’ Bâ€²
    â†’ C â‡’ D âŠ‘ Aâ€² â‡’ Bâ€²
      ------------------------------------------
    â†’ âŸª Inert.I-fun c âŸ«âŠ‘ Aâ€² â‡’ Bâ€²

  lpit-pair : âˆ€ {A Aâ€² B Bâ€² C D} {c : Cast ((A `Ã— B) â‡’ (C `Ã— D))}
    â†’ A `Ã— B âŠ‘ Aâ€² `Ã— Bâ€²
    â†’ C `Ã— D âŠ‘ Aâ€² `Ã— Bâ€²
      ------------------------------------------
    â†’ âŸª Inert.I-pair c âŸ«âŠ‘ Aâ€² `Ã— Bâ€²

  lpit-sum : âˆ€ {A Aâ€² B Bâ€² C D} {c : Cast ((A `âŠ B) â‡’ (C `âŠ D))}
    â†’ A `âŠ B âŠ‘ Aâ€² `âŠ Bâ€²
    â†’ C `âŠ D âŠ‘ Aâ€² `âŠ Bâ€²
      ------------------------------------------
    â†’ âŸª Inert.I-sum c âŸ«âŠ‘ Aâ€² `âŠ Bâ€²

data _âŠ‘âŸª_âŸ« : âˆ€ {Aâ€² Bâ€²} â†’ {câ€² : Cast (Aâ€² â‡’ Bâ€²)} â†’ Type â†’ Inert câ€² â†’ Set where

  -- Inert cross casts
  lpti-fun : âˆ€ {A Aâ€² B Bâ€² Câ€² Dâ€²} {câ€² : Cast ((Aâ€² â‡’ Bâ€²) â‡’ (Câ€² â‡’ Dâ€²))}
    â†’ A â‡’ B âŠ‘ Aâ€² â‡’ Bâ€²
    â†’ A â‡’ B âŠ‘ Câ€² â‡’ Dâ€²
      ---------------------------------------------
    â†’ A â‡’ B âŠ‘âŸª Inert.I-fun câ€² âŸ«

  lpti-pair : âˆ€ {A Aâ€² B Bâ€² Câ€² Dâ€²} {câ€² : Cast ((Aâ€² `Ã— Bâ€²) â‡’ (Câ€² `Ã— Dâ€²))}
    â†’ A `Ã— B âŠ‘ Aâ€² `Ã— Bâ€²
    â†’ A `Ã— B âŠ‘ Câ€² `Ã— Dâ€²
      ----------------------------------------------
    â†’ A `Ã— B âŠ‘âŸª Inert.I-pair câ€² âŸ«

  lpti-sum : âˆ€ {A Aâ€² B Bâ€² Câ€² Dâ€²} {câ€² : Cast ((Aâ€² `âŠ Bâ€²) â‡’ (Câ€² `âŠ Dâ€²))}
    â†’ A `âŠ B âŠ‘ Aâ€² `âŠ Bâ€²
    â†’ A `âŠ B âŠ‘ Câ€² `âŠ Dâ€²
      ----------------------------------------------
    â†’ A `âŠ B âŠ‘âŸª Inert.I-sum câ€² âŸ«


infix 6 _,_âŠ¢_âŠ‘á´³_
infix 6 _,_âŠ¢_âŠ‘á¶œ_

-- Term precision for GTLC - Mâ‚ âŠ‘á´³ Mâ‚‚ means that Mâ‚‚ is *more precise* than Mâ‚ .
data _,_âŠ¢_âŠ‘á´³_ : âˆ€ (Î“ Î“â€² : Context) â†’ {A Aâ€² : Type} â†’ Î“ âŠ¢G A â†’ Î“â€² âŠ¢G Aâ€² â†’ Set where

  âŠ‘á´³-prim : âˆ€ {Î“ Î“â€² A} {k : rep A} {i : Prim A}
      ------------------------------
    â†’ Î“ , Î“â€² âŠ¢ $_ {Î“} k {i} âŠ‘á´³ $_ {Î“â€²} k {i}

  âŠ‘á´³-var : âˆ€ {Î“ Î“â€² A Aâ€²} {x : Î“ âˆ‹ A} {xâ€² : Î“â€² âˆ‹ Aâ€²}
    â†’ âˆ‹â†’â„• x â‰¡ âˆ‹â†’â„• xâ€²
      -----------------
    â†’ Î“ , Î“â€² âŠ¢ ` x âŠ‘á´³ ` xâ€²

  âŠ‘á´³-Æ› : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {N : Î“ , A âŠ¢G B} {Nâ€² : Î“â€² , Aâ€² âŠ¢G Bâ€²}
    â†’ A âŠ‘ Aâ€²
    â†’ (Î“ , A) , (Î“â€² , Aâ€²) âŠ¢ N âŠ‘á´³ Nâ€²
      ------------------------------
    â†’ Î“ , Î“â€² âŠ¢ Æ› A Ë™ N âŠ‘á´³ Æ› Aâ€² Ë™ Nâ€²

  âŠ‘á´³-Â· : âˆ€ {Î“ Î“â€² A Aâ€² Aâ‚ Aâ‚â€² Aâ‚‚ Aâ‚‚â€² B Bâ€²} {L : Î“ âŠ¢G A} {Lâ€² : Î“â€² âŠ¢G Aâ€²} {M : Î“ âŠ¢G B} {Mâ€² : Î“â€² âŠ¢G Bâ€²} {â„“ â„“â€²}
    â†’ Î“ , Î“â€² âŠ¢ L âŠ‘á´³ Lâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á´³ Mâ€²
    â†’ {m : A â–¹ Aâ‚ â‡’ Aâ‚‚} {cn : Aâ‚ ~ B} {mâ€² : Aâ€² â–¹ Aâ‚â€² â‡’ Aâ‚‚â€²} {cnâ€² : Aâ‚â€² ~ Bâ€²}
      --------------------------------------------------------------
    â†’ Î“ , Î“â€² âŠ¢ (L Â· M at â„“) {m} {cn} âŠ‘á´³ (Lâ€² Â· Mâ€² at â„“â€²) {mâ€²} {cnâ€²}

  âŠ‘á´³-if : âˆ€ {Î“ Î“â€² Aâ‚ Aâ‚â€² Aâ‚‚ Aâ‚‚â€² B Bâ€²} {L : Î“ âŠ¢G B} {Lâ€² : Î“â€² âŠ¢G Bâ€²} {M : Î“ âŠ¢G Aâ‚} {Mâ€² : Î“â€² âŠ¢G Aâ‚â€²} {N : Î“ âŠ¢G Aâ‚‚} {Nâ€² : Î“â€² âŠ¢G Aâ‚‚â€²} {â„“ â„“â€²}
    â†’ Î“ , Î“â€² âŠ¢ L âŠ‘á´³ Lâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á´³ Mâ€²
    â†’ Î“ , Î“â€² âŠ¢ N âŠ‘á´³ Nâ€²
    â†’ {bb : B ~ ` ğ”¹} {bbâ€² : Bâ€² ~ ` ğ”¹} {aa : Aâ‚ ~ Aâ‚‚} {aaâ€² : Aâ‚â€² ~ Aâ‚‚â€²}
      ------------------------------------------------------------------
    â†’ Î“ , Î“â€² âŠ¢ if L M N â„“ {bb} {aa} âŠ‘á´³ if Lâ€² Mâ€² Nâ€² â„“â€² {bbâ€²} {aaâ€²}

  âŠ‘á´³-cons : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢G A} {Mâ€² : Î“â€² âŠ¢G Aâ€²} {N : Î“ âŠ¢G B} {Nâ€² : Î“â€² âŠ¢G Bâ€²}
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á´³ Mâ€²
    â†’ Î“ , Î“â€² âŠ¢ N âŠ‘á´³ Nâ€²
      --------------------------------
    â†’ Î“ , Î“â€² âŠ¢ cons M N âŠ‘á´³ cons Mâ€² Nâ€²

  âŠ‘á´³-fst : âˆ€ {Î“ Î“â€² A Aâ€² Aâ‚ Aâ‚â€² Aâ‚‚ Aâ‚‚â€²} {M : Î“ âŠ¢G A} {Mâ€² : Î“â€² âŠ¢G Aâ€²} {â„“ â„“â€²}
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á´³ Mâ€²
    â†’ {m : A â–¹ Aâ‚ Ã— Aâ‚‚} {mâ€² : Aâ€² â–¹ Aâ‚â€² Ã— Aâ‚‚â€²}
      ------------------------------------------
    â†’ Î“ , Î“â€² âŠ¢ fst M â„“ {m} âŠ‘á´³ fst Mâ€² â„“â€² {mâ€²}

  âŠ‘á´³-snd : âˆ€ {Î“ Î“â€² A Aâ€² Aâ‚ Aâ‚â€² Aâ‚‚ Aâ‚‚â€²} {M : Î“ âŠ¢G A} {Mâ€² : Î“â€² âŠ¢G Aâ€²} {â„“ â„“â€²}
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á´³ Mâ€²
    â†’ {m : A â–¹ Aâ‚ Ã— Aâ‚‚} {mâ€² : Aâ€² â–¹ Aâ‚â€² Ã— Aâ‚‚â€²}
      ------------------------------------------
    â†’ Î“ , Î“â€² âŠ¢ snd M â„“ {m} âŠ‘á´³ snd Mâ€² â„“â€² {mâ€²}

  âŠ‘á´³-inl : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢G A} {Mâ€² : Î“â€² âŠ¢G Aâ€²}
    â†’ B âŠ‘ Bâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á´³ Mâ€²
      ------------------------------
    â†’ Î“ , Î“â€² âŠ¢ inl B M âŠ‘á´³ inl Bâ€² Mâ€²

  âŠ‘á´³-inr : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢G B} {Mâ€² : Î“â€² âŠ¢G Bâ€²}
    â†’ A âŠ‘ Aâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á´³ Mâ€²
      ------------------------------
    â†’ Î“ , Î“â€² âŠ¢ inr A M âŠ‘á´³ inr Aâ€² Mâ€²

  âŠ‘á´³-case : âˆ€ {Î“ Î“â€² A Aâ€² Aâ‚ Aâ‚â€² Aâ‚‚ Aâ‚‚â€² B Bâ€² Bâ‚ Bâ‚â€² Bâ‚‚ Bâ‚‚â€² C Câ€² Câ‚ Câ‚â€² Câ‚‚ Câ‚‚â€²}
              {L : Î“ âŠ¢G A} {Lâ€² : Î“â€² âŠ¢G Aâ€²} {M : Î“ âŠ¢G B} {Mâ€² : Î“â€² âŠ¢G Bâ€²} {N : Î“ âŠ¢G C} {Nâ€² : Î“â€² âŠ¢G Câ€²} {â„“ â„“â€²}
    â†’ Î“ , Î“â€² âŠ¢ L âŠ‘á´³ Lâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á´³ Mâ€²
    â†’ Î“ , Î“â€² âŠ¢ N âŠ‘á´³ Nâ€²
    â†’ {ma : A â–¹ Aâ‚ âŠ Aâ‚‚} {maâ€² : Aâ€² â–¹ Aâ‚â€² âŠ Aâ‚‚â€²} {mb : B â–¹ Bâ‚ â‡’ Bâ‚‚} {mbâ€² : Bâ€² â–¹ Bâ‚â€² â‡’ Bâ‚‚â€²} {mc : C â–¹ Câ‚ â‡’ Câ‚‚} {mcâ€² : Câ€² â–¹ Câ‚â€² â‡’ Câ‚‚â€²}
    â†’ {ab : Aâ‚ ~ Bâ‚} {abâ€² : Aâ‚â€² ~ Bâ‚â€²} {ac : Aâ‚‚ ~ Câ‚} {acâ€² : Aâ‚‚â€² ~ Câ‚â€²} {bc : Bâ‚‚ ~ Câ‚‚} {bcâ€² : Bâ‚‚â€² ~ Câ‚‚â€²}
      ------------------------------------------------------------------------------------------------------------
    â†’ Î“ , Î“â€² âŠ¢ case L M N â„“ {ma} {mb} {mc} {ab} {ac} {bc} âŠ‘á´³ case Lâ€² Mâ€² Nâ€² â„“â€² {maâ€²} {mbâ€²} {mcâ€²} {abâ€²} {acâ€²} {bcâ€²}


-- Term precision of CC.
data _,_âŠ¢_âŠ‘á¶œ_ : âˆ€ (Î“ Î“â€² : Context) â†’ {A Aâ€² : Type} â†’ Î“ âŠ¢ A â†’ Î“â€² âŠ¢ Aâ€² â†’ Set where

  âŠ‘á¶œ-prim : âˆ€ {Î“ Î“â€² A} {k : rep A} {i : Prim A}
      ------------------------------
    â†’ Î“ , Î“â€² âŠ¢ $_ {Î“} k {i} âŠ‘á¶œ $_ {Î“â€²} k {i}

  âŠ‘á´³-var : âˆ€ {Î“ Î“â€² A Aâ€²} {x : Î“ âˆ‹ A} {xâ€² : Î“â€² âˆ‹ Aâ€²}
    â†’ âˆ‹â†’â„• x â‰¡ âˆ‹â†’â„• xâ€²
      -----------------
    â†’ Î“ , Î“â€² âŠ¢ ` x âŠ‘á¶œ ` xâ€²

  âŠ‘á¶œ-Æ› : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {N : Î“ , A âŠ¢ B} {Nâ€² : Î“â€² , Aâ€² âŠ¢ Bâ€²}
    â†’ A âŠ‘ Aâ€²
    â†’ (Î“ , A) , (Î“â€² , Aâ€²) âŠ¢ N âŠ‘á¶œ Nâ€²
      ------------------------------
    â†’ Î“ , Î“â€² âŠ¢ Æ› N âŠ‘á¶œ Æ› Nâ€²

  âŠ‘á¶œ-Â· : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {L : Î“ âŠ¢ A â‡’ B} {Lâ€² : Î“â€² âŠ¢ Aâ€² â‡’ Bâ€²} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²}
    â†’ Î“ , Î“â€² âŠ¢ L âŠ‘á¶œ Lâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      --------------------------
    â†’ Î“ , Î“â€² âŠ¢ L Â· M âŠ‘á¶œ Lâ€² Â· Mâ€²

  âŠ‘á¶œ-if : âˆ€ {Î“ Î“â€² A Aâ€²} {L : Î“ âŠ¢ ` ğ”¹} {Lâ€² : Î“â€² âŠ¢ ` ğ”¹} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²} {N : Î“ âŠ¢ A} {Nâ€² : Î“â€² âŠ¢ Aâ€²}
    â†’ Î“ , Î“â€² âŠ¢ L âŠ‘á¶œ Lâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
    â†’ Î“ , Î“â€² âŠ¢ N âŠ‘á¶œ Nâ€²
      ---------------------------------
    â†’ Î“ , Î“â€² âŠ¢ if L M N âŠ‘á¶œ if Lâ€² Mâ€² Nâ€²

  âŠ‘á¶œ-cons : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²} {N : Î“ âŠ¢ B} {Nâ€² : Î“â€² âŠ¢ Bâ€²}
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
    â†’ Î“ , Î“â€² âŠ¢ N âŠ‘á¶œ Nâ€²
      --------------------------------
    â†’ Î“ , Î“â€² âŠ¢ cons M N âŠ‘á¶œ cons Mâ€² Nâ€²

  âŠ‘á¶œ-fst : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢ A `Ã— B} {Mâ€² : Î“â€² âŠ¢ Aâ€² `Ã— Bâ€²}
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      -------------------------
    â†’ Î“ , Î“â€² âŠ¢ fst M âŠ‘á¶œ fst Mâ€²

  âŠ‘á¶œ-snd : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢ A `Ã— B} {Mâ€² : Î“â€² âŠ¢ Aâ€² `Ã— Bâ€²}
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      -------------------------
    â†’ Î“ , Î“â€² âŠ¢ snd M âŠ‘á¶œ snd Mâ€²

  âŠ‘á¶œ-inl : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²}
    â†’ B âŠ‘ Bâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      ------------------------------------------
    â†’ Î“ , Î“â€² âŠ¢ inl {B = B} M âŠ‘á¶œ inl {B = Bâ€²} Mâ€²

  âŠ‘á¶œ-inr : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢ B} {Mâ€² : Î“â€² âŠ¢ Bâ€²}
    â†’ A âŠ‘ Aâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      ------------------------------------------
    â†’ Î“ , Î“â€² âŠ¢ inr {A = A} M âŠ‘á¶œ inr {A = Aâ€²} Mâ€²

  âŠ‘á¶œ-case : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€² C Câ€²} {L : Î“ âŠ¢ A `âŠ B} {Lâ€² : Î“â€² âŠ¢ Aâ€² `âŠ Bâ€²} {M : Î“ âŠ¢ A â‡’ C} {Mâ€² : Î“â€² âŠ¢ Aâ€² â‡’ Câ€²} {N : Î“ âŠ¢ B â‡’ C} {Nâ€² : Î“â€² âŠ¢ Bâ€² â‡’ Câ€²}
    â†’ Î“ , Î“â€² âŠ¢ L âŠ‘á¶œ Lâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
    â†’ Î“ , Î“â€² âŠ¢ N âŠ‘á¶œ Nâ€²
      -------------------------------------
    â†’ Î“ , Î“â€² âŠ¢ case L M N âŠ‘á¶œ case Lâ€² Mâ€² Nâ€²

  âŠ‘á¶œ-cast : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²} {c : Cast (A â‡’ B)} {câ€² : Cast (Aâ€² â‡’ Bâ€²)}
    â†’ A âŠ‘ Aâ€² â†’ B âŠ‘ Bâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      ------------------------------
    â†’ Î“ , Î“â€² âŠ¢ M âŸ¨ c âŸ© âŠ‘á¶œ Mâ€² âŸ¨ câ€² âŸ©

  âŠ‘á¶œ-castl : âˆ€ {Î“ Î“â€² A Aâ€² B} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²} {c : Cast (A â‡’ B)}
    â†’ A âŠ‘ Aâ€² â†’ B âŠ‘ Aâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      -----------------------
    â†’ Î“ , Î“â€² âŠ¢ M âŸ¨ c âŸ© âŠ‘á¶œ Mâ€²

  âŠ‘á¶œ-castr : âˆ€ {Î“ Î“â€² A Aâ€² Bâ€²} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²} {câ€² : Cast (Aâ€² â‡’ Bâ€²)}
    â†’ A âŠ‘ Aâ€² â†’ A âŠ‘ Bâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      ------------------------
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€² âŸ¨ câ€² âŸ©

  {- The cases below are for wrapped inert casts. -}
  âŠ‘á¶œ-wrap : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€²} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²}
              {c : Cast (A â‡’ B)} {câ€² : Cast (Aâ€² â‡’ Bâ€²)}
              {i : Inert c} {iâ€² : Inert câ€²}
    â†’ âŸª i âŸ«âŠ‘âŸª iâ€² âŸ«
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      ------------------------------
    â†’ Î“ , Î“â€² âŠ¢ M âŸª i âŸ« âŠ‘á¶œ Mâ€² âŸª iâ€² âŸ«

  âŠ‘á¶œ-wrapl : âˆ€ {Î“ Î“â€² A Aâ€² B} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²}
               {c : Cast (A â‡’ B)} {i : Inert c}
    â†’ âŸª i âŸ«âŠ‘ Aâ€²
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
    -- NOTE: Not sure if we need to require Value Mâ€² here.
      -----------------------
    â†’ Î“ , Î“â€² âŠ¢ M âŸª i âŸ« âŠ‘á¶œ Mâ€²

  âŠ‘á¶œ-wrapr : âˆ€ {Î“ Î“â€² A Aâ€² Bâ€²} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²}
               {câ€² : Cast (Aâ€² â‡’ Bâ€²)} {iâ€² : Inert câ€²}
    â†’ A âŠ‘âŸª iâ€² âŸ«
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
      ------------------------
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€² âŸª iâ€² âŸ«

  âŠ‘á¶œ-blame : âˆ€ {Î“ Î“â€² A Aâ€²} {M : Î“ âŠ¢ A} {â„“}
    â†’ A âŠ‘ Aâ€²
      -------------------------------
    â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ blame {Î“â€²} {Aâ€²} â„“


-- Similar to the example in Fig. 5, Refined Criteria.
_ : âˆ… , âˆ… âŠ¢ ((Æ› â‹† Ë™ (` Z)) Â· ($_ 42 {P-Base}) at pos 0) {matchâ‡’â‡’} {unk~L} âŠ‘á´³ ((Æ› (` Nat) Ë™ (` Z)) Â· ($_ 42 {P-Base}) at pos 0) {matchâ‡’â‡’} {base~}
_ = âŠ‘á´³-Â· (âŠ‘á´³-Æ› unkâŠ‘ (âŠ‘á´³-var refl)) âŠ‘á´³-prim

_ : âˆ… , âˆ… âŠ¢ Æ›_ {B = â‹†} {â‹†} (` Z) âŠ‘á¶œ Æ›_ {B = ` Nat} {` Nat} (` Z)
_ = âŠ‘á¶œ-Æ› unkâŠ‘ (âŠ‘á´³-var refl)

-- Lemmas
âŠ‘â†’lpit : âˆ€ {A B Aâ€²} {c : Cast (A â‡’ B)}
  â†’ (i : Inert c)
  â†’ A âŠ‘ Aâ€² â†’ B âŠ‘ Aâ€²
    ------------------
  â†’ âŸª i âŸ«âŠ‘ Aâ€²
âŠ‘â†’lpit (Inert.I-inj g _) lp1 lp2 = lpit-inj g lp1
âŠ‘â†’lpit (Inert.I-fun _) (funâŠ‘ lp1 lp3) (funâŠ‘ lp2 lp4) = lpit-fun (funâŠ‘ lp1 lp3) (funâŠ‘ lp2 lp4)
âŠ‘â†’lpit (Inert.I-pair _) (pairâŠ‘ lp1 lp3) (pairâŠ‘ lp2 lp4) = lpit-pair (pairâŠ‘ lp1 lp3) (pairâŠ‘ lp2 lp4)
âŠ‘â†’lpit (Inert.I-sum _) (sumâŠ‘ lp1 lp3) (sumâŠ‘ lp2 lp4) = lpit-sum (sumâŠ‘ lp1 lp3) (sumâŠ‘ lp2 lp4)

lpiiâ†’âŠ‘ : âˆ€ {A Aâ€² B Bâ€²} {c : Cast (A â‡’ B)} {câ€² : Cast (Aâ€² â‡’ Bâ€²)} {i : Inert c} {iâ€² : Inert câ€²}
  â†’ âŸª i âŸ«âŠ‘âŸª iâ€² âŸ«
    --------------------
  â†’ (A âŠ‘ Aâ€²) Ã— (B âŠ‘ Bâ€²)
lpiiâ†’âŠ‘ (lpii-inj g) = âŸ¨ ReflâŠ‘ , unkâŠ‘ âŸ©
lpiiâ†’âŠ‘ (lpii-fun lp1 lp2) = âŸ¨ lp1 , lp2 âŸ©
lpiiâ†’âŠ‘ (lpii-pair lp1 lp2) = âŸ¨ lp1 , lp2 âŸ©
lpiiâ†’âŠ‘ (lpii-sum lp1 lp2) = âŸ¨ lp1 , lp2 âŸ©

lpitâ†’âŠ‘ : âˆ€ {A Aâ€² B} {c : Cast (A â‡’ B)} {i : Inert c}
  â†’ âŸª i âŸ«âŠ‘ Aâ€²
    --------------------
  â†’ (A âŠ‘ Aâ€²) Ã— (B âŠ‘ Aâ€²)
lpitâ†’âŠ‘ (lpit-inj g lp) = âŸ¨ lp , unkâŠ‘ âŸ©
lpitâ†’âŠ‘ (lpit-fun lp1 lp2) = âŸ¨ lp1 , lp2 âŸ©
lpitâ†’âŠ‘ (lpit-pair lp1 lp2) = âŸ¨ lp1 , lp2 âŸ©
lpitâ†’âŠ‘ (lpit-sum lp1 lp2) = âŸ¨ lp1 , lp2 âŸ©

lptiâ†’âŠ‘ : âˆ€ {A Aâ€² Bâ€²} {câ€² : Cast (Aâ€² â‡’ Bâ€²)} {iâ€² : Inert câ€²}
  â†’ A âŠ‘âŸª iâ€² âŸ«
    --------------------
  â†’ (A âŠ‘ Aâ€²) Ã— (A âŠ‘ Bâ€²)
lptiâ†’âŠ‘ (lpti-fun lp1 lp2) = âŸ¨ lp1 , lp2 âŸ©
lptiâ†’âŠ‘ (lpti-pair lp1 lp2) = âŸ¨ lp1 , lp2 âŸ©
lptiâ†’âŠ‘ (lpti-sum lp1 lp2) = âŸ¨ lp1 , lp2 âŸ©

âŠ‘á¶œâ†’âŠ‘ : âˆ€ {Î“ Î“â€² A Aâ€²} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²}
  â†’ Î“ âŠ‘* Î“â€²
  â†’ Î“ , Î“â€² âŠ¢ M âŠ‘á¶œ Mâ€²
    -----------------
  â†’ A âŠ‘ Aâ€²
âŠ‘á¶œâ†’âŠ‘ lp* âŠ‘á¶œ-prim = ReflâŠ‘
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á´³-var eq) = âŠ‘*â†’âŠ‘ _ _ lp* eq
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á¶œ-Æ› lp lpN) = funâŠ‘ lp (âŠ‘á¶œâ†’âŠ‘ (âŠ‘*-, lp lp*) lpN)
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á¶œ-Â· lpL lpM) with âŠ‘á¶œâ†’âŠ‘ lp* lpL
... | (funâŠ‘ lp1 lp2) = lp2
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á¶œ-if lpL lpM lpN) = âŠ‘á¶œâ†’âŠ‘ lp* lpN
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á¶œ-cons lpM lpN) = pairâŠ‘ (âŠ‘á¶œâ†’âŠ‘ lp* lpM) (âŠ‘á¶œâ†’âŠ‘ lp* lpN)
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á¶œ-fst lpM) with âŠ‘á¶œâ†’âŠ‘ lp* lpM
... | (pairâŠ‘ lp1 lp2) = lp1
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á¶œ-snd lpM) with âŠ‘á¶œâ†’âŠ‘ lp* lpM
... | (pairâŠ‘ lp1 lp2) = lp2
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á¶œ-inl lp lpM) = sumâŠ‘ (âŠ‘á¶œâ†’âŠ‘ lp* lpM) lp
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á¶œ-inr lp lpM) = sumâŠ‘ lp (âŠ‘á¶œâ†’âŠ‘ lp* lpM)
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á¶œ-case lpL lpM lpN) with âŠ‘á¶œâ†’âŠ‘ lp* lpM
... | (funâŠ‘ lp1 lp2) = lp2
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á¶œ-cast lp1 lp2 lpM) = lp2
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á¶œ-castl lp1 lp2 lpM) = lp2
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á¶œ-castr lp1 lp2 lpM) = lp2
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á¶œ-wrap lpi lpM) = projâ‚‚ (lpiiâ†’âŠ‘ lpi)
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á¶œ-wrapl lpi lpM) = projâ‚‚ (lpitâ†’âŠ‘ lpi)
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á¶œ-wrapr lpi lpM) = projâ‚‚ (lptiâ†’âŠ‘ lpi)
âŠ‘á¶œâ†’âŠ‘ lp* (âŠ‘á¶œ-blame lp) = lp
