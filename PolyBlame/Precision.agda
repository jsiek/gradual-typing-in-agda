{-# OPTIONS --rewriting #-}

module PolyBlame.Precision where

import Relation.Binary.PropositionalEquality as Eq
open Eq using (_â‰¡_; _â‰¢_; refl; cong; congâ‚‚; sym)
open import Data.Nat using (â„•; zero; suc; _<_; _â‰¤?_; zâ‰¤n; sâ‰¤s)
open import Data.Nat.Properties using (suc-injective)
open import Data.List hiding ([_])
open import Data.List.Properties using (map-âˆ˜)
open import Data.Empty using (âŠ¥; âŠ¥-elim)
open import Data.Unit using (âŠ¤)
open import Data.Product hiding (map)
open import Data.Maybe hiding (map)
open import Function using (_âˆ˜_)
open import Relation.Nullary using (Dec; yes; no)
open import Agda.Builtin.Bool

open import Agda.Builtin.Equality
open import Agda.Builtin.Equality.Rewrite

open import PolyBlame.Types
open import PolyBlame.TypePrecision
open import PolyBlame.Variables
open import PolyBlame.Terms
open import PolyBlame.Coercions
open import PolyBlame.ConsistentSubtyping
open import PolyBlame.Gradual
open import PolyBlame.Compile

postulate
  subáµ—-prec : âˆ€{Î”}{Î£ : BindCtx Î”}{A B : Type (Î” ,typ)}{X}
    â†’ (Î” ,typ) âˆ£ â¤Š Î£ âŠ¢ A âŠ‘ B
    â†’ Î” âˆ£ Î£ âŠ¢ A [ X ]áµ— âŠ‘ (B [ X ]áµ—)

{-
  Coercion less precise than a type
  (Replace this with coercion less precise than an id coercion.)
 -}
infix 3 _âˆ£_âŠ©_âŠ‘_
data _âˆ£_âŠ©_âŠ‘_ : âˆ€(Î” : TyCtx)(Î£ : BindCtx Î”){A B : Type Î”}
  â†’ (Î” âˆ£ Î£ âŠ¢ A â‡’ B) â†’ (Type Î”)
  â†’  Set  where

  id-âŠ‘ : âˆ€{Î”}{Î£}{A : Type Î”}
      ------------------------
     â†’ Î” âˆ£ Î£ âŠ©  id{A = A}  âŠ‘ A

  â†¦-âŠ‘ : âˆ€{Î”}{Î£}{A B C D E F : Type Î”}
       {c : Î” âˆ£ Î£ âŠ¢ C â‡’ A }
       {d : Î” âˆ£ Î£ âŠ¢ B â‡’ D }
     â†’ Î” âˆ£ Î£ âŠ© c âŠ‘ E
     â†’ Î” âˆ£ Î£ âŠ© d âŠ‘ F
       --------------------------
     â†’ Î” âˆ£ Î£ âŠ© (c â†¦ d) âŠ‘ (E â‡’ F)

  â¨Ÿ-âŠ‘ : âˆ€{Î”}{Î£}{A B C D : Type Î”}
       {c : Î” âˆ£ Î£ âŠ¢ A â‡’ B }
       {d : Î” âˆ£ Î£ âŠ¢ B â‡’ C }
     â†’ Î” âˆ£ Î£ âŠ© c âŠ‘ D
     â†’ Î” âˆ£ Î£ âŠ© d âŠ‘ D
       --------------------------
     â†’ Î” âˆ£ Î£ âŠ© (c â¨Ÿ d) âŠ‘ D

  !-âŠ‘ : âˆ€{Î”}{Î£}{B : Type Î”}{G : Grnd Î”}
     â†’ Î” âˆ£ Î£ âŠ¢ âŒˆ G âŒ‰ âŠ‘ B
      ---------------------
     â†’ Î” âˆ£ Î£ âŠ© (G !) âŠ‘ B

  ?-âŠ‘ : âˆ€{Î”}{Î£}{B : Type Î”}{G : Grnd Î”}
     â†’ Î” âˆ£ Î£ âŠ¢ âŒˆ G âŒ‰ âŠ‘ B
      ---------------------
     â†’ Î” âˆ£ Î£ âŠ© (G `?) âŠ‘ B


-- â˜…-âŠ‘-FV-âŠ† : âˆ€{Î”}{Î¨ : SubCtx Î”}{A : Type Î”}
--   â†’ Î” âˆ£ Î¨ âŠ¢ â˜… âŠ‘ A
--   â†’ FV A âŠ† Î¨
-- â˜…-âŠ‘-FV-âŠ† {Î”} {Î¨} {A} â˜…âŠ‘â˜… = mt-âŠ†
-- â˜…-âŠ‘-FV-âŠ† {Î”} {Î¨} {A} (â˜…âŠ‘X âˆ‹X) = âˆ‹-single-âŠ† âˆ‹X
-- â˜…-âŠ‘-FV-âŠ† {Î”} {Î¨} {A} â˜…âŠ‘â„• = mt-âŠ†
-- â˜…-âŠ‘-FV-âŠ† {Î”} {Î¨} {A â‡’ B} (â˜…âŠ‘â‡’ â˜…âŠ‘A â˜…âŠ‘B) =
--   let IH1 = â˜…-âŠ‘-FV-âŠ† â˜…âŠ‘A in
--   let IH2 = â˜…-âŠ‘-FV-âŠ† â˜…âŠ‘B in
--   âŠ†-âˆª IH1 IH2
-- â˜…-âŠ‘-FV-âŠ† {Î”} {Î¨} {A} (âŠ‘âˆ€ â˜…âŠ‘A) = âŠ†-â¤‹ (â˜…-âŠ‘-FV-âŠ† â˜…âŠ‘A)

-- â˜…â‡’â˜…-âŠ‘-FV-âŠ† : âˆ€{Î”}{Î¨ : SubCtx Î”}{A : Type Î”}
--   â†’ Î” âˆ£ Î¨ âŠ¢ (â˜… â‡’ â˜…) âŠ‘ A
--   â†’ FV A âŠ† Î¨
-- â˜…â‡’â˜…-âŠ‘-FV-âŠ† {Î”} {Î¨} {A â‡’ B} (â‡’âŠ‘â‡’ â˜…âŠ‘A â˜…âŠ‘B) =
--   âŠ†-âˆª (â˜…-âŠ‘-FV-âŠ† â˜…âŠ‘A) (â˜…-âŠ‘-FV-âŠ† â˜…âŠ‘B)
-- â˜…â‡’â˜…-âŠ‘-FV-âŠ† {Î”} {Î¨} {`âˆ€ A} (âŠ‘âˆ€ â˜…â‡’â˜…âŠ‘A) =
--   âŠ†-â¤‹ (â˜…â‡’â˜…-âŠ‘-FV-âŠ† â˜…â‡’â˜…âŠ‘A)

-- â˜…â‡’â˜…-âŠ‘ : âˆ€{Î”}{Î¨ : SubCtx Î”}{A : Type Î”}
--   â†’ Î” âˆ£ Î¨ âŠ¢ (â˜… â‡’ â˜…) âŠ‘ A
--   â†’ Î£[ Aâ‚ âˆˆ Type Î” ] Î£[ Aâ‚‚ âˆˆ Type Î” ]
--     Î” âˆ£ Î¨ âŠ¢ â˜… âŠ‘ Aâ‚  Ã—  Î” âˆ£ Î¨ âŠ¢ â˜… âŠ‘ Aâ‚‚
-- â˜…â‡’â˜…-âŠ‘ {Î”} {Î¨} {A} (â‡’âŠ‘â‡’ â˜…âŠ‘C â˜…âŠ‘D) = _ , _ , â˜…âŠ‘C , â˜…âŠ‘D
-- â˜…â‡’â˜…-âŠ‘ {Î”} {Î¨} {A} (âŠ‘âˆ€ â˜…â‡’â˜…âŠ‘A) = â˜… , â˜… , â˜…âŠ‘â˜… , â˜…âŠ‘â˜…

-- â„•-âŠ‘-FV : âˆ€{Î”}{Î¨ : SubCtx Î”}{A : Type Î”}
--   â†’ Î” âˆ£ Î¨ âŠ¢ `â„• âŠ‘ A
--   â†’ FV A âŠ† mt Î”
-- â„•-âŠ‘-FV {Î”} {Î¨} {`â„•} â„•âŠ‘A = mt-âŠ†
-- â„•-âŠ‘-FV {Î”} {Î¨} {`âˆ€ A} (âŠ‘âˆ€ â„•âŠ‘A) = âŠ†-â¤‹ (â„•-âŠ‘-FV â„•âŠ‘A)

{-
â‡’-âŠ‘-âŠ‘ : âˆ€{Î”}{Î£ : BindCtx Î”}{A B C : Type Î”}
    (c : Î” âˆ£ Î£ âŠ¢ A â‡’ B)
  â†’ Î” âˆ£ Î£ âŠ© c âŠ‘ C
  â†’ Î” âˆ£ mt Î” âŠ¢ A âŠ‘ C  Ã—  Î” âˆ£ mt Î” âŠ¢ B âŠ‘ C
â‡’-âŠ‘-âŠ‘ {Î”} {Î£} {A} {B} c id-âŠ‘ = ReflâŠ‘ A , ReflâŠ‘ A
â‡’-âŠ‘-âŠ‘ {Î”} {Î£} {Aâ‚ â‡’ Aâ‚‚} {Bâ‚ â‡’ Bâ‚‚} {Câ‚ â‡’ Câ‚‚} (c â†¦ d) (â†¦-âŠ‘ câŠ‘Câ‚ dâŠ‘Câ‚‚) =
    (â‡’âŠ‘â‡’ (â‡’-âŠ‘-âŠ‘ c câŠ‘Câ‚ .projâ‚‚) (â‡’-âŠ‘-âŠ‘ d dâŠ‘Câ‚‚ .projâ‚))
  , (â‡’âŠ‘â‡’ (â‡’-âŠ‘-âŠ‘ c câŠ‘Câ‚ .projâ‚) (â‡’-âŠ‘-âŠ‘ d dâŠ‘Câ‚‚ .projâ‚‚))
â‡’-âŠ‘-âŠ‘ {Î”} {Î£} {A} {B} (c â¨Ÿ d) (â¨Ÿ-âŠ‘ câŠ‘C câŠ‘Câ‚) =
  â‡’-âŠ‘-âŠ‘ c câŠ‘C .projâ‚ , â‡’-âŠ‘-âŠ‘ d câŠ‘Câ‚ .projâ‚‚
â‡’-âŠ‘-âŠ‘ {Î”} {Î£} {A} {B} (â˜…â‡’â˜… !) (!-âŠ‘ (â‡’âŠ‘â‡’ x y)) = â‡’âŠ‘â‡’ x y , â˜…âŠ‘â‡’ x y
â‡’-âŠ‘-âŠ‘ {Î”} {Î£} {A} {â˜…} (â˜…â‡’â˜… !) (!-âŠ‘ (âŠ‘âˆ€{B = Bâ€²} â˜…â‡’â˜…âŠ‘Bâ€²)) =
  let FVB = â˜…â‡’â˜…-âŠ‘-FV-âŠ† â˜…â‡’â˜…âŠ‘Bâ€² in
  let â¤‹FVB = âŠ†-â¤‹ FVB in
  (âŠ‘âˆ€ â˜…â‡’â˜…âŠ‘Bâ€²) , (â˜…-âŠ‘ (`âˆ€ _) â¤‹FVB)
â‡’-âŠ‘-âŠ‘ {Î”} {Î£} {A} {B} {C} (`â„• !) (!-âŠ‘ â„•âŠ‘C) = â„•âŠ‘C , (â˜…-âŠ‘ C (â„•-âŠ‘-FV â„•âŠ‘C))
â‡’-âŠ‘-âŠ‘ {Î”} {Î£} {A} {B} {C} ((` X) !) (!-âŠ‘ XâŠ‘C) = XâŠ‘C , {!!}
  {-

    X  âŠ‘   C
    !
    â˜…  âŠ‘  C

   -}
â‡’-âŠ‘-âŠ‘ {Î”} {Î£} {A} {B} {C} c (?-âŠ‘ x) = {!!}
-}

infix 3 _âˆ£_âˆ£_âŠ©_âŠ‘_â¦‚_
data _âˆ£_âˆ£_âŠ©_âŠ‘_â¦‚_ : âˆ€{Î”}(Î£ Î£â€² : BindCtx Î”){A B : Type Î”}{Î“ Î“â€² : Ctx Î”}
  â†’ PrecCtx Î£â€² Î“ Î“â€² â†’ (Î” âˆ£ Î£ âˆ£ Î“ âŠ¢ A) â†’ (Î” âˆ£ Î£â€² âˆ£ Î“â€² âŠ¢ B)
  â†’ Î” âˆ£ Î£â€² âŠ¢ A âŠ‘ B â†’ Set  where
  
  âŠ‘-var : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{A B}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î£â€² Î“ Î“â€²}
     â†’ (x : âŠ¢ Î¦ âˆ‹ A âŠ‘ B)
       ---------------------------------------------------------
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© (` proj-left x) âŠ‘ (` proj-right x) â¦‚ get-âŠ‘ x

  âŠ‘-nat : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î£â€² Î“ Î“â€²}{k : â„•}
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© (# k) âŠ‘ (# k) â¦‚ â„•âŠ‘â„•

  âŠ‘-lam : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î£â€² Î“ Î“â€²}
      {A B C D : Type Î”}{N : Î” âˆ£ Î£ âˆ£ (Î“ â–· A) âŠ¢ B} {Nâ€² : Î” âˆ£ Î£â€² âˆ£ (Î“â€² â–· C) âŠ¢ D}
      {c : Î” âˆ£ Î£â€² âŠ¢ A âŠ‘ C}{d : Î” âˆ£ Î£â€² âŠ¢ B âŠ‘ D}
     â†’ Î£ âˆ£ Î£â€² âˆ£ (Î¦ , c) âŠ© N âŠ‘ Nâ€² â¦‚ d
       ---------------------------------
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© Æ› N âŠ‘ Æ› Nâ€² â¦‚ â‡’âŠ‘â‡’ c d
  
  âŠ‘-app : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î£â€² Î“ Î“â€²}
       {A B C D : Type Î”}
       {L : Î” âˆ£ Î£ âˆ£ Î“ âŠ¢ A â‡’ B}    {M : Î” âˆ£ Î£ âˆ£ Î“ âŠ¢ A}
       {Lâ€² : Î” âˆ£ Î£â€² âˆ£ Î“â€² âŠ¢ C â‡’ D} {Mâ€² : Î” âˆ£ Î£â€² âˆ£ Î“â€² âŠ¢ C}
       {c : Î” âˆ£ Î£â€² âŠ¢ A âŠ‘ C}
       {d : Î” âˆ£ Î£â€² âŠ¢ B âŠ‘ D}
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© L âŠ‘ Lâ€² â¦‚ (â‡’âŠ‘â‡’ c d)
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© M âŠ‘ Mâ€² â¦‚ c
       --------------------------------
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© L Â· M âŠ‘ Lâ€² Â· Mâ€² â¦‚ d
  
  âŠ‘-Î› : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î£â€² Î“ Î“â€²}
      {A B : Type (Î” ,typ)}{N : (Î” ,typ) âˆ£ â¤Š Î£ âˆ£ âŸ° Î“ âŠ¢ A}
      {Nâ€² : (Î” ,typ) âˆ£ â¤Š Î£â€² âˆ£ âŸ° Î“â€² âŠ¢ B}
      {c : (Î” ,typ) âˆ£ â¤Š Î£â€² âŠ¢ A âŠ‘ B}
     â†’ â¤Š Î£ âˆ£ â¤Š Î£â€² âˆ£ âŸ°áµ– Î¦ âŠ© N âŠ‘ Nâ€² â¦‚ c
       --------------------------------
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© Î› N âŠ‘ Î› Nâ€² â¦‚ âˆ€âŠ‘âˆ€ c
      
  âŠ‘-â—¯ : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î£â€² Î“ Î“â€²}
        {A B : Type (Î” ,typ)}{M : Î” âˆ£ Î£ âˆ£ Î“ âŠ¢ `âˆ€ A}
        {Mâ€² : Î” âˆ£ Î£â€²  âˆ£ Î“â€² âŠ¢ `âˆ€ B}{X}
        {p : (Î” ,typ) âˆ£ â¤Š Î£â€² âŠ¢ A âŠ‘ B}
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© M âŠ‘ Mâ€² â¦‚ âˆ€âŠ‘âˆ€ p
       ----------------------------------------------
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© (M â—¯ X) âŠ‘ (Mâ€² â—¯ X) â¦‚ subáµ—-prec p

  âŠ‘-blame : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î£â€² Î“ Î“â€²}
        {A : Type Î”}{M : Î” âˆ£ Î£ âˆ£ Î“ âŠ¢ A}{M : Î” âˆ£ Î£ âˆ£ Î“ âŠ¢ A}
       --------------------------------
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© M âŠ‘ blame â¦‚ ReflâŠ‘ A

  âŠ‘-âŸ¨âŸ© : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î£â€² Î“ Î“â€²}
        {A B Aâ€² Bâ€² : Type Î”}
        {M : Î” âˆ£ Î£ âˆ£ Î“ âŠ¢ A} {c : Î” âˆ£ Î£ âŠ¢ A â‡’ B}
        {Mâ€² : Î” âˆ£ Î£â€²  âˆ£ Î“â€² âŠ¢ Aâ€²} {câ€² : Î” âˆ£ Î£â€² âŠ¢ Aâ€² â‡’ Bâ€²}
        {AâŠ‘Aâ€² : Î” âˆ£ Î£â€² âŠ¢ A âŠ‘ Aâ€²}
        {BâŠ‘Bâ€² : Î” âˆ£ Î£â€² âŠ¢ B âŠ‘ Bâ€²}
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© M âŠ‘ Mâ€² â¦‚ AâŠ‘Aâ€²
     â†’ Î” âˆ£ Î£ âˆ£ Î£â€² âŠ© c âŠ‘ câ€²
       ----------------------------------------
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© M âŸ¨ c âŸ© âŠ‘ Mâ€² âŸ¨ câ€² âŸ© â¦‚ BâŠ‘Bâ€²
     
{-
  âŠ‘-âŸ¨âŸ©-L : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î£â€² Î“ Î“â€²}
        {A B C : Type Î”}
        {M : Î” âˆ£ Î£ âˆ£ Î“ âŠ¢ A}
        {c : Î” âˆ£ Î£ âŠ¢ A â‡’ B}
        {p : Î” âˆ£ Î£â€² âŠ¢ A âŠ‘ C}
        {Mâ€² : Î” âˆ£ Î£â€²  âˆ£ Î“â€² âŠ¢ C}
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© M âŠ‘ Mâ€² â¦‚ p
     â†’ Î” âˆ£ Î£ âŠ© c âŠ‘ C
       ----------------------------------------------
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© M âŸ¨ c âŸ© âŠ‘ Mâ€² â¦‚ {!!}
  
-}

âµâ‡’-âŠ‘-âµâ‡’ : âˆ€{Î”}{Î£ : BindCtx Î”} {A B C Aâ€² Bâ€² Câ€² : Type Î”}
  â†’ (Î” âˆ£ Î£ âŠ¢ C âŠ‘ Câ€²)
  â†’ (f : Î” âŠ¢ C âµ (A â‡’ B))
  â†’ (fâ€² : Î” âŠ¢ Câ€² âµ (Aâ€² â‡’ Bâ€²))
  â†’ Î” âˆ£ [] âˆ£ [] âŠ© (âµ-â‡’ f) âŠ‘ (âµ-â‡’ fâ€²)
âµâ‡’-âŠ‘-âµâ‡’ cc âµ-â‡’-â‡’ âµ-â‡’-â‡’ = id-âŠ‘ cc
âµâ‡’-âŠ‘-âµâ‡’ (â˜…âŠ‘â‡’ â˜…âŠ‘Aâ€² â˜…âŠ‘Bâ€²) âµ-â˜…-â‡’ âµ-â‡’-â‡’ = ?-âŠ‘-id (â‡’âŠ‘â‡’ â˜…âŠ‘Aâ€² â˜…âŠ‘Bâ€²)
âµâ‡’-âŠ‘-âµâ‡’ cc âµ-â˜…-â‡’ âµ-â˜…-â‡’ = ?-âŠ‘

âŠ‘-âµ-âµ-âŠ‘ : âˆ€{Î”}{Î£ : BindCtx Î”} {A B C Aâ€² Bâ€² Câ€² : Type Î”}
  â†’ (Î” âˆ£ Î£ âŠ¢ C âŠ‘ Câ€²)
  â†’ (Î” âŠ¢ C âµ (A â‡’ B))
  â†’ (Î” âŠ¢ Câ€² âµ (Aâ€² â‡’ Bâ€²))
  â†’ Î” âˆ£ Î£ âŠ¢ A âŠ‘ Aâ€²
âŠ‘-âµ-âµ-âŠ‘ (â‡’âŠ‘â‡’ cc dd) âµ-â‡’-â‡’ âµ-â‡’-â‡’ = cc
âŠ‘-âµ-âµ-âŠ‘ (â˜…âŠ‘â‡’ cc dd) âµ-â˜…-â‡’ âµ-â‡’-â‡’ = cc
âŠ‘-âµ-âµ-âŠ‘ â˜…âŠ‘â˜… âµ-â˜…-â‡’ âµ-â˜…-â‡’ = â˜…âŠ‘â˜…

-- idâ˜…-âŠ‘-â‰²â‡’ : âˆ€ {Î”}{Î£ Î£â€² : BindCtx Î”} {B : Type Î”}
--   â†’ (Î” âˆ£ Î£â€² âŠ¢ â˜… âŠ‘ B)
--   â†’ (ab : Î” âˆ£ Î£â€² âŠ¢ â˜… â‰² B)
--   â†’ Î” âˆ£ Î£ âˆ£ Î£â€² âŠ© id{A = â˜…} âŠ‘ â‰²-â‡’ Î£â€² ab
  
-- idâ˜…-âŠ‘-â‰²â‡’ {B = `â„•} âŠ‘B â˜…â‰²â„• = id-âŠ‘-? âŠ‘B
-- idâ˜…-âŠ‘-â‰²â‡’ {B = â˜…} âŠ‘B â˜…â‰²â˜… = id-âŠ‘ âŠ‘B
-- idâ˜…-âŠ‘-â‰²â‡’ {B = ` x} âŠ‘B (â˜…â‰²X xâ‚) = id-âŠ‘-? âŠ‘B
-- idâ˜…-âŠ‘-â‰²â‡’ {Î£ = Î£}{B = B â‡’ Bâ‚} (â˜…âŠ‘â‡’ âŠ‘B âŠ‘Bâ‚) (â˜…â‰²â‡’ â‰²B â‰²Bâ‚) = 
--   âŠ‘-â¨Ÿ (id-âŠ‘-?{Î£ = Î£} (â˜…âŠ‘â‡’ â˜…âŠ‘â˜… â˜…âŠ‘â˜…))
--       (idâ˜…-âŠ‘-â†¦{A = B}{B = B} (idâ˜…-âŠ‘-â‰²â‡’ âŠ‘B â‰²B)
--        (idâ˜…-âŠ‘-â‰²â‡’ âŠ‘Bâ‚ â‰²Bâ‚))
-- idâ˜…-âŠ‘-â‰²â‡’ {B = `âˆ€ B} (âŠ‘âˆ€ âŠ‘B) (â‰²âˆ€ â‰²B) = idâ˜…-âŠ‘-ð’¢ (idâ˜…-âŠ‘-â‰²â‡’ âŠ‘B â‰²B)

-- id-âŠ‘-â‰²â‡’ : âˆ€ {Î”}{Î£ : BindCtx Î”} {C Aâ€² Bâ€² : Type Î”}
--   â†’ (Î” âˆ£ Î£ âŠ¢ C âŠ‘ Aâ€²)
--   â†’ (Î” âˆ£ Î£ âŠ¢ C âŠ‘ Bâ€²)
--   â†’ (ab : Î” âˆ£ Î£ âŠ¢ Aâ€² â‰² Bâ€²)
--   â†’ Î” âˆ£ [] âˆ£ [] âŠ© id{A = C} âŠ‘ â‰²-â‡’ ab []
-- id-âŠ‘-â‰²â‡’ ca cb â„•â‰²â„• = id-âŠ‘ ca
-- id-âŠ‘-â‰²â‡’ ca cb Xâ‰²X = id-âŠ‘ ca
-- id-âŠ‘-â‰²â‡’ ca cb â˜…â‰²â˜… = id-âŠ‘ ca
-- id-âŠ‘-â‰²â‡’ â˜…âŠ‘â˜… cb (â˜…â‰²X x) = id-âŠ‘-? cb
-- id-âŠ‘-â‰²â‡’ (â˜…âŠ‘X xâ‚) cb (Xâ‰²â˜… x) = id-âŠ‘-! (â˜…âŠ‘X xâ‚)
-- id-âŠ‘-â‰²â‡’ â˜…âŠ‘â˜… cb â˜…â‰²â„• = id-âŠ‘-? cb
-- id-âŠ‘-â‰²â‡’ â˜…âŠ‘â„• cb â„•â‰²â˜… = id-âŠ‘-! â˜…âŠ‘â„•
-- id-âŠ‘-â‰²â‡’ (â˜…âŠ‘â‡’ ca caâ‚) â˜…âŠ‘â˜… (â‡’â‰²â˜… ab abâ‚) =
--   âŠ‘-â¨Ÿ (idâ˜…-âŠ‘-â†¦ (id-âŠ‘-â‰²â‡’ ca â˜…âŠ‘â˜… ab)
--                 (id-âŠ‘-â‰²â‡’ caâ‚ â˜…âŠ‘â˜… abâ‚))
--       (id-âŠ‘-! (â˜…âŠ‘â‡’ â˜…âŠ‘â˜… â˜…âŠ‘â˜…))
-- id-âŠ‘-â‰²â‡’ â˜…âŠ‘â˜… (â˜…âŠ‘â‡’ cb cbâ‚) (â˜…â‰²â‡’ ab abâ‚) =
--   âŠ‘-â¨Ÿ (id-âŠ‘-? (â˜…âŠ‘â‡’ â˜…âŠ‘â˜… â˜…âŠ‘â˜…))
--       (idâ˜…-âŠ‘-â†¦ (idâ˜…-âŠ‘-â‰²â‡’ cb ab) (idâ˜…-âŠ‘-â‰²â‡’ cbâ‚ abâ‚))
-- id-âŠ‘-â‰²â‡’ (â˜…âŠ‘â‡’ ca caâ‚) (â˜…âŠ‘â‡’ cb cbâ‚) (â‡’â‰²â‡’ ab abâ‚) =
--   idâ˜…-âŠ‘-â†¦ (id-âŠ‘-â‰²â‡’ ca cb ab) (id-âŠ‘-â‰²â‡’ caâ‚ cbâ‚ abâ‚)
-- id-âŠ‘-â‰²â‡’ (â‡’âŠ‘â‡’ ca caâ‚) (â‡’âŠ‘â‡’ cb cbâ‚) (â‡’â‰²â‡’ ab abâ‚) =
--   id-âŠ‘-â†¦ (id-âŠ‘-â‰²â‡’ ca cb ab) (id-âŠ‘-â‰²â‡’ caâ‚ cbâ‚ abâ‚)
-- id-âŠ‘-â‰²â‡’ ca cb (âˆ€â‰²âˆ€ ab) = {!!}
-- id-âŠ‘-â‰²â‡’ ca cb (â‰²âˆ€ ab) = {!!}
-- id-âŠ‘-â‰²â‡’ ca cb (âˆ€â‰² ab) = {!!}

postulate 
  â‰²â‡’-âŠ‘-â‰²â‡’ : âˆ€ {Î”} {B C Bâ€² Câ€² : Type Î”}
    â†’ (Î” âˆ£ [] âŠ¢ B âŠ‘ Bâ€²)
    â†’ (Î” âˆ£ [] âŠ¢ C âŠ‘ Câ€²)
    â†’ (bc : Î” âˆ£ [] âŠ¢ B â‰² C)
    â†’ (bcâ€² : Î” âˆ£ [] âŠ¢ Bâ€² â‰² Câ€²)
    â†’ Î” âˆ£ [] âˆ£ [] âŠ© â‰²-â‡’ [] bc âŠ‘ â‰²-â‡’ [] bcâ€²
  
-- â‰²â‡’-âŠ‘-â‰²â‡’ â„•âŠ‘â„• â„•âŠ‘â„• â„•â‰²â„• â„•â‰²â„• = id-âŠ‘ â„•âŠ‘â„•
-- â‰²â‡’-âŠ‘-â‰²â‡’ â„•âŠ‘â„• â˜…âŠ‘â˜… â„•â‰²â˜… â„•â‰²â˜… = !-âŠ‘
-- â‰²â‡’-âŠ‘-â‰²â‡’ â„•âŠ‘â„• â˜…âŠ‘â„• â„•â‰²â˜… â„•â‰²â„• = !-âŠ‘-id â„•âŠ‘â„•
-- â‰²â‡’-âŠ‘-â‰²â‡’ â„•âŠ‘â„• (âˆ€âŠ‘âˆ€ cc) bc bcâ€² = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ â„•âŠ‘â„• (âŠ‘âˆ€ cc) bc bcâ€² = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ XâŠ‘X XâŠ‘X Xâ‰²X Xâ‰²X = id-âŠ‘ XâŠ‘X
-- â‰²â‡’-âŠ‘-â‰²â‡’ XâŠ‘X â˜…âŠ‘â˜… (Xâ‰²â˜… âˆ‹X) (Xâ‰²â˜… âˆ‹Xâ€²) = !-âŠ‘   -- Remember âˆ‹X ?
-- â‰²â‡’-âŠ‘-â‰²â‡’ XâŠ‘X (â˜…âŠ‘X x) (Xâ‰²â˜… xâ‚) Xâ‰²X = !-âŠ‘-id XâŠ‘X
-- â‰²â‡’-âŠ‘-â‰²â‡’ XâŠ‘X (âˆ€âŠ‘âˆ€ cc) (â‰²âˆ€ bc) (â‰²âˆ€ bcâ€²) = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ XâŠ‘X (âŠ‘âˆ€ cc) Xâ‰²X (â‰²âˆ€ bcâ€²) = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ XâŠ‘X (âŠ‘âˆ€ cc) (Xâ‰²â˜… x) (â‰²âˆ€ bcâ€²) = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ XâŠ‘X (âŠ‘âˆ€ cc) (â‰²âˆ€ bc) bcâ€² = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ â˜…âŠ‘â˜… â„•âŠ‘â„• â˜…â‰²â„• â˜…â‰²â„• = ?-âŠ‘
-- â‰²â‡’-âŠ‘-â‰²â‡’ â˜…âŠ‘â˜… XâŠ‘X (â˜…â‰²X x) (â˜…â‰²X xâ‚) = ?-âŠ‘
-- â‰²â‡’-âŠ‘-â‰²â‡’ â˜…âŠ‘â˜… â˜…âŠ‘â˜… â˜…â‰²â˜… â˜…â‰²â˜… = id-âŠ‘ â˜…âŠ‘â˜…
-- â‰²â‡’-âŠ‘-â‰²â‡’ â˜…âŠ‘â˜… (â˜…âŠ‘X âˆ‹X) â˜…â‰²â˜… (â˜…â‰²X xâ‚) = id-âŠ‘-? (â˜…âŠ‘X xâ‚)
-- â‰²â‡’-âŠ‘-â‰²â‡’ â˜…âŠ‘â˜… â˜…âŠ‘â„• â˜…â‰²â˜… â˜…â‰²â„• = id-âŠ‘-? â˜…âŠ‘â„•
-- â‰²â‡’-âŠ‘-â‰²â‡’ â˜…âŠ‘â˜… (â˜…âŠ‘â‡’ cc ccâ‚) â˜…â‰²â˜… (â˜…â‰²â‡’ bcâ€² bcâ€²â‚) =
--   âŠ‘-â¨Ÿ (id-âŠ‘-? (â˜…âŠ‘â‡’ â˜…âŠ‘â˜… â˜…âŠ‘â˜…)) (idâ˜…-âŠ‘-â†¦ {!!} {!!})
-- â‰²â‡’-âŠ‘-â‰²â‡’ â˜…âŠ‘â˜… (â‡’âŠ‘â‡’ cc ccâ‚) (â˜…â‰²â‡’ bc bcâ‚) (â˜…â‰²â‡’ bcâ€² bcâ€²â‚) =
--   â¨Ÿ-âŠ‘-â¨Ÿ ?-âŠ‘ (â†¦-âŠ‘ (â‰²â‡’-âŠ‘-â‰²â‡’ â˜…âŠ‘â˜… cc bc bcâ€²) (â‰²â‡’-âŠ‘-â‰²â‡’ â˜…âŠ‘â˜… ccâ‚ bcâ‚ bcâ€²â‚))
-- â‰²â‡’-âŠ‘-â‰²â‡’ â˜…âŠ‘â˜… (âˆ€âŠ‘âˆ€ cc) bc bcâ€² = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ â˜…âŠ‘â˜… (âŠ‘âˆ€ cc) bc bcâ€² = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ (â˜…âŠ‘X x) XâŠ‘X (â˜…â‰²X xâ‚) Xâ‰²X = ?-âŠ‘-id XâŠ‘X
-- â‰²â‡’-âŠ‘-â‰²â‡’ (â˜…âŠ‘X x) â˜…âŠ‘â˜… â˜…â‰²â˜… (Xâ‰²â˜… xâ‚) = id-âŠ‘-! (â˜…âŠ‘X x)
-- â‰²â‡’-âŠ‘-â‰²â‡’ (â˜…âŠ‘X x) (â˜…âŠ‘X xâ‚) â˜…â‰²â˜… Xâ‰²X = id-âŠ‘ (â˜…âŠ‘X x)
-- â‰²â‡’-âŠ‘-â‰²â‡’ (â˜…âŠ‘X x) (âˆ€âŠ‘âˆ€ cc) bc bcâ€² = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ (â˜…âŠ‘X x) (âŠ‘âˆ€ cc) bc bcâ€² = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ â˜…âŠ‘â„• â„•âŠ‘â„• â˜…â‰²â„• â„•â‰²â„• = ?-âŠ‘-id â„•âŠ‘â„•
-- â‰²â‡’-âŠ‘-â‰²â‡’ â˜…âŠ‘â„• â˜…âŠ‘â˜… â˜…â‰²â˜… â„•â‰²â˜… = id-âŠ‘-! â˜…âŠ‘â„•
-- â‰²â‡’-âŠ‘-â‰²â‡’ â˜…âŠ‘â„• â˜…âŠ‘â„• â˜…â‰²â˜… â„•â‰²â„• = id-âŠ‘ â˜…âŠ‘â„•
-- â‰²â‡’-âŠ‘-â‰²â‡’ â˜…âŠ‘â„• (âˆ€âŠ‘âˆ€ cc) bc bcâ€² = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ â˜…âŠ‘â„• (âŠ‘âˆ€ cc) bc bcâ€² = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ (â˜…âŠ‘â‡’ bb bbâ‚) â˜…âŠ‘â˜… â˜…â‰²â˜… (â‡’â‰²â˜… bcâ€² bcâ€²â‚) =
--   âŠ‘-â¨Ÿ (idâ˜…-âŠ‘-â†¦ {!!} {!!}) (id-âŠ‘-! (â˜…âŠ‘â‡’ â˜…âŠ‘â˜… â˜…âŠ‘â˜…))
-- â‰²â‡’-âŠ‘-â‰²â‡’ (â˜…âŠ‘â‡’ bb bbâ‚) (â˜…âŠ‘â‡’ cc ccâ‚) â˜…â‰²â˜… (â‡’â‰²â‡’ bcâ€² bcâ€²â‚) =
--   idâ˜…-âŠ‘-â†¦ {!!} {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ (â˜…âŠ‘â‡’ bb bbâ‚) (â‡’âŠ‘â‡’ cc ccâ‚) (â˜…â‰²â‡’ bc bcâ‚) (â‡’â‰²â‡’ bcâ€² bcâ€²â‚) =
--   â¨Ÿ-âŠ‘ (?-âŠ‘-â†¦ (â˜…âŠ‘â‡’ bb bbâ‚) (â‡’âŠ‘â‡’ {!!} {!!}))
--       (â†¦-âŠ‘ (â‰²â‡’-âŠ‘-â‰²â‡’ bb cc bc bcâ€²) (â‰²â‡’-âŠ‘-â‰²â‡’ bbâ‚ ccâ‚ bcâ‚ bcâ€²â‚))
-- â‰²â‡’-âŠ‘-â‰²â‡’ (â˜…âŠ‘â‡’ bb bbâ‚) (âˆ€âŠ‘âˆ€ cc) bc bcâ€² = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ (â˜…âŠ‘â‡’ bb bbâ‚) (âŠ‘âˆ€ cc) bc bcâ€² = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ (â‡’âŠ‘â‡’ bb bbâ‚) â˜…âŠ‘â˜… (â‡’â‰²â˜… bc bcâ‚) (â‡’â‰²â˜… bcâ€² bcâ€²â‚) =
--   â¨Ÿ-âŠ‘-â¨Ÿ (â†¦-âŠ‘ (â‰²â‡’-âŠ‘-â‰²â‡’ bb â˜…âŠ‘â˜… bc bcâ€²) (â‰²â‡’-âŠ‘-â‰²â‡’ bbâ‚ â˜…âŠ‘â˜… bcâ‚ bcâ€²â‚)) !-âŠ‘
-- â‰²â‡’-âŠ‘-â‰²â‡’ (â‡’âŠ‘â‡’ bb bbâ‚) (â˜…âŠ‘â‡’ cc ccâ‚) (â‡’â‰²â˜… bc bcâ‚) (â‡’â‰²â‡’ bcâ€² bcâ€²â‚) =
--   â¨Ÿ-âŠ‘ (â†¦-âŠ‘ (â‰²â‡’-âŠ‘-â‰²â‡’ bb cc bc bcâ€²) (â‰²â‡’-âŠ‘-â‰²â‡’ bbâ‚ ccâ‚ bcâ‚ bcâ€²â‚))
--       (!-âŠ‘-â†¦ (â‡’âŠ‘â‡’ {!!} {!!}) (â˜…âŠ‘â‡’ cc ccâ‚))
-- â‰²â‡’-âŠ‘-â‰²â‡’ (â‡’âŠ‘â‡’ bb bbâ‚) (â‡’âŠ‘â‡’ cc ccâ‚) (â‡’â‰²â‡’ bc bcâ‚) (â‡’â‰²â‡’ bcâ€² bcâ€²â‚) =
--   â†¦-âŠ‘ (â‰²â‡’-âŠ‘-â‰²â‡’ bb cc bc bcâ€²) (â‰²â‡’-âŠ‘-â‰²â‡’ bbâ‚ ccâ‚ bcâ‚ bcâ€²â‚)
-- â‰²â‡’-âŠ‘-â‰²â‡’ (â‡’âŠ‘â‡’ bb bbâ‚) (âˆ€âŠ‘âˆ€ cc) bc bcâ€² = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ (â‡’âŠ‘â‡’ bb bbâ‚) (âŠ‘âˆ€ cc) bc bcâ€² = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ (âˆ€âŠ‘âˆ€ bb) cc bc bcâ€² = {!!}
-- â‰²â‡’-âŠ‘-â‰²â‡’ (âŠ‘âˆ€ bb) cc bc bcâ€² = {!!}

compile-pres-precision : âˆ€{Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx [] Î“ Î“â€²}
  {A Aâ€² : Type Î”} {AâŠ‘Aâ€² : Î” âˆ£ [] âŠ¢ A âŠ‘ Aâ€²}
  {M : Î” âˆ£ Î“ âŠ¢áµ A} {Mâ€² : Î” âˆ£ Î“â€² âŠ¢áµ Aâ€²}
  â†’ Î” âˆ£ Î¦ âŠ¢áµ M âŠ‘ Mâ€² â¦‚ AâŠ‘Aâ€²
  â†’ [] âˆ£ [] âˆ£ Î¦ âŠ© compile M âŠ‘ compile Mâ€² â¦‚ AâŠ‘Aâ€²
compile-pres-precision (âŠ‘-var âˆ‹âŠ‘) = âŠ‘-var âˆ‹âŠ‘
compile-pres-precision âŠ‘-nat = âŠ‘-nat
compile-pres-precision (âŠ‘-lam MâŠ‘Mâ€²) = âŠ‘-lam (compile-pres-precision MâŠ‘Mâ€²)
compile-pres-precision (âŠ‘-app{a = a}{b}{d}{f}{bc}{fâ€²}{bcâ€²} LâŠ‘Lâ€² MâŠ‘Mâ€²) =
    let IH1 = compile-pres-precision LâŠ‘Lâ€² in
    let IH2 = compile-pres-precision MâŠ‘Mâ€² in
    let cc = âŠ‘-âµ-âµ-âŠ‘ a f fâ€² in
    âŠ‘-app{c = cc} (âŠ‘-âŸ¨âŸ© IH1 (âµâ‡’-âŠ‘-âµâ‡’ a f fâ€²)) (âŠ‘-âŸ¨âŸ© IH2 (â‰²â‡’-âŠ‘-â‰²â‡’ b cc bc bcâ€²))
compile-pres-precision (âŠ‘-Î› NâŠ‘Nâ€²) = {!!}
compile-pres-precision (âŠ‘-â—¯ MâŠ‘Mâ€²) = {!!}
