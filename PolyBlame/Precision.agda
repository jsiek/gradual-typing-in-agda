{-# OPTIONS --rewriting #-}

module PolyBlame.Precision where

import Relation.Binary.PropositionalEquality as Eq
open Eq using (_â‰¡_; _â‰¢_; refl; cong; congâ‚‚; sym)
open import Data.Nat using (â„•; zero; suc; _<_; _â‰¤?_; zâ‰¤n; sâ‰¤s)
open import Data.Nat.Properties using (suc-injective)
open import Data.List hiding ([_])
open import Data.List.Properties using (map-âˆ˜)
open import Data.Empty using (âŠ¥; âŠ¥-elim)
open import Data.Unit using (âŠ¤)
open import Data.Product hiding (map)
open import Data.Maybe hiding (map)
open import Function using (_âˆ˜_)
open import Relation.Nullary using (Dec; yes; no)
open import Agda.Builtin.Bool

open import Agda.Builtin.Equality
open import Agda.Builtin.Equality.Rewrite

open import PolyBlame.Types
open import PolyBlame.Variables
open import PolyBlame.Terms
open import PolyBlame.Coercions
open import PolyBlame.Gradual
open import PolyBlame.Compile

postulate
  subáµ—-prec : âˆ€{Î”}{A B : Type (Î” ,typ)}{X}
    â†’ (Î” ,typ) âˆ£ mt Î” , false âŠ¢ A âŠ‘ B
    â†’ Î” âˆ£ mt Î” âŠ¢ A [ X ]áµ— âŠ‘ (B [ X ]áµ—)

{-
  Coercion less precise than a type
  (Replace this with coercion less precise than an id coercion.)
 -}
infix 3 _âˆ£_âŠ©_âŠ‘_
data _âˆ£_âŠ©_âŠ‘_ : âˆ€(Î” : TyCtx)(Î£ : BindCtx Î”){A B : Type Î”}
  â†’ (Î” âˆ£ Î£ âŠ¢ A â‡’ B) â†’ (Type Î”)
  â†’  Set  where

  id-âŠ‘ : âˆ€{Î”}{Î£}{A : Type Î”}
      ------------------------
     â†’ Î” âˆ£ Î£ âŠ©  id{A = A}  âŠ‘ A

  â†¦-âŠ‘ : âˆ€{Î”}{Î£}{A B C D E F : Type Î”}
       {c : Î” âˆ£ Î£ âŠ¢ C â‡’ A }
       {d : Î” âˆ£ Î£ âŠ¢ B â‡’ D }
     â†’ Î” âˆ£ Î£ âŠ© c âŠ‘ E
     â†’ Î” âˆ£ Î£ âŠ© d âŠ‘ F
       --------------------------
     â†’ Î” âˆ£ Î£ âŠ© (c â†¦ d) âŠ‘ (E â‡’ F)

  â¨Ÿ-âŠ‘ : âˆ€{Î”}{Î£}{A B C D : Type Î”}
       {c : Î” âˆ£ Î£ âŠ¢ A â‡’ B }
       {d : Î” âˆ£ Î£ âŠ¢ B â‡’ C }
     â†’ Î” âˆ£ Î£ âŠ© c âŠ‘ D
     â†’ Î” âˆ£ Î£ âŠ© d âŠ‘ D
       --------------------------
     â†’ Î” âˆ£ Î£ âŠ© (c â¨Ÿ d) âŠ‘ D

  !-âŠ‘ : âˆ€{Î”}{Î£}{B : Type Î”}{G : Grnd Î”}
     â†’ Î” âˆ£ mt Î” âŠ¢ âŒˆ G âŒ‰ âŠ‘ B
      ---------------------
     â†’ Î” âˆ£ Î£ âŠ© (G !) âŠ‘ B

  ?-âŠ‘ : âˆ€{Î”}{Î£}{B : Type Î”}{G : Grnd Î”}
     â†’ Î” âˆ£ mt Î” âŠ¢ âŒˆ G âŒ‰ âŠ‘ B
      ---------------------
     â†’ Î” âˆ£ Î£ âŠ© (G `?) âŠ‘ B


â˜…-âŠ‘-FV-âŠ† : âˆ€{Î”}{Î¨ : SubCtx Î”}{A : Type Î”}
  â†’ Î” âˆ£ Î¨ âŠ¢ â˜… âŠ‘ A
  â†’ FV A âŠ† Î¨
â˜…-âŠ‘-FV-âŠ† {Î”} {Î¨} {A} â˜…âŠ‘â˜… = mt-âŠ†
â˜…-âŠ‘-FV-âŠ† {Î”} {Î¨} {A} (â˜…âŠ‘X âˆ‹X) = âˆ‹-single-âŠ† âˆ‹X
â˜…-âŠ‘-FV-âŠ† {Î”} {Î¨} {A} â˜…âŠ‘â„• = mt-âŠ†
â˜…-âŠ‘-FV-âŠ† {Î”} {Î¨} {A â‡’ B} (â˜…âŠ‘â‡’ â˜…âŠ‘A â˜…âŠ‘B) =
  let IH1 = â˜…-âŠ‘-FV-âŠ† â˜…âŠ‘A in
  let IH2 = â˜…-âŠ‘-FV-âŠ† â˜…âŠ‘B in
  âŠ†-âˆª IH1 IH2
â˜…-âŠ‘-FV-âŠ† {Î”} {Î¨} {A} (âŠ‘âˆ€ â˜…âŠ‘A) = âŠ†-â¤‹ (â˜…-âŠ‘-FV-âŠ† â˜…âŠ‘A)

â˜…â‡’â˜…-âŠ‘-FV-âŠ† : âˆ€{Î”}{Î¨ : SubCtx Î”}{A : Type Î”}
  â†’ Î” âˆ£ Î¨ âŠ¢ (â˜… â‡’ â˜…) âŠ‘ A
  â†’ FV A âŠ† Î¨
â˜…â‡’â˜…-âŠ‘-FV-âŠ† {Î”} {Î¨} {A â‡’ B} (â‡’âŠ‘â‡’ â˜…âŠ‘A â˜…âŠ‘B) =
  âŠ†-âˆª (â˜…-âŠ‘-FV-âŠ† â˜…âŠ‘A) (â˜…-âŠ‘-FV-âŠ† â˜…âŠ‘B)
â˜…â‡’â˜…-âŠ‘-FV-âŠ† {Î”} {Î¨} {`âˆ€ A} (âŠ‘âˆ€ â˜…â‡’â˜…âŠ‘A) =
  âŠ†-â¤‹ (â˜…â‡’â˜…-âŠ‘-FV-âŠ† â˜…â‡’â˜…âŠ‘A)

â˜…â‡’â˜…-âŠ‘ : âˆ€{Î”}{Î¨ : SubCtx Î”}{A : Type Î”}
  â†’ Î” âˆ£ Î¨ âŠ¢ (â˜… â‡’ â˜…) âŠ‘ A
  â†’ Î£[ Aâ‚ âˆˆ Type Î” ] Î£[ Aâ‚‚ âˆˆ Type Î” ]
    Î” âˆ£ Î¨ âŠ¢ â˜… âŠ‘ Aâ‚  Ã—  Î” âˆ£ Î¨ âŠ¢ â˜… âŠ‘ Aâ‚‚
â˜…â‡’â˜…-âŠ‘ {Î”} {Î¨} {A} (â‡’âŠ‘â‡’ â˜…âŠ‘C â˜…âŠ‘D) = _ , _ , â˜…âŠ‘C , â˜…âŠ‘D
â˜…â‡’â˜…-âŠ‘ {Î”} {Î¨} {A} (âŠ‘âˆ€ â˜…â‡’â˜…âŠ‘A) = â˜… , â˜… , â˜…âŠ‘â˜… , â˜…âŠ‘â˜…

â„•-âŠ‘-FV : âˆ€{Î”}{Î¨ : SubCtx Î”}{A : Type Î”}
  â†’ Î” âˆ£ Î¨ âŠ¢ `â„• âŠ‘ A
  â†’ FV A âŠ† mt Î”
â„•-âŠ‘-FV {Î”} {Î¨} {`â„•} â„•âŠ‘A = mt-âŠ†
â„•-âŠ‘-FV {Î”} {Î¨} {`âˆ€ A} (âŠ‘âˆ€ â„•âŠ‘A) = âŠ†-â¤‹ (â„•-âŠ‘-FV â„•âŠ‘A)

{-
â‡’-âŠ‘-âŠ‘ : âˆ€{Î”}{Î£ : BindCtx Î”}{A B C : Type Î”}
    (c : Î” âˆ£ Î£ âŠ¢ A â‡’ B)
  â†’ Î” âˆ£ Î£ âŠ© c âŠ‘ C
  â†’ Î” âˆ£ mt Î” âŠ¢ A âŠ‘ C  Ã—  Î” âˆ£ mt Î” âŠ¢ B âŠ‘ C
â‡’-âŠ‘-âŠ‘ {Î”} {Î£} {A} {B} c id-âŠ‘ = ReflâŠ‘ A , ReflâŠ‘ A
â‡’-âŠ‘-âŠ‘ {Î”} {Î£} {Aâ‚ â‡’ Aâ‚‚} {Bâ‚ â‡’ Bâ‚‚} {Câ‚ â‡’ Câ‚‚} (c â†¦ d) (â†¦-âŠ‘ câŠ‘Câ‚ dâŠ‘Câ‚‚) =
    (â‡’âŠ‘â‡’ (â‡’-âŠ‘-âŠ‘ c câŠ‘Câ‚ .projâ‚‚) (â‡’-âŠ‘-âŠ‘ d dâŠ‘Câ‚‚ .projâ‚))
  , (â‡’âŠ‘â‡’ (â‡’-âŠ‘-âŠ‘ c câŠ‘Câ‚ .projâ‚) (â‡’-âŠ‘-âŠ‘ d dâŠ‘Câ‚‚ .projâ‚‚))
â‡’-âŠ‘-âŠ‘ {Î”} {Î£} {A} {B} (c â¨Ÿ d) (â¨Ÿ-âŠ‘ câŠ‘C câŠ‘Câ‚) =
  â‡’-âŠ‘-âŠ‘ c câŠ‘C .projâ‚ , â‡’-âŠ‘-âŠ‘ d câŠ‘Câ‚ .projâ‚‚
â‡’-âŠ‘-âŠ‘ {Î”} {Î£} {A} {B} (â˜…â‡’â˜… !) (!-âŠ‘ (â‡’âŠ‘â‡’ x y)) = â‡’âŠ‘â‡’ x y , â˜…âŠ‘â‡’ x y
â‡’-âŠ‘-âŠ‘ {Î”} {Î£} {A} {â˜…} (â˜…â‡’â˜… !) (!-âŠ‘ (âŠ‘âˆ€{B = Bâ€²} â˜…â‡’â˜…âŠ‘Bâ€²)) =
  let FVB = â˜…â‡’â˜…-âŠ‘-FV-âŠ† â˜…â‡’â˜…âŠ‘Bâ€² in
  let â¤‹FVB = âŠ†-â¤‹ FVB in
  (âŠ‘âˆ€ â˜…â‡’â˜…âŠ‘Bâ€²) , (â˜…-âŠ‘ (`âˆ€ _) â¤‹FVB)
â‡’-âŠ‘-âŠ‘ {Î”} {Î£} {A} {B} {C} (`â„• !) (!-âŠ‘ â„•âŠ‘C) = â„•âŠ‘C , (â˜…-âŠ‘ C (â„•-âŠ‘-FV â„•âŠ‘C))
â‡’-âŠ‘-âŠ‘ {Î”} {Î£} {A} {B} {C} ((` X) !) (!-âŠ‘ XâŠ‘C) = XâŠ‘C , {!!}
  {-

    X  âŠ‘   C
    !
    â˜…  âŠ‘  C

   -}
â‡’-âŠ‘-âŠ‘ {Î”} {Î£} {A} {B} {C} c (?-âŠ‘ x) = {!!}
-}

infix 3 _âˆ£_âˆ£_âŠ©_âŠ‘_â¦‚_
data _âˆ£_âˆ£_âŠ©_âŠ‘_â¦‚_ : âˆ€{Î”}(Î£ Î£â€² : BindCtx Î”){A B : Type Î”}{Î“ Î“â€² : Ctx Î”}
  â†’ PrecCtx Î“ Î“â€² â†’ (Î” âˆ£ Î£ âˆ£ Î“ âŠ¢ A) â†’ (Î” âˆ£ Î£â€² âˆ£ Î“â€² âŠ¢ B)
  â†’ Î” âˆ£ mt Î” âŠ¢ A âŠ‘ B â†’ Set  where
  
  âŠ‘-var : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{A B}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î“ Î“â€²}
     â†’ (x : âŠ¢ Î¦ âˆ‹ A âŠ‘ B)
       ---------------------------------------------------------
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© (` proj-left x) âŠ‘ (` proj-right x) â¦‚ get-âŠ‘ x

  âŠ‘-nat : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î“ Î“â€²}{k : â„•}
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© (# k) âŠ‘ (# k) â¦‚ â„•âŠ‘â„•

  âŠ‘-lam : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î“ Î“â€²}
      {A B C D : Type Î”}{N : Î” âˆ£ Î£ âˆ£ (Î“ â–· A) âŠ¢ B} {Nâ€² : Î” âˆ£ Î£â€² âˆ£ (Î“â€² â–· C) âŠ¢ D}
      {c : Î” âˆ£ mt Î” âŠ¢ A âŠ‘ C}{d : Î” âˆ£ mt Î” âŠ¢ B âŠ‘ D}
     â†’ Î£ âˆ£ Î£â€² âˆ£ (Î¦ , c) âŠ© N âŠ‘ Nâ€² â¦‚ d
       ---------------------------------
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© Æ› N âŠ‘ Æ› Nâ€² â¦‚ â‡’âŠ‘â‡’ c d
  
  âŠ‘-app : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î“ Î“â€²}
       {A B C D : Type Î”}
       {L : Î” âˆ£ Î£ âˆ£ Î“ âŠ¢ A â‡’ B}    {M : Î” âˆ£ Î£ âˆ£ Î“ âŠ¢ A}
       {Lâ€² : Î” âˆ£ Î£â€² âˆ£ Î“â€² âŠ¢ C â‡’ D} {Mâ€² : Î” âˆ£ Î£â€² âˆ£ Î“â€² âŠ¢ C}
       {c : Î” âˆ£ mt Î” âŠ¢ A âŠ‘ C}
       {d : Î” âˆ£ mt Î” âŠ¢ B âŠ‘ D}
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© L âŠ‘ Lâ€² â¦‚ (â‡’âŠ‘â‡’ c d)
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© M âŠ‘ Mâ€² â¦‚ c
       --------------------------------
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© L Â· M âŠ‘ Lâ€² Â· Mâ€² â¦‚ d
  
  âŠ‘-Î› : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î“ Î“â€²}
      {A B : Type (Î” ,typ)}{N : (Î” ,typ) âˆ£ â¤Š Î£ âˆ£ âŸ° Î“ âŠ¢ A}
      {Nâ€² : (Î” ,typ) âˆ£ â¤Š Î£â€² âˆ£ âŸ° Î“â€² âŠ¢ B}
      {c : (Î” ,typ) âˆ£ mt (Î” ,typ) âŠ¢ A âŠ‘ B}
     â†’ â¤Š Î£ âˆ£ â¤Š Î£â€² âˆ£ âŸ°áµ– Î¦ âŠ© N âŠ‘ Nâ€² â¦‚ c
       --------------------------------
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© Î› N âŠ‘ Î› Nâ€² â¦‚ âˆ€âŠ‘âˆ€ c
      
  âŠ‘-â—¯ : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î“ Î“â€²}
        {A B : Type (Î” ,typ)}{M : Î” âˆ£ Î£ âˆ£ Î“ âŠ¢ `âˆ€ A}
        {Mâ€² : Î” âˆ£ Î£â€²  âˆ£ Î“â€² âŠ¢ `âˆ€ B}{X}
        {p : (Î” ,typ) âˆ£ mt (Î” ,typ) âŠ¢ A âŠ‘ B}
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© M âŠ‘ Mâ€² â¦‚ âˆ€âŠ‘âˆ€ p
       ----------------------------------------------
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© (M â—¯ X) âŠ‘ (Mâ€² â—¯ X) â¦‚ subáµ—-prec p

  âŠ‘-blame : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î“ Î“â€²}
        {A : Type Î”}{M : Î” âˆ£ Î£ âˆ£ Î“ âŠ¢ A}{M : Î” âˆ£ Î£ âˆ£ Î“ âŠ¢ A}
       --------------------------------
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© M âŠ‘ blame â¦‚ ReflâŠ‘ A

  âŠ‘-âŸ¨âŸ© : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î“ Î“â€²}
        {A B Aâ€² Bâ€² : Type Î”}
        {M : Î” âˆ£ Î£ âˆ£ Î“ âŠ¢ A} {c : Î” âˆ£ Î£ âŠ¢ A â‡’ B}
        {Mâ€² : Î” âˆ£ Î£â€²  âˆ£ Î“â€² âŠ¢ Aâ€²} {câ€² : Î” âˆ£ Î£â€² âŠ¢ Aâ€² â‡’ Bâ€²}
        {AâŠ‘Aâ€² : Î” âˆ£ mt Î” âŠ¢ A âŠ‘ Aâ€²}
        {BâŠ‘Bâ€² : Î” âˆ£ mt Î” âŠ¢ B âŠ‘ Bâ€²}
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© M âŠ‘ Mâ€² â¦‚ AâŠ‘Aâ€²
     â†’ Î” âˆ£ Î£ âˆ£ Î£â€² âŠ© c âŠ‘ câ€²
       ----------------------------------------
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© M âŸ¨ c âŸ© âŠ‘ Mâ€² âŸ¨ câ€² âŸ© â¦‚ BâŠ‘Bâ€²
     
{-
  âŠ‘-âŸ¨âŸ©-L : âˆ€{Î”}{Î£ Î£â€² : BindCtx Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î“ Î“â€²}
        {A B C : Type Î”}
        {M : Î” âˆ£ Î£ âˆ£ Î“ âŠ¢ A}
        {c : Î” âˆ£ Î£ âŠ¢ A â‡’ B}
        {p : Î” âˆ£ mt Î” âŠ¢ A âŠ‘ C}
        {Mâ€² : Î” âˆ£ Î£â€²  âˆ£ Î“â€² âŠ¢ C}
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© M âŠ‘ Mâ€² â¦‚ p
     â†’ Î” âˆ£ Î£ âŠ© c âŠ‘ C
       ----------------------------------------------
     â†’ Î£ âˆ£ Î£â€² âˆ£ Î¦ âŠ© M âŸ¨ c âŸ© âŠ‘ Mâ€² â¦‚ {!!}
  
-}

âµâ‡’-âŠ‘-âµâ‡’ : âˆ€{Î”} {A B C Aâ€² Bâ€² Câ€² : Type Î”}
  â†’ (Î” âˆ£ mt Î” âŠ¢ C âŠ‘ Câ€²)
  â†’ (f : Î” âŠ¢ C âµ (A â‡’ B))
  â†’ (fâ€² : Î” âŠ¢ Câ€² âµ (Aâ€² â‡’ Bâ€²))
  â†’ Î” âˆ£ [] âˆ£ [] âŠ© (âµ-â‡’ f) âŠ‘ (âµ-â‡’ fâ€²)
âµâ‡’-âŠ‘-âµâ‡’ cc âµ-â‡’-â‡’ âµ-â‡’-â‡’ = id-âŠ‘ cc
âµâ‡’-âŠ‘-âµâ‡’ (â˜…âŠ‘â‡’ â˜…âŠ‘Aâ€² â˜…âŠ‘Bâ€²) âµ-â˜…-â‡’ âµ-â‡’-â‡’ = ?-âŠ‘-id (â‡’âŠ‘â‡’ â˜…âŠ‘Aâ€² â˜…âŠ‘Bâ€²)
âµâ‡’-âŠ‘-âµâ‡’ cc âµ-â˜…-â‡’ âµ-â˜…-â‡’ = ?-âŠ‘

âŠ‘-âµ-âµ-âŠ‘ : âˆ€{Î”} {A B C Aâ€² Bâ€² Câ€² : Type Î”}
  â†’ (Î” âˆ£ mt Î” âŠ¢ C âŠ‘ Câ€²)
  â†’ (Î” âŠ¢ C âµ (A â‡’ B))
  â†’ (Î” âŠ¢ Câ€² âµ (Aâ€² â‡’ Bâ€²))
  â†’ Î” âˆ£ mt Î” âŠ¢ A âŠ‘ Aâ€²
âŠ‘-âµ-âµ-âŠ‘ (â‡’âŠ‘â‡’ cc dd) âµ-â‡’-â‡’ âµ-â‡’-â‡’ = cc
âŠ‘-âµ-âµ-âŠ‘ (â˜…âŠ‘â‡’ cc dd) âµ-â˜…-â‡’ âµ-â‡’-â‡’ = cc
âŠ‘-âµ-âµ-âŠ‘ â˜…âŠ‘â˜… âµ-â˜…-â‡’ âµ-â˜…-â‡’ = â˜…âŠ‘â˜…

idâ˜…-âŠ‘-âˆ¼â‡’ : âˆ€ {Î”}{Î¨} {B : Type Î”}
  â†’ (Î” âˆ£ Î¨ âŠ¢ â˜… âŠ‘ B)
  â†’ (ab : Î” âˆ£ Î¨ âŠ¢ â˜… âˆ¼ B)
  â†’ Î” âˆ£ [] âˆ£ [] âŠ© id{A = â˜…} âŠ‘ âˆ¼-â‡’ ab []
  
idâ˜…-âŠ‘-âˆ¼â‡ : âˆ€ {Î”}{Î¨} {A : Type Î”}
  â†’ (Î” âˆ£ Î¨ âŠ¢ â˜… âŠ‘ A)
  â†’ (ab : Î” âˆ£ Î¨ âŠ¢ â˜… âˆ¼ A)
  â†’ Î” âˆ£ [] âˆ£ [] âŠ© id{A = â˜…} âŠ‘ âˆ¼-â‡ ab []
idâ˜…-âŠ‘-âˆ¼â‡ {A = `â„•} âŠ‘A â˜…âˆ¼â„• = id-âŠ‘-! âŠ‘A
idâ˜…-âŠ‘-âˆ¼â‡ {A = â˜…} âŠ‘A â˜…âˆ¼â˜… = id-âŠ‘ âŠ‘A
idâ˜…-âŠ‘-âˆ¼â‡ {A = ` x} âŠ‘A (â˜…âˆ¼X xâ‚) = id-âŠ‘-! âŠ‘A
idâ˜…-âŠ‘-âˆ¼â‡ {Î¨ = Î¨}{A = A â‡’ Aâ‚} (â˜…âŠ‘â‡’ âŠ‘A âŠ‘Aâ‚) (â˜…âˆ¼â‡’ ~A ~Aâ‚) = 
  âŠ‘-â¨Ÿ (idâ˜…-âŠ‘-â†¦{A = A}{B = A} (idâ˜…-âŠ‘-âˆ¼â‡’ âŠ‘A ~A) (idâ˜…-âŠ‘-âˆ¼â‡ âŠ‘Aâ‚ ~Aâ‚))
      (id-âŠ‘-!{Î¨ = Î¨} (â˜…âŠ‘â‡’ â˜…âŠ‘â˜… â˜…âŠ‘â˜…))
idâ˜…-âŠ‘-âˆ¼â‡ {A = `âˆ€ A} (âŠ‘âˆ€ âŠ‘A) (âˆ¼âˆ€ ~A) = idâ˜…-âŠ‘-â„ {!idâ˜…-âŠ‘-âˆ¼â‡!}

idâ˜…-âŠ‘-âˆ¼â‡’ {B = `â„•} âŠ‘B â˜…âˆ¼â„• = id-âŠ‘-? âŠ‘B
idâ˜…-âŠ‘-âˆ¼â‡’ {B = â˜…} âŠ‘B â˜…âˆ¼â˜… = id-âŠ‘ âŠ‘B
idâ˜…-âŠ‘-âˆ¼â‡’ {B = ` x} âŠ‘B (â˜…âˆ¼X xâ‚) = id-âŠ‘-? âŠ‘B
idâ˜…-âŠ‘-âˆ¼â‡’ {Î¨ = Î¨}{B = B â‡’ Bâ‚} (â˜…âŠ‘â‡’ âŠ‘B âŠ‘Bâ‚) (â˜…âˆ¼â‡’ âˆ¼B âˆ¼Bâ‚) = 
  âŠ‘-â¨Ÿ (id-âŠ‘-?{Î¨ = Î¨} (â˜…âŠ‘â‡’ â˜…âŠ‘â˜… â˜…âŠ‘â˜…))
      (idâ˜…-âŠ‘-â†¦{A = B}{B = B} (idâ˜…-âŠ‘-âˆ¼â‡ âŠ‘B âˆ¼B)
       (idâ˜…-âŠ‘-âˆ¼â‡’ âŠ‘Bâ‚ âˆ¼Bâ‚))
idâ˜…-âŠ‘-âˆ¼â‡’ {B = `âˆ€ B} (âŠ‘âˆ€ âŠ‘B) (âˆ¼âˆ€ âˆ¼B) = idâ˜…-âŠ‘-ð’¢ (idâ˜…-âŠ‘-âˆ¼â‡’ âŠ‘B âˆ¼B)

id-âŠ‘-âˆ¼â‡ : âˆ€ {Î”} {C Aâ€² Bâ€² : Type Î”}
  â†’ (Î” âˆ£ mt Î” âŠ¢ C âŠ‘ Aâ€²)
  â†’ (Î” âˆ£ mt Î” âŠ¢ C âŠ‘ Bâ€²)
  â†’ (ab : Î” âˆ£ mt Î” âŠ¢ Aâ€² âˆ¼ Bâ€²)
  â†’ Î” âˆ£ [] âˆ£ [] âŠ© id{A = C} âŠ‘ âˆ¼-â‡ ab []

id-âŠ‘-âˆ¼â‡ ca cb ab = {!!}

id-âŠ‘-âˆ¼â‡’ : âˆ€ {Î”} {C Aâ€² Bâ€² : Type Î”}
  â†’ (Î” âˆ£ mt Î” âŠ¢ C âŠ‘ Aâ€²)
  â†’ (Î” âˆ£ mt Î” âŠ¢ C âŠ‘ Bâ€²)
  â†’ (ab : Î” âˆ£ mt Î” âŠ¢ Aâ€² âˆ¼ Bâ€²)
  â†’ Î” âˆ£ [] âˆ£ [] âŠ© id{A = C} âŠ‘ âˆ¼-â‡’ ab []
id-âŠ‘-âˆ¼â‡’ ca cb â„•âˆ¼â„• = id-âŠ‘ ca
id-âŠ‘-âˆ¼â‡’ ca cb Xâˆ¼X = id-âŠ‘ ca
id-âŠ‘-âˆ¼â‡’ ca cb â˜…âˆ¼â˜… = id-âŠ‘ ca
id-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â˜… cb (â˜…âˆ¼X x) = id-âŠ‘-? cb
id-âŠ‘-âˆ¼â‡’ (â˜…âŠ‘X xâ‚) cb (Xâˆ¼â˜… x) = id-âŠ‘-! (â˜…âŠ‘X xâ‚)
id-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â˜… cb â˜…âˆ¼â„• = id-âŠ‘-? cb
id-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â„• cb â„•âˆ¼â˜… = id-âŠ‘-! â˜…âŠ‘â„•
id-âŠ‘-âˆ¼â‡’ (â˜…âŠ‘â‡’ ca caâ‚) â˜…âŠ‘â˜… (â‡’âˆ¼â˜… ab abâ‚) =
  âŠ‘-â¨Ÿ (idâ˜…-âŠ‘-â†¦ (id-âŠ‘-âˆ¼â‡ ca â˜…âŠ‘â˜… ab)
                (id-âŠ‘-âˆ¼â‡’ caâ‚ â˜…âŠ‘â˜… abâ‚))
      (id-âŠ‘-! (â˜…âŠ‘â‡’ â˜…âŠ‘â˜… â˜…âŠ‘â˜…))
id-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â˜… (â˜…âŠ‘â‡’ cb cbâ‚) (â˜…âˆ¼â‡’ ab abâ‚) =
  âŠ‘-â¨Ÿ (id-âŠ‘-? (â˜…âŠ‘â‡’ â˜…âŠ‘â˜… â˜…âŠ‘â˜…))
      (idâ˜…-âŠ‘-â†¦ (idâ˜…-âŠ‘-âˆ¼â‡ cb ab) (idâ˜…-âŠ‘-âˆ¼â‡’ cbâ‚ abâ‚))
id-âŠ‘-âˆ¼â‡’ (â˜…âŠ‘â‡’ ca caâ‚) (â˜…âŠ‘â‡’ cb cbâ‚) (â‡’âˆ¼â‡’ ab abâ‚) =
  idâ˜…-âŠ‘-â†¦ (id-âŠ‘-âˆ¼â‡ ca cb ab) (id-âŠ‘-âˆ¼â‡’ caâ‚ cbâ‚ abâ‚)
id-âŠ‘-âˆ¼â‡’ (â‡’âŠ‘â‡’ ca caâ‚) (â‡’âŠ‘â‡’ cb cbâ‚) (â‡’âˆ¼â‡’ ab abâ‚) =
  id-âŠ‘-â†¦ (id-âŠ‘-âˆ¼â‡ ca cb ab) (id-âŠ‘-âˆ¼â‡’ caâ‚ cbâ‚ abâ‚)
id-âŠ‘-âˆ¼â‡’ ca cb (âˆ€âˆ¼âˆ€ ab) = {!!}
id-âŠ‘-âˆ¼â‡’ ca cb (âˆ¼âˆ€ ab) = {!!}
id-âŠ‘-âˆ¼â‡’ ca cb (âˆ€âˆ¼ ab) = {!!}

âˆ¼â‡-âŠ‘-âˆ¼â‡ : âˆ€ {Î”} {B C Bâ€² Câ€² : Type Î”}
  â†’ (Î” âˆ£ mt Î” âŠ¢ B âŠ‘ Bâ€²)
  â†’ (Î” âˆ£ mt Î” âŠ¢ C âŠ‘ Câ€²)
  â†’ (bc : Î” âˆ£ mt Î” âŠ¢ B âˆ¼ C)
  â†’ (bcâ€² : Î” âˆ£ mt Î” âŠ¢ Bâ€² âˆ¼ Câ€²)
  â†’ Î” âˆ£ [] âˆ£ [] âŠ© âˆ¼-â‡ bc [] âŠ‘ âˆ¼-â‡ bcâ€² []
  
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ : âˆ€ {Î”} {B C Bâ€² Câ€² : Type Î”}
  â†’ (Î” âˆ£ mt Î” âŠ¢ B âŠ‘ Bâ€²)
  â†’ (Î” âˆ£ mt Î” âŠ¢ C âŠ‘ Câ€²)
  â†’ (bc : Î” âˆ£ mt Î” âŠ¢ B âˆ¼ C)
  â†’ (bcâ€² : Î” âˆ£ mt Î” âŠ¢ Bâ€² âˆ¼ Câ€²)
  â†’ Î” âˆ£ [] âˆ£ [] âŠ© âˆ¼-â‡’ bc [] âŠ‘ âˆ¼-â‡’ bcâ€² []
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â„•âŠ‘â„• â„•âŠ‘â„• â„•âˆ¼â„• â„•âˆ¼â„• = id-âŠ‘ â„•âŠ‘â„•
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â„•âŠ‘â„• â˜…âŠ‘â˜… â„•âˆ¼â˜… â„•âˆ¼â˜… = !-âŠ‘
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â„•âŠ‘â„• â˜…âŠ‘â„• â„•âˆ¼â˜… â„•âˆ¼â„• = !-âŠ‘-id â„•âŠ‘â„•
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â„•âŠ‘â„• (âˆ€âŠ‘âˆ€ cc) bc bcâ€² = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â„•âŠ‘â„• (âŠ‘âˆ€ cc) bc bcâ€² = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ XâŠ‘X XâŠ‘X Xâˆ¼X Xâˆ¼X = id-âŠ‘ XâŠ‘X
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ XâŠ‘X â˜…âŠ‘â˜… (Xâˆ¼â˜… âˆ‹X) (Xâˆ¼â˜… âˆ‹Xâ€²) = !-âŠ‘   -- Remember âˆ‹X ?
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ XâŠ‘X (â˜…âŠ‘X x) (Xâˆ¼â˜… xâ‚) Xâˆ¼X = !-âŠ‘-id XâŠ‘X
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ XâŠ‘X (âˆ€âŠ‘âˆ€ cc) (âˆ¼âˆ€ bc) (âˆ¼âˆ€ bcâ€²) = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ XâŠ‘X (âŠ‘âˆ€ cc) Xâˆ¼X (âˆ¼âˆ€ bcâ€²) = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ XâŠ‘X (âŠ‘âˆ€ cc) (Xâˆ¼â˜… x) (âˆ¼âˆ€ bcâ€²) = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ XâŠ‘X (âŠ‘âˆ€ cc) (âˆ¼âˆ€ bc) bcâ€² = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â˜… â„•âŠ‘â„• â˜…âˆ¼â„• â˜…âˆ¼â„• = ?-âŠ‘
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â˜… XâŠ‘X (â˜…âˆ¼X x) (â˜…âˆ¼X xâ‚) = ?-âŠ‘
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â˜… â˜…âŠ‘â˜… â˜…âˆ¼â˜… â˜…âˆ¼â˜… = id-âŠ‘ â˜…âŠ‘â˜…
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â˜… (â˜…âŠ‘X âˆ‹X) â˜…âˆ¼â˜… (â˜…âˆ¼X xâ‚) = id-âŠ‘-? (â˜…âŠ‘X xâ‚)
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â˜… â˜…âŠ‘â„• â˜…âˆ¼â˜… â˜…âˆ¼â„• = id-âŠ‘-? â˜…âŠ‘â„•
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â˜… (â˜…âŠ‘â‡’ cc ccâ‚) â˜…âˆ¼â˜… (â˜…âˆ¼â‡’ bcâ€² bcâ€²â‚) =
  âŠ‘-â¨Ÿ (id-âŠ‘-? (â˜…âŠ‘â‡’ â˜…âŠ‘â˜… â˜…âŠ‘â˜…)) (idâ˜…-âŠ‘-â†¦ {!!} {!!})
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â˜… (â‡’âŠ‘â‡’ cc ccâ‚) (â˜…âˆ¼â‡’ bc bcâ‚) (â˜…âˆ¼â‡’ bcâ€² bcâ€²â‚) =
  â¨Ÿ-âŠ‘-â¨Ÿ ?-âŠ‘ (â†¦-âŠ‘ (âˆ¼â‡-âŠ‘-âˆ¼â‡ â˜…âŠ‘â˜… cc bc bcâ€²) (âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â˜… ccâ‚ bcâ‚ bcâ€²â‚))
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â˜… (âˆ€âŠ‘âˆ€ cc) bc bcâ€² = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â˜… (âŠ‘âˆ€ cc) bc bcâ€² = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (â˜…âŠ‘X x) XâŠ‘X (â˜…âˆ¼X xâ‚) Xâˆ¼X = ?-âŠ‘-id XâŠ‘X
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (â˜…âŠ‘X x) â˜…âŠ‘â˜… â˜…âˆ¼â˜… (Xâˆ¼â˜… xâ‚) = id-âŠ‘-! (â˜…âŠ‘X x)
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (â˜…âŠ‘X x) (â˜…âŠ‘X xâ‚) â˜…âˆ¼â˜… Xâˆ¼X = id-âŠ‘ (â˜…âŠ‘X x)
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (â˜…âŠ‘X x) (âˆ€âŠ‘âˆ€ cc) bc bcâ€² = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (â˜…âŠ‘X x) (âŠ‘âˆ€ cc) bc bcâ€² = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â„• â„•âŠ‘â„• â˜…âˆ¼â„• â„•âˆ¼â„• = ?-âŠ‘-id â„•âŠ‘â„•
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â„• â˜…âŠ‘â˜… â˜…âˆ¼â˜… â„•âˆ¼â˜… = id-âŠ‘-! â˜…âŠ‘â„•
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â„• â˜…âŠ‘â„• â˜…âˆ¼â˜… â„•âˆ¼â„• = id-âŠ‘ â˜…âŠ‘â„•
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â„• (âˆ€âŠ‘âˆ€ cc) bc bcâ€² = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ â˜…âŠ‘â„• (âŠ‘âˆ€ cc) bc bcâ€² = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (â˜…âŠ‘â‡’ bb bbâ‚) â˜…âŠ‘â˜… â˜…âˆ¼â˜… (â‡’âˆ¼â˜… bcâ€² bcâ€²â‚) =
  âŠ‘-â¨Ÿ (idâ˜…-âŠ‘-â†¦ {!!} {!!}) (id-âŠ‘-! (â˜…âŠ‘â‡’ â˜…âŠ‘â˜… â˜…âŠ‘â˜…))
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (â˜…âŠ‘â‡’ bb bbâ‚) (â˜…âŠ‘â‡’ cc ccâ‚) â˜…âˆ¼â˜… (â‡’âˆ¼â‡’ bcâ€² bcâ€²â‚) =
  idâ˜…-âŠ‘-â†¦ {!!} {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (â˜…âŠ‘â‡’ bb bbâ‚) (â‡’âŠ‘â‡’ cc ccâ‚) (â˜…âˆ¼â‡’ bc bcâ‚) (â‡’âˆ¼â‡’ bcâ€² bcâ€²â‚) =
  â¨Ÿ-âŠ‘ (?-âŠ‘-â†¦ (â˜…âŠ‘â‡’ bb bbâ‚) (â‡’âŠ‘â‡’ {!!} {!!}))
      (â†¦-âŠ‘ (âˆ¼â‡-âŠ‘-âˆ¼â‡ bb cc bc bcâ€²) (âˆ¼â‡’-âŠ‘-âˆ¼â‡’ bbâ‚ ccâ‚ bcâ‚ bcâ€²â‚))
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (â˜…âŠ‘â‡’ bb bbâ‚) (âˆ€âŠ‘âˆ€ cc) bc bcâ€² = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (â˜…âŠ‘â‡’ bb bbâ‚) (âŠ‘âˆ€ cc) bc bcâ€² = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (â‡’âŠ‘â‡’ bb bbâ‚) â˜…âŠ‘â˜… (â‡’âˆ¼â˜… bc bcâ‚) (â‡’âˆ¼â˜… bcâ€² bcâ€²â‚) =
  â¨Ÿ-âŠ‘-â¨Ÿ (â†¦-âŠ‘ (âˆ¼â‡-âŠ‘-âˆ¼â‡ bb â˜…âŠ‘â˜… bc bcâ€²) (âˆ¼â‡’-âŠ‘-âˆ¼â‡’ bbâ‚ â˜…âŠ‘â˜… bcâ‚ bcâ€²â‚)) !-âŠ‘
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (â‡’âŠ‘â‡’ bb bbâ‚) (â˜…âŠ‘â‡’ cc ccâ‚) (â‡’âˆ¼â˜… bc bcâ‚) (â‡’âˆ¼â‡’ bcâ€² bcâ€²â‚) =
  â¨Ÿ-âŠ‘ (â†¦-âŠ‘ (âˆ¼â‡-âŠ‘-âˆ¼â‡ bb cc bc bcâ€²) (âˆ¼â‡’-âŠ‘-âˆ¼â‡’ bbâ‚ ccâ‚ bcâ‚ bcâ€²â‚))
      (!-âŠ‘-â†¦ (â‡’âŠ‘â‡’ {!!} {!!}) (â˜…âŠ‘â‡’ cc ccâ‚))
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (â‡’âŠ‘â‡’ bb bbâ‚) (â‡’âŠ‘â‡’ cc ccâ‚) (â‡’âˆ¼â‡’ bc bcâ‚) (â‡’âˆ¼â‡’ bcâ€² bcâ€²â‚) =
  â†¦-âŠ‘ (âˆ¼â‡-âŠ‘-âˆ¼â‡ bb cc bc bcâ€²) (âˆ¼â‡’-âŠ‘-âˆ¼â‡’ bbâ‚ ccâ‚ bcâ‚ bcâ€²â‚)
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (â‡’âŠ‘â‡’ bb bbâ‚) (âˆ€âŠ‘âˆ€ cc) bc bcâ€² = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (â‡’âŠ‘â‡’ bb bbâ‚) (âŠ‘âˆ€ cc) bc bcâ€² = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (âˆ€âŠ‘âˆ€ bb) cc bc bcâ€² = {!!}
âˆ¼â‡’-âŠ‘-âˆ¼â‡’ (âŠ‘âˆ€ bb) cc bc bcâ€² = {!!}

âˆ¼â‡-âŠ‘-âˆ¼â‡ bb cc bc bcâ€² = {!!}

compile-pres-precision : âˆ€{Î”}{Î“ Î“â€² : Ctx Î”}{Î¦ : PrecCtx Î“ Î“â€²}
  {A Aâ€² : Type Î”} {AâŠ‘Aâ€² : Î” âˆ£ mt Î” âŠ¢ A âŠ‘ Aâ€²}
  {M : Î” âˆ£ Î“ âŠ¢áµ A} {Mâ€² : Î” âˆ£ Î“â€² âŠ¢áµ Aâ€²}
  â†’ Î” âˆ£ Î¦ âŠ¢áµ M âŠ‘ Mâ€² â¦‚ AâŠ‘Aâ€²
  â†’ [] âˆ£ [] âˆ£ Î¦ âŠ© compile M âŠ‘ compile Mâ€² â¦‚ AâŠ‘Aâ€²
compile-pres-precision (âŠ‘-var âˆ‹âŠ‘) = âŠ‘-var âˆ‹âŠ‘
compile-pres-precision âŠ‘-nat = âŠ‘-nat
compile-pres-precision (âŠ‘-lam MâŠ‘Mâ€²) = âŠ‘-lam (compile-pres-precision MâŠ‘Mâ€²)
compile-pres-precision (âŠ‘-app{a = a}{b}{d}{f}{bc}{fâ€²}{bcâ€²} LâŠ‘Lâ€² MâŠ‘Mâ€²) =
    let IH1 = compile-pres-precision LâŠ‘Lâ€² in
    let IH2 = compile-pres-precision MâŠ‘Mâ€² in
    let cc = âŠ‘-âµ-âµ-âŠ‘ a f fâ€² in
    âŠ‘-app (âŠ‘-âŸ¨âŸ© IH1 (âµâ‡’-âŠ‘-âµâ‡’ a f fâ€²)) (âŠ‘-âŸ¨âŸ© IH2 (âˆ¼â‡’-âŠ‘-âˆ¼â‡’ b cc bc bcâ€²))
compile-pres-precision (âŠ‘-Î› NâŠ‘Nâ€²) = {!!}
compile-pres-precision (âŠ‘-â—¯ MâŠ‘Mâ€²) = {!!}
