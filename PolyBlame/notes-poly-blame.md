
# Polymorphic Cast Calculus (PCC, Internal Language)

## Syntax

    Types         A, B, C  ::=  ╬╣ | X | A Рєњ B | РѕђX.A | РўЁ
    Ground Types  G, H     ::=  ╬╣ | X | РўЁРєњРўЁ
    Terms         L, M, N  ::=  x | ╬╗x.N | ╬ЏX.V | L M | L[X] | ╬йX=A.M
                             | MРЪеcРЪЕ | blame
    Values        V, W     ::= ╬╗x.N | ╬ЏX.V | VРЪеc Рєњ dРЪЕ | VРЪеРѕђX.cРЪЕ | VРЪе­Юњб X.cРЪЕ
                             | VРЪеG!РЪЕ | VРЪеX-РЪЕ 
    Coercions     c, d     ::= id | G? | G! | X- | X+ | c Рєњ d | c ; d
                             | РѕђX.c | ­Юњб X.c | Рёљ X.c

    Environments  ╬Њ        ::=  РѕЁ | ╬Њ, x:A | ╬Њ, X | ╬Њ, X:=A

## Reductions

    ----------
    | M РђћРєњ N |
    ----------

    (╬╗x.N) V               РђћРєњ  N[V/x]
    (╬ЏX.V)[Y]              РђћРєњ  V[Y/X]
    VРЪеРѕђX.cРЪЕ[Y]             РђћРєњ  V[Y]РЪеc[Y/X]РЪЕ
    VРЪе­Юњб X.cРЪЕ[Y]            РђћРєњ  VРЪеc[Y/X]РЪЕ
    
    VРЪеРёљ X.cРЪЕ               РђћРєњ  ╬йX=РўЁ. V[X]РЪеcРЪЕ
    
    VРЪеidРЪЕ                  РђћРєњ  V
    VРЪеX-РЪЕРЪеX+РЪЕ              РђћРєњ  V
    VРЪеG!РЪЕРЪеG?РЪЕ              РђћРєњ  V
    VРЪеG!РЪЕРЪеH?lРЪЕ             РђћРєњ  blame l    (G =╠И H)
    VРЪеc Рєњ dРЪЕ W             РђћРєњ  (V WРЪеcРЪЕ)РЪеdРЪЕ
    VРЪеc ; dРЪЕ               РђћРєњ  VРЪеcРЪЕРЪеdРЪЕ

    ------------------
    | ╬Б Ріб M РђћРєњ ╬Б Ріб N |
    ------------------
    
    M РђћРєњ N
    --------------
    ╬Б Ріб M РђћРєњ ╬Б Ріб N

    ╬Б Ріб M РђћРєњ ╬БРђ▓ Ріб N
    ---------------------
    ╬Б Ріб F[M] РђћРєњ ╬БРђ▓ Ріб F[N]

    -------------------------
    ╬Б Ріб ╬йX=B.N РђћРєњ  ╬Б, X=B Ріб N
    

## Coercion Typing

    -----------------
    | ╬Њ Ріб c : A РЄњ B |
    -----------------

    ╬Њ Ріб A
    --------------
    ╬Њ Ріб id : A РЄњ A

    ╬Њ Ріб G
    ---------------
    ╬Њ Ріб G? : РўЁ РЄњ G

    ╬Њ Ріб G
    ---------------
    ╬Њ Ріб G! : G РЄњ РўЁ
        
    --------------- (X=A Рѕѕ ╬Њ)
    ╬Њ Ріб X- : A РЄњ X

    --------------- (X=A Рѕѕ ╬Њ)
    ╬Њ Ріб X+ : X РЄњ A

    ╬Њ, X Ріб c : A РЄњ B
    ------------------------
    ╬Њ Ріб ­Юњб X. c : A РЄњ РѕђX.B

    ╬Њ, X=РўЁ Ріб c : A РЄњ B
    ------------------------
    ╬Њ Ріб Рёљ X.c : РѕђX.A РЄњ B

    ╬Њ, X Ріб c : A РЄњ B
    ------------------------
    ╬Њ Ріб Рѕђ X.c : РѕђX.A РЄњ РѕђX.B

    ╬Њ Ріб c : C РЄњ A   ╬Њ Ріб d : B РЄњ D
    ------------------------------
    ╬Њ Ріб c Рєњ d : A Рєњ B РЄњ C Рєњ D

    ╬Њ Ріб c : A РЄњ B   ╬Њ Ріб d : B РЄњ C
    ------------------------------
    ╬Њ Ріб c ; d : A РЄњ C


## Type System

    -------------
    | ╬Њ Ріб M : A |
    -------------

    ╬Њ Ріб M : A   ╬Њ Ріб c : A РЄњ B
    --------------------------         Cast
    ╬Њ Ріб MРЪеcРЪЕ : B

    ╬Њ Ріб L : РѕђX.A
    -----------------                  Type application
    ╬Њ Ріб L[X] : A

    ╬Њ, X:=A Ріб N : B
    --------------- (X РѕЅ B)            Generate fresh type variable
    ╬Њ Ріб ╬йX=A.N : B

    x:A Рѕѕ ╬Њ
    ---------
    ╬Њ Ріб x : A

    ╬Њ Ріб A ok  ╬Њ, x:A Ріб N : B
    ------------------------
    ╬Њ Ріб ╬╗x:A.N : A Рєњ B

    ╬Њ Ріб L : A Рєњ B     ╬Њ Ріб M : A
    ---------------------------
    ╬Њ Ріб L M : B

    ╬Њ, X Ріб V : B
    ---------------
    ╬Њ Ріб ╬ЏX.V : РѕђX.B


## Configuration Typing

    ---------
    | ╬Њ Ріб ╬Б |
    ---------

    ------
    РѕЁ Ріб РѕЁ

    -------------
    ╬Њ, X=A Ріб ╬Б, X

    -------------
    | ╬Б Ріб M : A |
    -------------

    ╬Њ Ріб ╬Б   ╬Њ Ріб M : A
    -----------------
    ╬Б Ріб M : A

## Term Precision (for the Gradual Guarantee)

TODO

# Polymorphic Gradually Typed Lambda Calculus (Surface Language, PGL)

## Syntax

    Type Variables X, Y, Z
    Base Types     ╬╣
    Types         A, B, C  ::=  ╬╣ | X | A Рєњ B | РѕђX.A | РўЁ
    Terms         L, M, N  ::=  k | x | ╬╗x:A.N | ╬ЏX.V | L M | L[A] | M : A
    Values        V, W     ::=  k | ╬╗x:A.N | ╬ЏX.V
    Environments  ╬Њ        ::=  РѕЁ | ╬Њ, x:A | ╬Њ, X

# Free Type Variables

    FV(X) = {X}
    FV(A Рєњ B) = FV(A) Рѕф FV(B)
    FV(РѕђX.A) = FV(A) - {X}
    FV(РўЁ) = РѕЁ

## Consistency

    Consistency Context   ╬е ::= РѕЁ | ╬е, X

    -------------
    | ╬е Ріб A ~ B |
    -------------

    ----------
    ╬е Ріб ╬╣ ~ ╬╣

    ----------
    ╬е Ріб X ~ X

    ----------
    ╬е Ріб РўЁ ~ РўЁ

    ---------- (X Рѕѕ ╬е)
    ╬е Ріб РўЁ ~ X

    ---------- (X Рѕѕ ╬е)
    ╬е Ріб X ~ РўЁ

    ---------
    ╬е Ріб РўЁ ~ ╬╣

    ---------
    ╬е Ріб ╬╣ ~ РўЁ

    ╬е Ріб РўЁ ~ A   ╬е Ріб РўЁ ~ B
    ----------------------
    ╬е Ріб РўЁ ~ A Рєњ B

    ╬е Ріб A ~ РўЁ   ╬е Ріб B ~ РўЁ
    ----------------------
    ╬е Ріб A Рєњ B ~ РўЁ

    ╬е, X Ріб A ~ B
    ------------- (X Рѕѕ A)
    ╬е Ріб РѕђX.A ~ B

    ╬е, X Ріб A ~ B
    ------------- (X Рѕѕ B)
    ╬е Ріб A ~ РѕђX.B

    ╬е Ріб A ~ AРђ▓  ╬е Ріб B ~ BРђ▓
    ----------------------
    ╬е Ріб A Рєњ B ~ AРђ▓ Рєњ BРђ▓
    
    ╬е Ріб A ~ AРђ▓
    -----------------
    ╬е Ріб РѕђX.A ~ РѕђX.AРђ▓

    ╬е, X Ріб A ~ B
    -------------- (B =╠И РѕђY.C, X РѕЅ B)
    ╬е Ріб РѕђX.A ~ B

    ╬е, X Ріб A ~ B
    -------------- (A =╠И РѕђY.C, X РѕЅ A)
    ╬е Ріб A ~ РѕђX.B

## Precision

    -------------
    | ╬е Ріб A РіЉ B |
    -------------

    ----------
    ╬е Ріб ╬╣ РіЉ ╬╣

    ----------
    ╬е Ріб X РіЉ X

    ----------
    ╬е Ріб РўЁ РіЉ РўЁ

    ---------- (X Рѕѕ ╬е)
    ╬е Ріб РўЁ РіЉ X

    ---------
    ╬е Ріб РўЁ РіЉ ╬╣

    ╬е Ріб РўЁ РіЉ A   ╬е Ріб РўЁ РіЉ B
    ----------------------
    ╬е Ріб РўЁ РіЉ A Рєњ B

    ╬е Ріб A РіЉ AРђ▓  ╬е Ріб B РіЉ BРђ▓
    ----------------------
    ╬е Ріб A Рєњ B РіЉ AРђ▓ Рєњ BРђ▓
    
    ╬е Ріб A РіЉ AРђ▓
    -----------------
    ╬е Ріб РѕђX.A РіЉ РѕђX.AРђ▓

    ╬е, X Ріб A РіЉ B
    -------------- (A =╠И РѕђY.C, X РѕЅ A, X Рѕѕ B)
    ╬е Ріб A РіЉ РѕђX.B


## Well-formed Types

TODO

## Type System

    (x:A) Рѕѕ ╬Њ
    ---------
    ╬Њ РібрхЇ x : A

    ╬Њ Ріб A ok  ╬Њ, x:A РібрхЇ N : B
    ------------------------
    ╬Њ РібрхЇ ╬╗x:A.N : A Рєњ B

    ╬Њ РібрхЇ L : A Рєњ B     ╬Њ РібрхЇ M : AРђ▓
    РѕЁ РібрхЇ A Рѕ╝ AРђ▓ 
    ---------------------------
    ╬Њ РібрхЇ L M : B

    ╬Њ РібрхЇ L : РўЁ     ╬Њ РібрхЇ M : A
    -----------------------
    ╬Њ РібрхЇ L M : РўЁ

    ╬Њ, X РібрхЇ V : B
    ---------------
    ╬Њ РібрхЇ ╬ЏX.V : РѕђX.B

    ╬Њ РібрхЇ L : РѕђX.A    ╬Њ Ріб B ok
    ------------------------
    ╬Њ РібрхЇ L[B] : A[B/X]

    ╬Њ РібрхЇ L : A    ╬Њ Ріб B ok
    --------------------- (A РЅа РѕђX.A' for any A')
    ╬Њ РібрхЇ L[B] : A

    ╬Њ РібрхЇ M : AРђ▓   ╬Њ Ріб A ok
    --------------------- (РѕЁ Ріб AРђ▓ ~ A)
    ╬Њ РібрхЇ (M : A) : A
    
## Term Precision

TODO

# Compilation From PGL to PCC

## Compilation of Conversions

    ----------------------
    | ­ЮњъРЪд ╬Њ Ріб A РЄњ B РЪД = c |
    ----------------------
    
    ­ЮњъРЪд ╬Њ Ріб ╬╣ РЄњ ╬╣ РЪД        = id
    ­ЮњъРЪд ╬Њ Ріб РўЁ РЄњ РўЁ РЪД       = id
    ­ЮњъРЪд ╬Њ Ріб X РЄњ X РЪД       = id
    ­ЮњъРЪд ╬Њ Ріб G РЄњ РўЁ РЪД       = G!    if G РЅа X or (G = X and X Рѕѕ ╬Њ)
    ­ЮњъРЪд ╬Њ Ріб РўЁ РЄњ G РЪД       = G?    if G РЅа X or (G = X and X Рѕѕ ╬Њ)
    ­ЮњъРЪд ╬Њ Ріб A РЄњ X РЪД = X-      if X=A Рѕѕ ╬Њ
    ­ЮњъРЪд ╬Њ Ріб X РЄњ B РЪД = X+      if X=B Рѕѕ ╬Њ
    ­ЮњъРЪд ╬Њ Ріб (A Рєњ B) РЄњ РўЁ РЪД = (c Рєњ d) ; РўЁРєњРўЁ!
       where
       ­ЮњъРЪд ╬Њ Ріб РўЁ РЄњ A РЪД = c
       ­ЮњъРЪд ╬Њ Ріб B РЄњ РўЁ РЪД = d
    ­ЮњъРЪд ╬Њ Ріб РўЁ РЄњ (A Рєњ B) РЪД = РўЁРєњРўЁ? ; (c Рєњ d)     (A =╠И РўЁ, B =╠И РўЁ)
       where
       ­ЮњъРЪд ╬Њ Ріб A РЄњ РўЁ РЪД = c
       ­ЮњъРЪд ╬Њ Ріб РўЁ РЄњ B РЪД = d
    ­ЮњъРЪд ╬Њ Ріб (A Рєњ B) РЄњ (AРђ▓ Рєњ BРђ▓) РЪД = c Рєњ d
       where
       ­ЮњъРЪд ╬Њ Ріб AРђ▓ РЄњ A РЪД = c
       ­ЮњъРЪд ╬Њ Ріб B РЄњ BРђ▓ РЪД = d
    ­ЮњъРЪд ╬Њ Ріб A РЄњ РѕђX.B РЪД = ­Юњб X. c
           where
           ­ЮњъРЪд ╬Њ, X Ріб A РЄњ B РЪД = c
    ­ЮњъРЪд ╬Њ Ріб РѕђX.A РЄњ B РЪД = Рёљ X. c
           where
           ­ЮњъРЪд ╬Њ, X:=РўЁ Ріб A РЄњ B РЪД = c
    ­ЮњъРЪд ╬Њ Ріб РѕђX.A РЄњ РѕђX.B РЪД = РѕђX.c
           where
           ­ЮњъРЪд ╬Њ, X Ріб A РЄњ B РЪД = c

## Compilation of Terms

    -----------------------
    | ­ЮњъРЪд ╬Њ РібрхЇ M : A РЪД = MРђ▓ |
    -----------------------

    ­ЮњъРЪд ╬Њ РібрхЇ x : A РЪД          = x

    ­ЮњъРЪд ╬Њ РібрхЇ ╬╗x:A.N : A Рєњ B РЪД = ╬╗x.NРђ▓
       where
       ­ЮњъРЪд ╬Њ,x:A РібрхЇ N : B РЪД   = NРђ▓

    ­ЮњъРЪд ╬Њ РібрхЇ L M : BРЪД         = LРђ▓  MРђ▓РЪеcРЪЕ
       where
       ­ЮњъРЪд ╬Њ РібрхЇ L : A Рєњ BРЪД = LРђ▓
       ­ЮњъРЪд ╬Њ РібрхЇ M : AРђ▓ РЪД   = MРђ▓
       ­ЮњъРЪд AРђ▓ РЄњ A РЪД       = c

    ­ЮњъРЪд ╬Њ РібрхЇ L M : РўЁРЪД         = LРђ▓РЪеcРЪЕ  MРђ▓РЪеdРЪЕ
       where
       ­ЮњъРЪд ╬Њ РібрхЇ L : РўЁРЪД   = LРђ▓
       ­ЮњъРЪд ╬Њ РібрхЇ M : A РЪД  = MРђ▓
       ­ЮњъРЪд РѕЁ Ріб РўЁ РЄњ РўЁ Рєњ РўЁ РЪД = c
       ­ЮњъРЪд A РЄњ РўЁ РЪД      = d

    ­ЮњъРЪд ╬Њ РібрхЇ L[B] : A[B/X] РЪД = ╬йX=B. LРђ▓[X] РЪеcРЪЕ
       where
       ­ЮњъРЪд ╬Њ РібрхЇ L : РѕђX.A РЪД = LРђ▓
       ­ЮњъРЪд X=B Ріб A РЄњ A[B/X] РЪД = c

    ­ЮњъРЪд ╬Њ РібрхЇ L[B] : A РЪД = ╬йX=B. LРђ▓РЪеcРЪЕ[X]
       where
       ­ЮњъРЪд ╬Њ РібрхЇ L : A РЪД = LРђ▓
           ­ЮњъРЪд РѕЁ Ріб A РЄњ РѕђX.A РЪД = c

