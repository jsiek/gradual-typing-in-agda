

# Polymorphic Gradually Typed Lambda Calculus (Surface Language, PGL)

## Syntax

    Types         A, B, C  ::=  X | A â†’ B | âˆ€X.A | â˜…
    Terms         L, M, N  ::=  x | Î»x:A.N | Î›X.M | L M | L[A] | M : A
    Environments  Î“        ::=  âˆ… | Î“, x:A | Î“, X

# Free Type Variables

    FV(X) = {X}
    FV(A â†’ B) = FV(A) âˆª FV(B)
    FV(âˆ€X.A) = FV(A) - {X}
    FV(â˜…) = âˆ…

## Consistency

    Consistency Context   Î¨ ::= âˆ… | Î¨,X

    -------------
    | Î¨ âŠ¢ A ~ B |
    -------------

    ----------
    Î¨ âŠ¢ Î¹ ~ Î¹

    --------- (FV(A) âŠ† Î¨)     ---------- (FV(A) âŠ† Î¨)
    Î¨ âŠ¢ â˜… ~ A                 Î¨ âŠ¢ A ~ â˜…

    Î¨ âŠ¢ A ~ Aâ€²  Î¨ âŠ¢ B ~ Bâ€²
    -----------------------
    Î¨ âŠ¢ A â†’ B ~ Aâ€² â†’ Bâ€²
    
    Î¨ âŠ¢ A ~ Aâ€²
    -----------------
    Î¨ âŠ¢ âˆ€X.A ~ âˆ€X.Aâ€²

    Î¨,X âŠ¢ A ~ B
    ------------- (B =Ì¸ âˆ€Y.C, X âˆ‰ B)
    Î¨ âŠ¢ âˆ€X.A ~ B

    Î¨,X âŠ¢ A ~ B
    ------------- (A =Ì¸ âˆ€Y.C, X âˆ‰ A)
    Î¨ âŠ¢ A ~ âˆ€X.B

## Well-formed Types


## Type System

    (x:A) âˆˆ Î“
    ---------
    Î“ âŠ¢ x : A

    Î“ âŠ¢ A ok  Î“, x:A âŠ¢ N : B
    ------------------------
    Î“ âŠ¢ Î»x:A.N : A â†’ B

    Î“ âŠ¢ L : A â†’ B     Î“ âŠ¢ M : A
    ---------------------------
    Î“ âŠ¢ L M : B

    Î“ âŠ¢ L : â˜…     Î“ âŠ¢ M : A
    -----------------------
    Î“ âŠ¢ L M : â˜…

    Î“, X âŠ¢ M : B
    ---------------
    Î“ âŠ¢ Î›X.M : âˆ€X.B

    Î“ âŠ¢ L : âˆ€X.A    Î“ âŠ¢ B ok
    ------------------------
    Î“ âŠ¢ L[B] : A[B/X]

    Î“ âŠ¢ L : â˜…    Î“ âŠ¢ B ok
    ---------------------
    Î“ âŠ¢ L[B] : â˜…

    Î“ âŠ¢ M : Aâ€²
    --------------- (Aâ€² ~ A)
    Î“ âŠ¢ (M : A) : A
    
## Term Precision



# Polymorphic Cast Calculus (PCC, Internal Language)

## Syntax

    Types         A, B, C  ::=  X | A â†’ B | âˆ€X.A | â˜… | Î±
    Ground Types  G, H     ::=  Î¹ | â˜…â†’â˜… | Î±
    Terms         L, M, N  ::=  x | Î»x.N | Î›X.M | L M | L[Î±] | Î½Î±.M
	                         | MâŸ¨câŸ© | blame
    Values        V, W     ::= Î»x.N | Î›X.M | VâŸ¨gen Î±.câŸ©
    Coercions     c, d     ::= id | G? | G! | Î±â†“ | Î±â†‘ | c â†’ d | c ; d
                             | âˆ€X.c | gen Î±.c | inst Î±.c

    Environments  Î“        ::=  âˆ… | Î“, x:A | Î“, X | Î“, Î±=A

## Reductions

    ----------
    | M â€”â†’ N |
    ----------

    (Î»x.N) V              â€”â†’  N[V/x]
    (Î›X.M)[Î²]             â€”â†’  M[Î²/X]
	VâŸ¨gen Î±.câŸ©[Î²]          â€”â†’ VâŸ¨c[Î²/Î±]âŸ©
    VâŸ¨idâŸ©                  â€”â†’  V
    VâŸ¨Î±â†“âŸ©âŸ¨Î±â†‘âŸ©              â€”â†’  V
    VâŸ¨G!âŸ©âŸ¨G?âŸ©              â€”â†’  V
    VâŸ¨G!âŸ©âŸ¨H?âŸ©              â€”â†’  blame    (G =Ì¸ H)
    VâŸ¨c â†’ dâŸ©              â€”â†’  Î»x. (V xâŸ¨câŸ©)âŸ¨dâŸ©
    VâŸ¨inst Î±.câŸ©           â€”â†’  Î½Î±. V[Î±]âŸ¨câŸ©
    VâŸ¨âˆ€X.câŸ©               â€”â†’  Î›X. VâŸ¨câŸ©
	VâŸ¨c ; dâŸ©              â€”â†’ VâŸ¨câŸ©âŸ¨dâŸ©

    ------------------
    | Î£ âŠ¢ M â€”â†’ Î£ âŠ¢ N |
    ------------------
    
    M â€”â†’ N
    --------------
    Î£ âŠ¢ M â€”â†’ Î£ âŠ¢ N

    Î£ âŠ¢ M â€”â†’ Î£â€² âŠ¢ N
    ---------------------
    Î£ âŠ¢ F[M] â€”â†’ Î£â€² âŠ¢ F[N]

    -------------------------- (Î² âˆ‰ Î£)
    Î£ âŠ¢ Î½Î±.N â€”â†’  Î£, Î² âŠ¢ N[Î²/Î±]
    

## Coercion Typing

    -----------------
    | Î“ âŠ¢ c : A â‡’ B |
    -----------------

    --------------
    Î“ âŠ¢ id : A â‡’ A

    --------------
    Î“ âŠ¢ G? : â˜… â‡’ G

    --------------
    Î“ âŠ¢ G! : G â‡’ â˜…
	
    -------------- (Î±=A âˆˆ Î“)
    Î“ âŠ¢ Î±â†“ : A â‡’ Î±

    -------------- (Î±=A âˆˆ Î“)
    Î“ âŠ¢ Î±â†‘ : Î± â‡’ A

    Î“ âŠ¢ c : A â‡’ B[Î±/X]
    ----------------------
    Î“ âŠ¢ gen Î±.c : A â‡’ âˆ€X.B

    Î“ âŠ¢ c : A[Î±/X] â‡’ B
    -----------------------
    Î“ âŠ¢ inst Î±.c : âˆ€X.A â‡’ B


## Type System

    -------------
    | Î“ âŠ¢ M : A |
    -------------

    Î“ âŠ¢ M : A   Î“ âŠ¢ c : A â‡’ B
    -------------------------          Cast
    Î“ âŠ¢ MâŸ¨câŸ© : B

    Î“ âŠ¢ L : âˆ€X.A
    ----------------- (Î±=B âˆˆ Î“)        Type application
    Î“ âŠ¢ L[Î±] : A[Î±/X]

    Î“, Î±=A âŠ¢ N : B
    --------------- (Î± âˆ‰ B)            Generate fresh type variable
    Î“ âŠ¢ Î½Î±.N : B

## Configuration Typing

    ---------
    | Î“ âŠ¢ Î£ |
    ---------

    ------
    âˆ… âŠ¢ âˆ…

    -------------
    Î“, Î±=A âŠ¢ Î£, Î±

    -------------
    | Î£ âŠ¢ M : A |
    -------------

    Î“ âŠ¢ Î£   Î“ âŠ¢ M : A
    -----------------
    Î£ âŠ¢ M : A

## Term Precision (for the Gradual Guarantee)



# Compilation From PGL to PCC

## Compilation of Conversions

    ------------------
    | ğ’âŸ¦ A â‡’ B âŸ§ = c |
    ------------------
    
    ğ’âŸ¦ G â‡’ â˜… âŸ§ = G!
	
    ğ’âŸ¦ â˜… â‡’ G âŸ§ = G?
	
    ğ’âŸ¦ (A â†’ B) â‡’ â˜… âŸ§ = (c â†’ d) ; â˜…â†’â˜…!
       where
       ğ’âŸ¦ â˜… â‡’ A âŸ§ = c
       ğ’âŸ¦ B â‡’ â˜… âŸ§ = d

    ğ’âŸ¦ â˜… â‡’ (A â†’ B) âŸ§ = â˜…â†’â˜…? ; (c â†’ d)     (A =Ì¸ â˜…, B =Ì¸ â˜…)
       where
       ğ’âŸ¦ A â‡’ â˜… âŸ§ = c
       ğ’âŸ¦ â˜… â‡’ B âŸ§ = d
	
    ğ’âŸ¦ A â‡’ Î± âŸ§ = Î±â†“

    ğ’âŸ¦ Î± â‡’ B âŸ§ = Î±â†‘
	
    ğ’âŸ¦ (A â†’ B) â‡’ (Aâ€² â†’ Bâ€²) âŸ§ = c â†’ d
       where
       ğ’âŸ¦ Aâ€² â‡’ A âŸ§ = c
       ğ’âŸ¦ B â‡’ Bâ€² âŸ§ = d

    ğ’âŸ¦ A â‡’ A âŸ§        = id
    
    ğ’âŸ¦ A â‡’ âˆ€X.B âŸ§ = gen Î±. c
	   where
	   ğ’âŸ¦ A â‡’ B[Î±/X] âŸ§ = c
	   
    ğ’âŸ¦ âˆ€X.A â‡’ B âŸ§ = inst Î±. c
	   where
	   ğ’âŸ¦ A[Î±]X] â‡’ B âŸ§ = c
	   
    ğ’âŸ¦ âˆ€X.A â‡’ âˆ€X.B âŸ§ = âˆ€X.c
	   where
	   ğ’âŸ¦ A â‡’ B âŸ§ = c

## Compilation of Terms

    -----------------------
    | ğ’âŸ¦ Î“ âŠ¢ M : A âŸ§ = Mâ€² |
    -----------------------

    ğ’âŸ¦ Î“ âŠ¢ x : A âŸ§          = x

    ğ’âŸ¦ Î“ âŠ¢ Î»x:A.N : A â†’ B âŸ§ = Î»x.Nâ€²
       where
       ğ’âŸ¦ Î“,x:A âŠ¢ N : B âŸ§   = Nâ€²

    ğ’âŸ¦ Î“ âŠ¢ L M : BâŸ§         = Lâ€² (Nâ€² Mâ€²)
       where
       ğ’âŸ¦ Î“ âŠ¢ L : A â†’ BâŸ§ = Lâ€²
       ğ’âŸ¦ Î“ âŠ¢ M : Aâ€² âŸ§   = Mâ€²
       ğ’âŸ¦ A â‡’ Aâ€² âŸ§       = Nâ€²

    ğ’âŸ¦ Î“ âŠ¢ L M : â˜…âŸ§         = (Nâ‚ L)â€² (Nâ‚‚ Mâ€²)
       where
       ğ’âŸ¦ Î“ âŠ¢ L : â˜…âŸ§   = Lâ€²
       ğ’âŸ¦ Î“ âŠ¢ M : A âŸ§  = Mâ€²
       ğ’âŸ¦ â˜… â‡’ â˜… â†’ â˜… âŸ§ = Nâ‚
       ğ’âŸ¦ A â‡’ â˜… âŸ§      = Nâ‚‚

    ğ’âŸ¦ Î“ âŠ¢ L[B] : A[B/X] âŸ§ = Î½Î±. Mâ€² Lâ€²[Â·]
       where
       ğ’âŸ¦ Î“ âŠ¢ L : âˆ€X.A âŸ§ = Lâ€²
       ğ’âŸ¦ A[Î±/X] â‡’ A[B/X] âŸ§ = Mâ€²

    ğ’âŸ¦ Î“ âŠ¢ L[B] : â˜… âŸ§ = Î½Î±. (N Lâ€²)[Î±]
       where
       ğ’âŸ¦ Î“ âŠ¢ L : â˜… âŸ§ = Lâ€²
	   ğ’âŸ¦ â˜… â‡’ âˆ€X.â˜… âŸ§ = N
