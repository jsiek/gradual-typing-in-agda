

# Polymorphic Gradually Typed Lambda Calculus (Surface Language, PGL)

## Syntax

    Type Variables X, Y, Z
    Base Types     Î¹
    Types         A, B, C  ::=  Î¹ | X | A â†’ B | âˆ€X.A | â˜…
    Terms         L, M, N  ::=  k | x | Î»x:A.N | Î›X.V | L M | L[A] | M : A
    Values        V, W     ::=  k | Î»x:A.N | Î›X.V
    Environments  Î“        ::=  âˆ… | Î“, x:A | Î“, X

# Free Type Variables

    FV(X) = {X}
    FV(A â†’ B) = FV(A) âˆª FV(B)
    FV(âˆ€X.A) = FV(A) - {X}
    FV(â˜…) = âˆ…

## Consistency

    Consistency Context   Î¨ ::= âˆ… | Î¨, X

    -------------
    | Î¨ âŠ¢ A ~ B |
    -------------

    ----------
    Î¨ âŠ¢ Î¹ ~ Î¹

    ----------
    Î¨ âŠ¢ X ~ X

    ----------
    Î¨ âŠ¢ â˜… ~ â˜…

    ---------- (X âˆˆ Î¨)
    Î¨ âŠ¢ â˜… ~ X

    ---------- (X âˆˆ Î¨)
    Î¨ âŠ¢ X ~ â˜…

    ---------
    Î¨ âŠ¢ â˜… ~ Î¹

    ---------
    Î¨ âŠ¢ Î¹ ~ â˜…

    Î¨ âŠ¢ â˜… ~ A   Î¨ âŠ¢ â˜… ~ B
    ----------------------
    Î¨ âŠ¢ â˜… ~ A â†’ B

    Î¨ âŠ¢ A ~ â˜…   Î¨ âŠ¢ B ~ â˜…
    ----------------------
    Î¨ âŠ¢ A â†’ B ~ â˜…

    Î¨, X âŠ¢ A ~ â˜…
    -------------
    Î¨ âŠ¢ âˆ€X.A ~ â˜…

    Î¨, X âŠ¢ â˜… ~ B
    -------------
    Î¨ âŠ¢ â˜… ~ âˆ€X.B

    Î¨ âŠ¢ A ~ Aâ€²  Î¨ âŠ¢ B ~ Bâ€²
    ----------------------
    Î¨ âŠ¢ A â†’ B ~ Aâ€² â†’ Bâ€²
    
    Î¨ âŠ¢ A ~ Aâ€²
    -----------------
    Î¨ âŠ¢ âˆ€X.A ~ âˆ€X.Aâ€²

    Î¨, X âŠ¢ A ~ B
    -------------- (B =Ì¸ âˆ€Y.C, X âˆ‰ B)
    Î¨ âŠ¢ âˆ€X.A ~ B

    Î¨, X âŠ¢ A ~ B
    -------------- (A =Ì¸ âˆ€Y.C, X âˆ‰ A)
    Î¨ âŠ¢ A ~ âˆ€X.B

## Precision

    -------------
    | Î¨ âŠ¢ A âŠ‘ B |
    -------------

    ----------
    Î¨ âŠ¢ Î¹ âŠ‘ Î¹

    ----------
    Î¨ âŠ¢ X âŠ‘ X

    ----------
    Î¨ âŠ¢ â˜… âŠ‘ â˜…

    ---------- (X âˆˆ Î¨)
    Î¨ âŠ¢ â˜… âŠ‘ X

    ---------
    Î¨ âŠ¢ â˜… âŠ‘ Î¹

    Î¨ âŠ¢ â˜… âŠ‘ A   Î¨ âŠ¢ â˜… âŠ‘ B
    ----------------------
    Î¨ âŠ¢ â˜… âŠ‘ A â†’ B

    Î¨ âŠ¢ A âŠ‘ Aâ€²  Î¨ âŠ¢ B âŠ‘ Bâ€²
    ----------------------
    Î¨ âŠ¢ A â†’ B âŠ‘ Aâ€² â†’ Bâ€²
    
    Î¨ âŠ¢ A âŠ‘ Aâ€²
    -----------------
    Î¨ âŠ¢ âˆ€X.A âŠ‘ âˆ€X.Aâ€²

    Î¨, X âŠ¢ A âŠ‘ B
    -------------- (A =Ì¸ âˆ€Y.C, X âˆ‰ A)
    Î¨ âŠ¢ A âŠ‘ âˆ€X.B


## Well-formed Types

TODO

## Type System

    (x:A) âˆˆ Î“
    ---------
    Î“ âŠ¢ x : A

    Î“ âŠ¢ A ok  Î“, x:A âŠ¢ N : B
    ------------------------
    Î“ âŠ¢ Î»x:A.N : A â†’ B

    Î“ âŠ¢ L : A â†’ B     Î“ âŠ¢ M : A
    ---------------------------
    Î“ âŠ¢ L M : B

    Î“ âŠ¢ L : â˜…     Î“ âŠ¢ M : A
    -----------------------
    Î“ âŠ¢ L M : â˜…

    Î“, X âŠ¢ V : B
    ---------------
    Î“ âŠ¢ Î›X.V : âˆ€X.B

    Î“ âŠ¢ L : âˆ€X.A    Î“ âŠ¢ B ok
    ------------------------
    Î“ âŠ¢ L[B] : A[B/X]

    Î“ âŠ¢ L : A    Î“ âŠ¢ B ok
    --------------------- (A â‰  âˆ€X.A' for any A')
    Î“ âŠ¢ L[B] : A

    Î“ âŠ¢ M : Aâ€²   Î“ âŠ¢ A ok
    --------------------- (Aâ€² ~ A)
    Î“ âŠ¢ (M : A) : A
    
## Term Precision

TODO

# Polymorphic Cast Calculus (PCC, Internal Language)

## Syntax

    Types         A, B, C  ::=  Î¹ | X | A â†’ B | âˆ€X.A | â˜…
    Ground Types  G, H     ::=  Î¹ | X | â˜…â†’â˜…
    Terms         L, M, N  ::=  x | Î»x.N | Î›X.V | L M | L[X] | Î½X=A.M
                             | MâŸ¨câŸ© | blame
    Values        V, W     ::= Î»x.N | Î›X.V | VâŸ¨c â†’ dâŸ© | VâŸ¨âˆ€X.câŸ© | VâŸ¨ğ’¢ X.câŸ©
    Coercions     c, d     ::= id | G? | G! | Xâ†“ | Xâ†‘ | c â†’ d | c ; d
                             | âˆ€X.c | ğ’¢ X.c | â„ X.c

    Environments  Î“        ::=  âˆ… | Î“, x:A | Î“, X | Î“, X=A | Î“, X?

## Reductions

    ----------
    | M â€”â†’ N |
    ----------

    (Î»x.N) V              â€”â†’  N[V/x]
    (Î›X.V)[Y]             â€”â†’  V[Y/X]
    VâŸ¨âˆ€X.câŸ©[Y]            â€”â†’  V[Y]âŸ¨c[Y/X]âŸ©
    VâŸ¨ğ’¢ X.câŸ©[Y]           â€”â†’ VâŸ¨c[Y/X]âŸ©
    VâŸ¨â„ X.câŸ©               â€”â†’  Î½X=â˜…. V[X]âŸ¨câŸ©
    VâŸ¨idâŸ©                  â€”â†’  V
    VâŸ¨Xâ†“âŸ©âŸ¨Xâ†‘âŸ©              â€”â†’  V
    VâŸ¨G!âŸ©âŸ¨G?âŸ©              â€”â†’  V
    VâŸ¨G!âŸ©âŸ¨H?lâŸ©             â€”â†’  blame l    (G =Ì¸ H)
    VâŸ¨c â†’ dâŸ© W             â€”â†’  (V WâŸ¨câŸ©)âŸ¨dâŸ©
    VâŸ¨c ; dâŸ©              â€”â†’  VâŸ¨câŸ©âŸ¨dâŸ©

    ------------------
    | Î£ âŠ¢ M â€”â†’ Î£ âŠ¢ N |
    ------------------
    
    M â€”â†’ N
    --------------
    Î£ âŠ¢ M â€”â†’ Î£ âŠ¢ N

    Î£ âŠ¢ M â€”â†’ Î£â€² âŠ¢ N
    ---------------------
    Î£ âŠ¢ F[M] â€”â†’ Î£â€² âŠ¢ F[N]

    ----------------------
    Î£ âŠ¢ Î½X.N â€”â†’  Î£, X âŠ¢ N
    

## Coercion Typing

    -----------------
    | Î“ âŠ¢ c : A â‡’ B |
    -----------------

    Î“ âŠ¢ A
    --------------
    Î“ âŠ¢ id : A â‡’ A

    Î“ âŠ¢ G
    ---------------
    Î“ âŠ¢ G? : â˜… â‡’ G

    Î“ âŠ¢ G
    ---------------
    Î“ âŠ¢ G! : G â‡’ â˜…
        
    --------------- (X=A âˆˆ Î“)
    Î“ âŠ¢ Xâ†“ : A â‡’ X

    --------------- (X=A âˆˆ Î“)
    Î“ âŠ¢ Xâ†‘ : X â‡’ A

    Î“, X âŠ¢ c : A â‡’ B
    ------------------------
    Î“ âŠ¢ ğ’¢ X. c : A â‡’ âˆ€X.B

    Î“, X=â˜… âŠ¢ c : A â‡’ B
    ------------------------
    Î“ âŠ¢ â„ X.c : âˆ€X.A â‡’ B

    Î“, X âŠ¢ c : A â‡’ B
    ------------------------
    Î“ âŠ¢ âˆ€ X.c : âˆ€X.A â‡’ âˆ€X.B

    Î“ âŠ¢ c : C â‡’ A   Î“ âŠ¢ d : B â‡’ D
    ------------------------------
    Î“ âŠ¢ c â†’ d : A â†’ B â‡’ C â†’ D

    Î“ âŠ¢ c : A â‡’ B   Î“ âŠ¢ d : B â‡’ C
    ------------------------------
    Î“ âŠ¢ c ; d : A â‡’ C


## Type System

    -------------
    | Î“ âŠ¢ M : A |
    -------------

    Î“ âŠ¢ M : A   Î“ âŠ¢ c : A â‡’ B
    --------------------------         Cast
    Î“ âŠ¢ MâŸ¨câŸ© : B

    Î“ âŠ¢ L : âˆ€X.A
    -----------------                  Type application
    Î“ âŠ¢ L[X] : A

    Î“, X=A âŠ¢ N : B
    --------------- (X âˆ‰ B)            Generate fresh type variable
    Î“ âŠ¢ Î½X=A.N : B

    x:A âˆˆ Î“
    ---------
    Î“ âŠ¢ x : A

    Î“ âŠ¢ A ok  Î“, x:A âŠ¢ N : B
    ------------------------
    Î“ âŠ¢ Î»x:A.N : A â†’ B

    Î“ âŠ¢ L : A â†’ B     Î“ âŠ¢ M : A
    ---------------------------
    Î“ âŠ¢ L M : B

    Î“, X âŠ¢ V : B
    ---------------
    Î“ âŠ¢ Î›X.V : âˆ€X.B


## Configuration Typing

    ---------
    | Î“ âŠ¢ Î£ |
    ---------

    ------
    âˆ… âŠ¢ âˆ…

    -------------
    Î“, X=A âŠ¢ Î£, X

    -------------
    | Î£ âŠ¢ M : A |
    -------------

    Î“ âŠ¢ Î£   Î“ âŠ¢ M : A
    -----------------
    Î£ âŠ¢ M : A

## Term Precision (for the Gradual Guarantee)

TODO

# Compilation From PGL to PCC

## Compilation of Conversions

    ----------------------
    | ğ’âŸ¦ Î“ âŠ¢ A â‡’ B âŸ§ = c |
    ----------------------
    
    ğ’âŸ¦ Î“ âŠ¢ Î¹ â‡’ Î¹ âŸ§        = id
    ğ’âŸ¦ Î“ âŠ¢ â˜… â‡’ â˜… âŸ§       = id
    ğ’âŸ¦ Î“ âŠ¢ X â‡’ X âŸ§       = id
    ğ’âŸ¦ Î“ âŠ¢ G â‡’ â˜… âŸ§       = G!    if G â‰  X or G? âˆˆ Î“
    ğ’âŸ¦ Î“ âŠ¢ â˜… â‡’ G âŸ§       = G?    if G â‰  X or G? âˆˆ Î“
    ğ’âŸ¦ Î“ âŠ¢ (A â†’ B) â‡’ â˜… âŸ§ = (c â†’ d) ; â˜…â†’â˜…!
       where
       ğ’âŸ¦ Î“ âŠ¢ â˜… â‡’ A âŸ§ = c
       ğ’âŸ¦ Î“ âŠ¢ B â‡’ â˜… âŸ§ = d
    ğ’âŸ¦ Î“ âŠ¢ â˜… â‡’ (A â†’ B) âŸ§ = â˜…â†’â˜…? ; (c â†’ d)     (A =Ì¸ â˜…, B =Ì¸ â˜…)
       where
       ğ’âŸ¦ Î“ âŠ¢ A â‡’ â˜… âŸ§ = c
       ğ’âŸ¦ Î“ âŠ¢ â˜… â‡’ B âŸ§ = d
    ğ’âŸ¦ Î“ âŠ¢ A â‡’ X âŸ§ = Xâ†“      if X=A âˆˆ Î“
    ğ’âŸ¦ Î“ âŠ¢ X â‡’ B âŸ§ = Xâ†‘      if X=B âˆˆ Î“
    ğ’âŸ¦ Î“ âŠ¢ (A â†’ B) â‡’ (Aâ€² â†’ Bâ€²) âŸ§ = c â†’ d
       where
       ğ’âŸ¦ Î“ âŠ¢ Aâ€² â‡’ A âŸ§ = c
       ğ’âŸ¦ Î“ âŠ¢ B â‡’ Bâ€² âŸ§ = d
    ğ’âŸ¦ Î“ âŠ¢ A â‡’ âˆ€X.B âŸ§ = ğ’¢ X. c
           where
           ğ’âŸ¦ Î“, X? âŠ¢ A â‡’ B âŸ§ = c
    ğ’âŸ¦ Î“ âŠ¢ âˆ€X.A â‡’ B âŸ§ = â„ X. c
           where
           ğ’âŸ¦ Î“, X=â˜… âŠ¢ A â‡’ B âŸ§ = c
    ğ’âŸ¦ Î“ âŠ¢ âˆ€X.A â‡’ âˆ€X.B âŸ§ = âˆ€X.c
           where
           ğ’âŸ¦ Î“, X âŠ¢ A â‡’ B âŸ§ = c

## Compilation of Terms

    -----------------------
    | ğ’âŸ¦ Î“ âŠ¢ M : A âŸ§ = Mâ€² |
    -----------------------

    ğ’âŸ¦ Î“ âŠ¢ x : A âŸ§          = x

    ğ’âŸ¦ Î“ âŠ¢ Î»x:A.N : A â†’ B âŸ§ = Î»x.Nâ€²
       where
       ğ’âŸ¦ Î“,x:A âŠ¢ N : B âŸ§   = Nâ€²

    ğ’âŸ¦ Î“ âŠ¢ L M : BâŸ§         = Lâ€²  Mâ€²âŸ¨câŸ©
       where
       ğ’âŸ¦ Î“ âŠ¢ L : A â†’ BâŸ§ = Lâ€²
       ğ’âŸ¦ Î“ âŠ¢ M : Aâ€² âŸ§   = Mâ€²
       ğ’âŸ¦ Aâ€² â‡’ A âŸ§       = c

    ğ’âŸ¦ Î“ âŠ¢ L M : â˜…âŸ§         = Lâ€²âŸ¨câŸ©  Mâ€²âŸ¨dâŸ©
       where
       ğ’âŸ¦ Î“ âŠ¢ L : â˜…âŸ§   = Lâ€²
       ğ’âŸ¦ Î“ âŠ¢ M : A âŸ§  = Mâ€²
       ğ’âŸ¦ â˜… â‡’ â˜… â†’ â˜… âŸ§ = c
       ğ’âŸ¦ A â‡’ â˜… âŸ§      = d

    ğ’âŸ¦ Î“ âŠ¢ L[B] : A[B/X] âŸ§ = Î½X=B. Lâ€²[X] âŸ¨câŸ©
       where
       ğ’âŸ¦ Î“ âŠ¢ L : âˆ€X.A âŸ§ = Lâ€²
       ğ’âŸ¦ A â‡’ A[B/X] âŸ§ = c

    ğ’âŸ¦ Î“ âŠ¢ L[B] : A âŸ§ = Î½X=B. Lâ€²âŸ¨câŸ©[X]
       where
       ğ’âŸ¦ Î“ âŠ¢ L : A âŸ§ = Lâ€²
           ğ’âŸ¦ A â‡’ âˆ€X.A âŸ§ = c
