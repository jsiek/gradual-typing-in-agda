================================================================================

Local Type Inference for Impredicative Polymorphism

Not so sure this makes sense... 

The thought was to replace subtyping with precision and consistency in
the setting of a statically but partially typed polymorphic calculus.

# Syntax

    A,B,C,D,E ::= Î± | A â†’ B | Aâ‚’ Ã— â‹¯ Ã— Aâ‚– | âˆ€Î±.A
    L,M,N     ::= x | Î»x.N | L M | M : A | (Mâ‚’, ..., Mâ‚–) | M[n]

# Precision

    -------------
    | Î¨ âŠ¢ A âŠ‘ B | 
    -------------

    ---------- (Î± âˆˆ Î¨)
    Î¨ âŠ¢ Î± âŠ‘ Î±

    Î¨ âŠ¢ A âŠ‘ C  Î¨ âŠ¢ B âŠ‘ D
    ---------------------
    Î¨ âŠ¢ A â†’ B âŠ‘ C â†’ D

    all k âˆˆ 0...n, Î¨ âŠ¢ Aâ‚– âŠ‘ Bâ‚–
    -------------------------------
    Î¨ âŠ¢ Aâ‚’ Ã— â‹¯ Ã— Aâ‚™ âŠ‘ Bâ‚’ Ã— â‹¯ Ã— Bâ‚™

    Î¨, Î± âŠ¢ A âŠ‘ B
    -----------------
    Î¨ âŠ¢ âˆ€Î±.A âŠ‘ âˆ€Î±. B

    Î¨ âŠ¢ A âŠ‘ B[Î±:=C]
    ----------------
    Î¨ âŠ¢ A âŠ‘ âˆ€Î±. B

# Consistency

    âˆ… âŠ¢ A âŠ‘ C   âˆ… âŠ¢ B âŠ‘ C
    ----------------------
            A âˆ¼ B

# Type System

    Î“ âŠ¢ L : âˆ€Î±â‚’.â‹¯âˆ€Î±â‚™.A â†’ C   Î“ âŠ¢ M : B
	A[Î±â‚’:=Dâ‚’]â‹¯[Î±â‚™:=Dâ‚™] âˆ¼ B
	âˆ€Eâ‚’â‹¯Eâ‚™. A[Î±â‚’:=Eâ‚’]â‹¯[Î±â‚™:=Eâ‚™] âˆ¼ B implies (for kâˆˆ0...n, Eâ‚– âŠ‘ Dâ‚–)
	---------------------------------------------------------------
    Î“ âŠ¢ L M : C[Î±â‚’:=Dâ‚’]â‹¯[Î±â‚™:=Dâ‚™]

# Constraint Generation

    ------------------
    | Î¨ âŠ¢ A âˆ¼ B â‡’ ğ’ |
	------------------

    Î± âˆ‰ Î¨
    ---------------
    Î¨ âŠ¢ Î± ~ Î± â‡’ âˆ…

    Î± âˆˆ Î¨
    ----------------------
    Î¨ âŠ¢ Î± ~ B â‡’ { Î± ~ B }

    Î¨ âŠ¢ Aâ‚ ~ Bâ‚ â‡’ ğ’â‚   Î¨ âŠ¢ Aâ‚‚ ~ Bâ‚‚ â‡’ ğ’â‚‚
    -------------------------------------
    Î¨ âŠ¢ Aâ‚ â†’ Aâ‚‚ ~ Bâ‚ â†’ Bâ‚‚ â‡’ ğ’â‚ âˆª ğ’â‚‚


    Î¨ âŠ¢ âˆ€Î±.A ~ âˆ€Î±.B


================================================================================

Consistency

        ------------
        id_A : A ~ A

        p : A ~ G
        ----------------
        tag_G(p) : A ~ â˜…

        p : A ~ G
        ------------------
        untag_G(p) : â˜… ~ A

        p : A ~ Aâ€²    q : B ~ Bâ€²
        ------------------------
        pâ†’q : Aâ†’B ~ Aâ€²â†’Bâ€²

        p[X] : A[X] ~ B[X]
        -----------------------------
        âˆ€X.p[X] : âˆ€X.A[X] ~ âˆ€X.B[X]
		
        p[Î±] : A[Î±] ~ B
        ------------------------- (Î± âˆ‰ B, â˜… âˆˆ B)
        Î½á´¸Î±.p[Î±] : âˆ€X.A[X] ~ B

        p[Î±] : B ~ A[Î±]
        ------------------------- (Î± âˆ‰ B, â˜… âˆˆ B)
        Î½á´¿Î±.p[Î±] : B ~ âˆ€X.A[X]


Lemma

  If A ~ B then C âŠ‘ A and C âŠ‘ B for some C.
  If C âŠ‘ A and C âŠ‘ B then A ~ B.




   Î“ âŠ¢ L : â˜…
   Î“ âŠ¢ A
   ------------
   Î“ âŠ¢ L A : â˜…

   Î“ âŠ¢ L â† Lâ€² : â˜…
   Î“ âŠ¢ A
   -------------------------------
   Î“ âŠ¢ L A â†   Lâ€²âŸ¨â˜… â‡’ âˆ€X.â˜…âŸ© A : â˜…
   

   Î“ âŠ¢ L A â†   Lâ€²âŸ¨Î½Î±.id_â˜…âŸ© A : â˜…
      where  Î½Î±.id_â˜… : â˜… âŠ‘ âˆ€X.â˜…       (except that Î± âˆ‰ â˜…[Î±])

   example:  int â†’ int â‡’ âˆ€X.int â†’ int  (Igarashi paper)
   Peter: should we use the side condition of Igarashi et al.?

Surface Language
    
    Type Variables X,Y,Z
    Types          A,B    ::=  X | Î¹ | Aâ†’B | âˆ€X.B | â˜…
    Term Variables x,y,z
    Terms          L,M,N  ::=  x | Î»x:A.N | L M | Î›X.V | L[A]
    Values        V,W    ::=  x | Î»x:A.N | Î›X.V

Precision

    Constraint     C ::=  A âŠ‘ B
    Contraint Set  ğ’

    -------------
    | ğ’ âŠ¢ A âŠ‘ B |
    -------------

    X âŠ‘ Y âˆˆ ğ’
    ----------
    ğ’ âŠ¢ X âŠ‘ Y

    â˜… âŠ‘ Y âˆˆ ğ’
    ---------- (Y â‰  âˆ€Z.B)
    ğ’ âŠ¢ â˜… âŠ‘ Y
    
    ğ’, X âŠ‘ Y âŠ¢ A âŠ‘ B
    -----------------
    ğ’ âŠ¢ âˆ€X.A âŠ‘ âˆ€Y.B

    ğ’, â˜… âŠ‘ Y âŠ¢ A âŠ‘ B
    ------------------ (Y âˆˆ B)
    ğ’ âŠ¢ A âŠ‘ âˆ€Y.B

    ---------
    ğ’ âŠ¢ Î¹ âŠ‘ Î¹

    ğ’ âŠ¢ A âŠ‘ Aâ€²   ğ’ âŠ¢ B âŠ‘ Bâ€²
    ------------------------
    ğ’ âŠ¢ Aâ†’B âŠ‘ Aâ€²â†’Bâ€²

    ----------
    ğ’ âŠ¢ â˜… âŠ‘ Î¹

    ğ’ âŠ¢ â˜… âŠ‘ Aâ€²   ğ’ âŠ¢ â˜… âŠ‘ Bâ€²
    ------------------------
    ğ’ âŠ¢ â˜… âŠ‘ Aâ€²â†’Bâ€²

Consistency

    Constraint     C ::=  A ~ B
    Contraint Set  ğ’

    -------------
    | ğ’ âŠ¢ A ~ B |
    -------------

    X ~ Y âˆˆ ğ’
    ----------
    ğ’ âŠ¢ X ~ Y

    â˜… ~ Y âˆˆ ğ’
    ----------
    ğ’ âŠ¢ â˜… ~ Y

    X ~ â˜… âˆˆ ğ’
    ----------
    ğ’ âŠ¢ X ~ â˜…

    ğ’, X ~ Y âŠ¢ A ~ B
    ----------------- (X âˆ‰ ğ’, Y âˆ‰ ğ’)
    ğ’ âŠ¢ âˆ€X.A ~ âˆ€Y.B

    ğ’, â˜… ~ Y âŠ¢ A ~ B
    ----------------- (Y âˆ‰ ğ’, Y âˆˆ B)
    ğ’ âŠ¢ A ~ âˆ€Y.B

    ğ’, X ~ â˜… âŠ¢ A ~ B
    ----------------- (X âˆ‰ ğ’, X âˆˆ A)
    ğ’ âŠ¢ âˆ€X.A ~ B

    ---------
    ğ’ âŠ¢ Î¹ ~ Î¹

    ğ’ âŠ¢ A ~ Aâ€²   ğ’ âŠ¢ B ~ Bâ€²
    ------------------------
    ğ’ âŠ¢ Aâ†’B ~ Aâ€²â†’Bâ€²

    ----------
    ğ’ âŠ¢ â˜… ~ Î¹

    ----------
    ğ’ âŠ¢ Î¹ ~ â˜…

    ğ’ âŠ¢ â˜… ~ Aâ€²   ğ’ âŠ¢ â˜… ~ Bâ€²
    ------------------------
    ğ’ âŠ¢ â˜… ~ Aâ€²â†’Bâ€²

    ğ’ âŠ¢ A ~ â˜…   ğ’ âŠ¢ B ~ â˜…
    -----------------------
    ğ’ âŠ¢ Aâ†’B ~ â˜…

Type System

    Type Environments   Î“      ::=  âˆ… | Î“, x:A | Î“, X | Î“, Î±=A

    -------------
    | Î“ âŠ¢ M : A |
    -------------
	
    x:A âˆˆ Î“
    ----------
    Î“ âŠ¢ x : A

    Î“, x:A âŠ¢ N : B
    ------------------
    Î“ âŠ¢ Î»x:A.N : A â†’ B

    Î“ âŠ¢ L : A â†’ B    Î“ âŠ¢ M : Aâ€²   A ~ Aâ€²
    ------------------------------------
    Î“ âŠ¢ L M : B

    Î“ âŠ¢ L : â˜…   Î“ âŠ¢ M : A
    ----------------------
    Î“ âŠ¢ L M : â˜…

    Î“, X âŠ¢ V : B
    ---------------
    Î“ âŠ¢ Î›X.V : âˆ€X.B

    Î“ âŠ¢ L : âˆ€X.B    Î“ âŠ¢ A
    ----------------------
    Î“ âŠ¢ L[A] : B[A/X]

    Î“ âŠ¢ L : â˜…    Î“ âŠ¢ A
    -------------------
    Î“ âŠ¢ L[A] : â˜…


Polymorphic Cast Calculus

    Terms             ::= x | Î»x.N | L M | Î›X.V | L[Î±] | M!G | M?G
	                    | Î½Î±=A.M | Mâ†“Î± | Mâ†‘Î±
	Ground Types  G,H ::= Î¹ | â˜…â†’â˜…

Compilation of Casts

    ----------------
    | âŸ¨A â‡’ BâŸ© = Mâ€² |  (pre: A ~ B)
    ----------------
    
    âŸ¨G â‡’ â˜…âŸ© = (Î»x. x!G)
    âŸ¨â˜… â‡’ HâŸ© = (Î»x. x?H)
    âŸ¨A â‡’ â˜…âŸ© = (Î»x. (âŸ¨A â‡’ GâŸ© x) !G)    (A not ground, not poly)
    âŸ¨â˜… â‡’ BâŸ© = (Î»x. âŸ¨H â‡’ BâŸ© (x ?H))    (B not ground, not poly)
	âŸ¨Aâ†’B â‡’ Aâ€²â†’Bâ€²âŸ© = (Î»f.Î»x. âŸ¨B â‡’ Bâ€²âŸ© (f (âŸ¨Aâ€² â‡’ AâŸ© x))    (f:Aâ†’B, x:Aâ€²)
	âŸ¨âˆ€X.A â‡’ âˆ€X.BâŸ© = Î»p. Î›X. Î½Î±=X. âŸ¨A[Î±/X] â‡’ B[Î±/X]âŸ© p[Î±] (p:âˆ€X.A)
	
    âŸ¨âˆ€X.A â‡’ BâŸ© = Î»p. âŸ¨A[â˜…/X] â‡’ BâŸ© p[â˜…]
	âŸ¨A â‡’ âˆ€Y.BâŸ© = 


Compilation of Terms to Cast Calculus

    ------------------
    | Î“ âŠ¢ M â† Mâ€² : A |
    ------------------

    x:A âˆˆ Î“
    --------------
    Î“ âŠ¢ x â† x : A

    Î“, x:A âŠ¢ N â† Nâ€² : B
    ---------------------------
    Î“ âŠ¢ Î»x:A.N â† Î»x.Nâ€² : A â†’ B

    Î“ âŠ¢ L â† Lâ€² : A â†’ B    Î“ âŠ¢ M â† Mâ€² : Aâ€²   Aâ€² ~ A
    -----------------------------------------------
    Î“ âŠ¢ L M â† Lâ€² MâŸ¨Aâ€²â‡’AâŸ© : B

    Î“ âŠ¢ L â† Lâ€² : â˜…   Î“ âŠ¢ M â† Mâ€² : Aâ€²
    -----------------------------------
    Î“ âŠ¢ L M â† Lâ€²âŸ¨â˜…â‡’â˜…â†’â˜…âŸ© Mâ€²âŸ¨Aâ€²â‡’â˜…âŸ© : â˜…

    Î“, X âŠ¢ V â† Vâ€² : B
    ------------------------
    Î“ âŠ¢ Î›X.V â† Î›X.Vâ€² : âˆ€X.B

    Î“ âŠ¢ L â† Lâ€² : âˆ€X.B    Î“ âŠ¢ A
    ---------------------------
    Î“ âŠ¢ L[A] â† Lâ€²[A] : B[A/X]

    Î“ âŠ¢ L â† Lâ€² : â˜…    Î“ âŠ¢ A
    ------------------------------
    Î“ âŠ¢ L[A] â† Lâ€²âŸ¨â˜…â‡’âˆ€X.â˜…âŸ©[A] : â˜…
   
